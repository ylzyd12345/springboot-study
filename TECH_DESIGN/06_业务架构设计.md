# Spring4demo ä¸šåŠ¡æ¶æ„è®¾è®¡

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **æ–‡æ¡£åç§°** | Spring4demo ä¸šåŠ¡æ¶æ„è®¾è®¡ |
| **ç‰ˆæœ¬å·** | v1.0.0 |
| **åˆ›å»ºæ—¥æœŸ** | 2025-12-24 |
| **ä½œè€…** | ä¸šåŠ¡æ¶æ„å¸ˆ |
| **å®¡æ ¸äºº** | äº§å“ç»ç† |
| **æ‰¹å‡†äºº** | ä¸šåŠ¡æ€»ç›‘ |

## ğŸ¯ ä¸šåŠ¡æ¶æ„æ¦‚è¿°

Spring4demoä¼ä¸šçº§æ™ºèƒ½ç®¡ç†å¹³å°çš„ä¸šåŠ¡æ¶æ„åŸºäºé¢†åŸŸé©±åŠ¨è®¾è®¡(DDD)ç†å¿µï¼Œé‡‡ç”¨é™ç•Œä¸Šä¸‹æ–‡åˆ’åˆ†ä¸šåŠ¡é¢†åŸŸï¼Œé€šè¿‡èšåˆæ ¹ä¿è¯ä¸šåŠ¡ä¸€è‡´æ€§ï¼Œä»¥é¢†åŸŸäº‹ä»¶é©±åŠ¨ä¸šåŠ¡æµç¨‹ã€‚æ•´ä¸ªæ¶æ„æ”¯æŒä»å•ä½“å‘å¾®æœåŠ¡çš„å¹³æ»‘æ¼”è¿›ã€‚

## ğŸ—ï¸ ä¸šåŠ¡é¢†åŸŸåˆ’åˆ†

### 1. æ ¸å¿ƒä¸šåŠ¡åŸŸ (Core Business Domains)

#### 1.1 ç”¨æˆ·æƒé™åŸŸ (User & Permission Domain)

**é¢†åŸŸèŒè´£**: è´Ÿè´£ç”¨æˆ·èº«ä»½ç®¡ç†ã€æƒé™æ§åˆ¶ã€ç»„ç»‡æ¶æ„ç®¡ç†

**æ ¸å¿ƒä¸šåŠ¡èƒ½åŠ›**:
- ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€æ³¨é”€
- å¤šå› å­è®¤è¯(MFA)
- åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)
- ç»„ç»‡æ¶æ„å±‚çº§ç®¡ç†
- å•ç‚¹ç™»å½•(SSO)
- å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»

**é™ç•Œä¸Šä¸‹æ–‡è¾¹ç•Œ**:
```java
// ç”¨æˆ·æƒé™åŸŸçš„åŒ…ç»“æ„
com.kev1n.spring4demo.core.domain.user
â”œâ”€â”€ entity/              // å®ä½“
â”‚   â”œâ”€â”€ User.java
â”‚   â”œâ”€â”€ Role.java
â”‚   â””â”€â”€ Permission.java
â”œâ”€â”€ valueobject/         // å€¼å¯¹è±¡
â”‚   â”œâ”€â”€ UserProfile.java
â”‚   â”œâ”€â”€ UserStatus.java
â”‚   â””â”€â”€ ContactInfo.java
â”œâ”€â”€ aggregate/           // èšåˆæ ¹
â”‚   â””â”€â”€ UserAggregate.java
â”œâ”€â”€ repository/          // ä»“å‚¨æ¥å£
â”‚   â”œâ”€â”€ UserRepository.java
â”‚   â””â”€â”€ RoleRepository.java
â”œâ”€â”€ service/             // é¢†åŸŸæœåŠ¡
â”‚   â”œâ”€â”€ UserDomainService.java
â”‚   â””â”€â”€ AuthService.java
â””â”€â”€ event/               // é¢†åŸŸäº‹ä»¶
    â”œâ”€â”€ UserCreatedEvent.java
    â”œâ”€â”€ UserUpdatedEvent.java
    â””â”€â”€ UserDeletedEvent.java
```

**èšåˆæ ¹è®¾è®¡**:
```java
@Entity
@Table(name = "users")
@AggregateRoot
public class User extends BaseEntity {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(unique = true, nullable = false, length = 50)
    private String username;
    
    @Column(unique = true, nullable = false, length = 100)
    private String email;
    
    @Column(nullable = false)
    private String password;
    
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private UserStatus status;
    
    @Embedded
    private UserProfile profile;
    
    @OneToMany(mappedBy = "user", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private Set<UserRole> userRoles = new HashSet<>();
    
    // é¢†åŸŸæ–¹æ³•
    public static User create(String username, String email, String password) {
        User user = new User();
        user.username = username;
        user.email = email;
        user.password = password;
        user.status = UserStatus.ACTIVE;
        user.profile = new UserProfile();
        
        // å‘å¸ƒé¢†åŸŸäº‹ä»¶
        DomainEventPublisher.publish(new UserCreatedEvent(user.id));
        
        return user;
    }
    
    public void activate() {
        if (this.status == UserStatus.INACTIVE) {
            this.status = UserStatus.ACTIVE;
            DomainEventPublisher.publish(new UserActivatedEvent(this.id));
        }
    }
    
    public void assignRole(Role role) {
        UserRole userRole = new UserRole(this, role);
        this.userRoles.add(userRole);
        DomainEventPublisher.publish(new UserRoleAssignedEvent(this.id, role.getId()));
    }
}
```

#### 1.2 å†…å®¹ç®¡ç†åŸŸ (Content Management Domain)

**é¢†åŸŸèŒè´£**: ä¼ä¸šçº§å†…å®¹ç®¡ç†ã€æ–‡æ¡£å¤„ç†ã€çŸ¥è¯†åº“ç®¡ç†

**æ ¸å¿ƒä¸šåŠ¡èƒ½åŠ›**:
- æ–‡æ¡£åˆ›å»ºã€ç¼–è¾‘ã€ç‰ˆæœ¬æ§åˆ¶
- åˆ†ç±»ç®¡ç†å’Œæ ‡ç­¾ç³»ç»Ÿ
- å…¨æ–‡æœç´¢å’Œå†…å®¹æ¨è
- å·¥ä½œæµå®¡æ ¸å’Œå†…å®¹åˆè§„
- å¤šåª’ä½“æ–‡ä»¶å¤„ç†å’Œè½¬æ¢
- å†…å®¹æƒé™å’Œè®¿é—®æ§åˆ¶

**èšåˆè®¾è®¡**:
```java
@Entity
@Table(name = "documents")
@AggregateRoot
public class Document extends BaseEntity {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false, length = 255)
    private String title;
    
    @Column(columnDefinition = "LONGTEXT")
    private String content;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "category_id")
    private Category category;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "author_id")
    private User author;
    
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private DocumentStatus status;
    
    @Column(name = "version", nullable = false)
    private Integer version = 1;
    
    @ManyToMany
    @JoinTable(
        name = "document_tags",
        joinColumns = @JoinColumn(name = "document_id"),
        inverseJoinColumns = @JoinColumn(name = "tag_id")
    )
    private Set<Tag> tags = new HashSet<>();
    
    // é¢†åŸŸæ–¹æ³•
    public static Document create(String title, String content, User author, Category category) {
        Document document = new Document();
        document.title = title;
        document.content = content;
        document.author = author;
        document.category = category;
        document.status = DocumentStatus.DRAFT;
        document.version = 1;
        
        DomainEventPublisher.publish(new DocumentCreatedEvent(document.id));
        
        return document;
    }
    
    public void publish() {
        if (this.status == DocumentStatus.DRAFT) {
            this.status = DocumentStatus.PUBLISHED;
            this.publishedAt = LocalDateTime.now();
            DomainEventPublisher.publish(new DocumentPublishedEvent(this.id));
        }
    }
    
    public void updateContent(String newContent, User updatedBy) {
        this.content = newContent;
        this.version++;
        this.updatedBy = updatedBy.getId();
        this.updatedAt = LocalDateTime.now();
        
        DomainEventPublisher.publish(new DocumentUpdatedEvent(this.id, this.version));
    }
}
```

#### 1.3 å·¥ä½œæµå¼•æ“åŸŸ (Workflow Engine Domain)

**é¢†åŸŸèŒè´£**: ä¸šåŠ¡æµç¨‹ç®¡ç†ã€ä»»åŠ¡åˆ†é…ã€å®¡æ‰¹æµè½¬

**æ ¸å¿ƒä¸šåŠ¡èƒ½åŠ›**:
- å¯è§†åŒ–æµç¨‹è®¾è®¡å™¨
- æµç¨‹å®šä¹‰å’Œç‰ˆæœ¬ç®¡ç†
- ä»»åŠ¡åˆ†é…å’ŒçŠ¶æ€è·Ÿè¸ª
- å¤šçº§å®¡æ‰¹å’Œå¹¶è¡Œå®¡æ‰¹
- æµç¨‹ç›‘æ§å’Œæ€§èƒ½åˆ†æ
- æ¡ä»¶è·¯ç”±å’ŒåŠ¨æ€ä»»åŠ¡

**BPMNæµç¨‹é›†æˆ**:
```java
@Service
@Transactional
public class WorkflowDomainService {
    
    @Autowired
    private ProcessEngine processEngine;
    
    @Autowired
    private ProcessRepository processRepository;
    
    @Autowired
    private TaskRepository taskRepository;
    
    /**
     * å¯åŠ¨æµç¨‹å®ä¾‹
     */
    public ProcessInstance startProcess(String processDefinitionKey, String businessKey, 
                                      Map<String, Object> variables, String startedBy) {
        // 1. éªŒè¯æµç¨‹å®šä¹‰
        ProcessDefinition processDefinition = processEngine.getRepositoryService()
            .createProcessDefinitionQuery()
            .processDefinitionKey(processDefinitionKey)
            .latestVersion()
            .singleResult();
        
        if (processDefinition == null) {
            throw new ProcessDefinitionNotFoundException("Process definition not found: " + processDefinitionKey);
        }
        
        // 2. å¯åŠ¨æµç¨‹å®ä¾‹
        ProcessInstance processInstance = processEngine.getRuntimeService()
            .startProcessInstanceByKey(processDefinitionKey, businessKey, variables);
        
        // 3. ä¿å­˜æµç¨‹å®ä¾‹åˆ°æ•°æ®åº“
        ProcessEntity processEntity = ProcessEntity.builder()
            .processInstanceId(processInstance.getId())
            .processDefinitionKey(processDefinitionKey)
            .businessKey(businessKey)
            .status(ProcessStatus.RUNNING)
            .startedBy(startedBy)
            .startTime(LocalDateTime.now())
            .variables(variables)
            .build();
        
        processRepository.save(processEntity);
        
        // 4. å‘å¸ƒé¢†åŸŸäº‹ä»¶
        DomainEventPublisher.publish(new ProcessStartedEvent(processInstance.getId(), startedBy));
        
        return processInstance;
    }
    
    /**
     * å®Œæˆä»»åŠ¡
     */
    public void completeTask(String taskId, String assignee, Map<String, Object> variables) {
        // 1. è·å–ä»»åŠ¡
        Task task = processEngine.getTaskService()
            .createTaskQuery()
            .taskId(taskId)
            .taskAssignee(assignee)
            .singleResult();
        
        if (task == null) {
            throw new TaskNotFoundException("Task not found or not assigned to user: " + taskId);
        }
        
        // 2. å®Œæˆä»»åŠ¡
        processEngine.getTaskService().complete(taskId, variables);
        
        // 3. æ›´æ–°ä»»åŠ¡çŠ¶æ€
        TaskEntity taskEntity = taskRepository.findByTaskId(taskId)
            .orElseThrow(() -> new TaskNotFoundException("Task entity not found: " + taskId));
        
        taskEntity.setStatus(TaskStatus.COMPLETED);
        taskEntity.setCompletionTime(LocalDateTime.now());
        taskEntity.setVariables(variables);
        taskRepository.save(taskEntity);
        
        // 4. å‘å¸ƒé¢†åŸŸäº‹ä»¶
        DomainEventPublisher.publish(new TaskCompletedEvent(taskId, assignee));
    }
}
```

### 2. æ”¯æ’‘ä¸šåŠ¡åŸŸ (Supporting Business Domains)

#### 2.1 æ¶ˆæ¯é€šçŸ¥åŸŸ (Notification Domain)

**é¢†åŸŸèŒè´£**: ç»Ÿä¸€æ¶ˆæ¯é€šçŸ¥ã€å¤šæ¸ é“æ¨é€ã€é€šçŸ¥æ¨¡æ¿ç®¡ç†

**æ ¸å¿ƒå®ç°**:
```java
@Service
@Transactional
public class NotificationDomainService {
    
    @Autowired
    private NotificationRepository notificationRepository;
    
    @Autowired
    private EmailService emailService;
    
    @Autowired
    private SmsService smsService;
    
    @Autowired
    private WebSocketService webSocketService;
    
    /**
     * å‘é€é€šçŸ¥
     */
    public void sendNotification(NotificationCommand command) {
        // 1. åˆ›å»ºé€šçŸ¥å®ä½“
        Notification notification = Notification.create(
            command.getRecipientId(),
            command.getType(),
            command.getTitle(),
            command.getContent(),
            command.getChannels()
        );
        
        // 2. ä¿å­˜é€šçŸ¥
        notificationRepository.save(notification);
        
        // 3. æ ¹æ®æ¸ é“å‘é€é€šçŸ¥
        for (NotificationChannel channel : command.getChannels()) {
            switch (channel) {
                case EMAIL:
                    sendEmailNotification(notification);
                    break;
                case SMS:
                    sendSmsNotification(notification);
                    break;
                case WEBSOCKET:
                    sendWebSocketNotification(notification);
                    break;
                case IN_APP:
                    sendInAppNotification(notification);
                    break;
            }
        }
        
        // 4. å‘å¸ƒäº‹ä»¶
        DomainEventPublisher.publish(new NotificationSentEvent(notification.getId()));
    }
    
    private void sendEmailNotification(Notification notification) {
        EmailRequest emailRequest = EmailRequest.builder()
            .to(notification.getRecipientEmail())
            .subject(notification.getTitle())
            .content(notification.getContent())
            .template(notification.getTemplate())
            .build();
        
        emailService.send(emailRequest);
    }
    
    private void sendWebSocketNotification(Notification notification) {
        WebSocketMessage message = WebSocketMessage.builder()
            .type("NOTIFICATION")
            .userId(notification.getRecipientId())
            .data(NotificationMapper.toDTO(notification))
            .build();
        
        webSocketService.sendToUser(notification.getRecipientId(), message);
    }
}
```

#### 2.2 æ–‡ä»¶ç®¡ç†åŸŸ (File Management Domain)

**é¢†åŸŸèŒè´£**: æ–‡ä»¶å­˜å‚¨ã€ç‰ˆæœ¬æ§åˆ¶ã€æƒé™ç®¡ç†ã€æ ¼å¼è½¬æ¢

**åˆ†å¸ƒå¼å­˜å‚¨å®ç°**:
```java
@Service
@Transactional
public class FileManagementDomainService {
    
    @Autowired
    private FileRepository fileRepository;
    
    @Autowired
    private StorageService storageService;
    
    @Autowired
    private ImageProcessingService imageProcessingService;
    
    /**
     * ä¸Šä¼ æ–‡ä»¶
     */
    public FileEntity uploadFile(UploadFileCommand command) {
        // 1. éªŒè¯æ–‡ä»¶
        validateFile(command.getFile());
        
        // 2. ç”Ÿæˆæ–‡ä»¶è·¯å¾„å’Œåç§°
        String filePath = generateFilePath(command.getCategory(), command.getFile().getOriginalFilename());
        String fileKey = generateFileKey(filePath);
        
        // 3. ä¸Šä¼ åˆ°å­˜å‚¨æœåŠ¡
        StorageResult storageResult = storageService.upload(fileKey, command.getFile());
        
        // 4. å¤„ç†å›¾ç‰‡ç¼©ç•¥å›¾
        String thumbnailUrl = null;
        if (isImageFile(command.getFile())) {
            thumbnailUrl = generateThumbnail(command.getFile(), fileKey);
        }
        
        // 5. åˆ›å»ºæ–‡ä»¶å®ä½“
        FileEntity fileEntity = FileEntity.builder()
            .originalName(command.getFile().getOriginalFilename())
            .storagePath(storageResult.getPath())
            .fileSize(command.getFile().getSize())
            .mimeType(command.getFile().getContentType())
            .category(command.getCategory())
            .uploadedBy(command.getUploadedBy())
            .thumbnailUrl(thumbnailUrl)
            .status(FileStatus.ACTIVE)
            .build();
        
        fileRepository.save(fileEntity);
        
        // 6. å‘å¸ƒäº‹ä»¶
        DomainEventPublisher.publish(new FileUploadedEvent(fileEntity.getId()));
        
        return fileEntity;
    }
    
    private String generateFilePath(String category, String originalFilename) {
        String datePath = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyy/MM/dd"));
        String fileExtension = getFileExtension(originalFilename);
        String uuid = UUID.randomUUID().toString();
        
        return String.format("%s/%s/%s%s", category, datePath, uuid, fileExtension);
    }
    
    private String generateThumbnail(MultipartFile file, String originalFileKey) {
        try {
            // ç”Ÿæˆç¼©ç•¥å›¾
            BufferedImage thumbnail = imageProcessingService.generateThumbnail(
                file.getInputStream(), 200, 200);
            
            // ä¸Šä¼ ç¼©ç•¥å›¾
            String thumbnailKey = "thumbnails/" + originalFileKey;
            ByteArrayOutputStream baos = new ByteArrayOutputStream();
            ImageIO.write(thumbnail, "jpg", baos);
            
            return storageService.upload(thumbnailKey, baos.toByteArray(), "image/jpeg").getPath();
        } catch (Exception e) {
            log.error("Failed to generate thumbnail for file: " + originalFileKey, e);
            return null;
        }
    }
}
```

## ğŸ”„ ä¸šåŠ¡æµç¨‹æ¶æ„

### 1. æ ¸å¿ƒä¸šåŠ¡æµç¨‹è®¾è®¡

#### 1.1 ç”¨æˆ·æ³¨å†Œå’Œè®¤è¯æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant W as Webå‰ç«¯
    participant A as è®¤è¯æœåŠ¡
    participant D as ç”¨æˆ·åŸŸæœåŠ¡
    participant R as Redis
    participant E as é‚®ä»¶æœåŠ¡
    participant DB as æ•°æ®åº“
    
    U->>W: æäº¤æ³¨å†Œä¿¡æ¯
    W->>A: POST /api/v1/auth/register
    A->>D: è°ƒç”¨ç”¨æˆ·åŸŸæœåŠ¡
    D->>DB: æ£€æŸ¥ç”¨æˆ·å/é‚®ç®±å”¯ä¸€æ€§
    DB-->>D: è¿”å›æ£€æŸ¥ç»“æœ
    D->>D: åˆ›å»ºç”¨æˆ·èšåˆ
    D->>DB: ä¿å­˜ç”¨æˆ·
    D->>E: å‘é€éªŒè¯é‚®ä»¶
    D->>R: å­˜å‚¨éªŒè¯ç 
    D-->>A: è¿”å›ç”¨æˆ·ä¿¡æ¯
    A-->>W: è¿”å›æ³¨å†Œç»“æœ
    W-->>U: æ˜¾ç¤ºæ³¨å†ŒæˆåŠŸ
    
    U->>W: ç‚¹å‡»é‚®ä»¶éªŒè¯é“¾æ¥
    W->>A: GET /api/v1/auth/verify?token=xxx
    A->>R: éªŒè¯token
    R-->>A: è¿”å›éªŒè¯ç»“æœ
    A->>D: æ¿€æ´»ç”¨æˆ·
    D->>DB: æ›´æ–°ç”¨æˆ·çŠ¶æ€
    D-->>A: è¿”å›æ¿€æ´»ç»“æœ
    A-->>W: è¿”å›éªŒè¯æˆåŠŸ
    W-->>U: æ˜¾ç¤ºéªŒè¯æˆåŠŸ
```

**å®ç°ä»£ç **:
```java
@Service
@Transactional
public class AuthenticationService {
    
    @Autowired
    private UserDomainService userDomainService;
    
    @Autowired
    private EmailService emailService;
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    /**
     * ç”¨æˆ·æ³¨å†Œ
     */
    public RegisterResult register(RegisterCommand command) {
        // 1. åˆ›å»ºç”¨æˆ·
        CreateUserCommand createUserCommand = CreateUserCommand.builder()
            .username(command.getUsername())
            .email(command.getEmail())
            .password(command.getPassword())
            .firstName(command.getFirstName())
            .lastName(command.getLastName())
            .build();
        
        User user = userDomainService.createUser(createUserCommand);
        
        // 2. ç”ŸæˆéªŒè¯ä»¤ç‰Œ
        String verificationToken = generateVerificationToken(user.getId());
        
        // 3. å‘é€éªŒè¯é‚®ä»¶
        EmailRequest emailRequest = EmailRequest.builder()
            .to(user.getEmail())
            .subject("Verify your email address")
            .template("email-verification")
            .variable("userName", user.getUsername())
            .variable("verificationUrl", buildVerificationUrl(verificationToken))
            .build();
        
        emailService.send(emailRequest);
        
        // 4. è¿”å›æ³¨å†Œç»“æœ
        return RegisterResult.builder()
            .userId(user.getId())
            .username(user.getUsername())
            .email(user.getEmail())
            .status("PENDING_VERIFICATION")
            .message("Registration successful. Please check your email for verification.")
            .build();
    }
    
    /**
     * é‚®ç®±éªŒè¯
     */
    public VerifyResult verifyEmail(String token) {
        // 1. ä»Redisè·å–ç”¨æˆ·ID
        String userId = redisTemplate.opsForValue().get("email_verification:" + token);
        if (userId == null) {
            throw new InvalidTokenException("Invalid or expired verification token");
        }
        
        // 2. æ¿€æ´»ç”¨æˆ·
        userDomainService.activateUser(Long.parseLong(userId));
        
        // 3. åˆ é™¤éªŒè¯ä»¤ç‰Œ
        redisTemplate.delete("email_verification:" + token);
        
        return VerifyResult.builder()
            .status("VERIFIED")
            .message("Email verification successful")
            .build();
    }
    
    private String generateVerificationToken(Long userId) {
        String token = UUID.randomUUID().toString();
        redisTemplate.opsForValue().set(
            "email_verification:" + token, 
            userId.toString(), 
            Duration.ofHours(24)
        );
        return token;
    }
}
```

#### 1.2 æ–‡æ¡£å‘å¸ƒå®¡æ ¸æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant W as Webå‰ç«¯
    participant C as å†…å®¹æœåŠ¡
    participant WFD as å·¥ä½œæµæœåŠ¡
    participant A as å®¡æ ¸æœåŠ¡
    participant N as é€šçŸ¥æœåŠ¡
    participant ES as Elasticsearch
    
    U->>W: åˆ›å»ºæ–‡æ¡£å¹¶æäº¤å‘å¸ƒ
    W->>C: POST /api/v1/documents
    C->>C: åˆ›å»ºæ–‡æ¡£èšåˆ
    C->>WFD: å¯åŠ¨å®¡æ ¸æµç¨‹
    WFD->>WFD: åˆ›å»ºå®¡æ ¸ä»»åŠ¡
    WFD->>N: å‘é€å®¡æ ¸é€šçŸ¥
    WFD-->>C: è¿”å›æµç¨‹å®ä¾‹ID
    C->>ES: æ›´æ–°æœç´¢ç´¢å¼•
    C-->>W: è¿”å›æ–‡æ¡£ä¿¡æ¯
    W-->>U: æ˜¾ç¤ºæäº¤æˆåŠŸ
    
    participant A2 as å®¡æ ¸å‘˜
    A2->>W: æŸ¥çœ‹å¾…å®¡æ ¸æ–‡æ¡£
    W->>C: GET /api/v1/documents/pending
    C->>WFD: æŸ¥è¯¢å®¡æ ¸ä»»åŠ¡
    WFD-->>C: è¿”å›ä»»åŠ¡åˆ—è¡¨
    C-->>W: è¿”å›æ–‡æ¡£åˆ—è¡¨
    W-->>A2: æ˜¾ç¤ºå¾…å®¡æ ¸æ–‡æ¡£
    
    A2->>W: å®¡æ ¸æ–‡æ¡£
    W->>A: POST /api/v1/reviews
    A->>A: éªŒè¯å®¡æ ¸æƒé™
    A->>WFD: å®Œæˆå®¡æ ¸ä»»åŠ¡
    WFD->>WFD: åˆ¤æ–­æµç¨‹èµ°å‘
    WFD->>C: æ›´æ–°æ–‡æ¡£çŠ¶æ€
    WFD->>N: å‘é€å®¡æ ¸ç»“æœé€šçŸ¥
    C->>ES: æ›´æ–°æœç´¢ç´¢å¼•
    C-->>W: è¿”å›å®¡æ ¸ç»“æœ
    W-->>A2: æ˜¾ç¤ºå®¡æ ¸æˆåŠŸ
```

**å·¥ä½œæµé…ç½®**:
```xml
<!-- document-review-process.bpmn20.xml -->
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             targetNamespace="http://spring4demo.com/bpmn">
    
    <process id="documentReviewProcess" name="Document Review Process">
        
        <startEvent id="startEvent"/>
        
        <sequenceFlow sourceRef="startEvent" targetRef="managerReview"/>
        
        <userTask id="managerReview" name="Manager Review">
            <extensionElements>
                <activiti:candidateGroups>MANAGER</activiti:candidateGroups>
            </extensionElements>
        </userTask>
        
        <sequenceFlow sourceRef="managerReview" targetRef="reviewDecision"/>
        
        <exclusiveGateway id="reviewDecision"/>
        
        <sequenceFlow sourceRef="reviewDecision" targetRef="approvedEnd">
            <conditionExpression xsi:type="tFormalExpression">
                ${approved == true}
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow sourceRef="reviewDecision" targetRef="rejectedEnd">
            <conditionExpression xsi:type="tFormalExpression">
                ${approved == false}
            </conditionExpression>
        </sequenceFlow>
        
        <endEvent id="approvedEnd">
            <extensionElements>
                <activiti:executionListener event="end" 
                    delegateExpression="${documentApprovedListener}"/>
            </extensionElements>
        </endEvent>
        
        <endEvent id="rejectedEnd">
            <extensionElements>
                <activiti:executionListener event="end" 
                    delegateExpression="${documentRejectedListener}"/>
            </extensionElements>
        </endEvent>
        
    </process>
</definitions>
```

## ğŸ“Š ä¸šåŠ¡èƒ½åŠ›çŸ©é˜µä¸å®ç°

### 1. ç”¨æˆ·ç®¡ç†èƒ½åŠ›å®ç°

| èƒ½åŠ›é¡¹ | å®ç°ç±» | å…³é”®æ–¹æ³• | æ€§èƒ½æŒ‡æ ‡ | ç›‘æ§æŒ‡æ ‡ |
|--------|--------|----------|----------|----------|
| ç”¨æˆ·æ³¨å†Œ | UserDomainService | createUser() | å“åº”æ—¶é—´<200ms | æ³¨å†ŒæˆåŠŸç‡ |
| èº«ä»½è®¤è¯ | AuthenticationService | authenticate() | å“åº”æ—¶é—´<100ms | ç™»å½•æˆåŠŸç‡ |
| æƒé™éªŒè¯ | PermissionService | checkPermission() | å“åº”æ—¶é—´<50ms | æƒé™æ£€æŸ¥QPS |
| å¯†ç é‡ç½® | PasswordResetService | resetPassword() | å“åº”æ—¶é—´<500ms | é‚®ä»¶å‘é€æˆåŠŸç‡ |

**æƒé™éªŒè¯å®ç°**:
```java
@Component
public class PermissionService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æƒé™
     */
    @Cacheable(value = "user_permissions", key = "#userId")
    public boolean hasPermission(Long userId, String resource, String action) {
        // 1. ä»ç¼“å­˜è·å–ç”¨æˆ·æƒé™
        String cacheKey = "user_permissions:" + userId;
        Set<String> permissions = (Set<String>) redisTemplate.opsForValue().get(cacheKey);
        
        if (permissions == null) {
            // 2. ä»æ•°æ®åº“åŠ è½½æƒé™
            User user = userRepository.findById(userId)
                .orElseThrow(() -> new UserNotFoundException("User not found: " + userId));
            
            permissions = user.getPermissions();
            
            // 3. ç¼“å­˜æƒé™ä¿¡æ¯
            redisTemplate.opsForValue().set(cacheKey, permissions, Duration.ofMinutes(30));
        }
        
        // 4. æ£€æŸ¥æƒé™
        String requiredPermission = resource + ":" + action;
        return permissions.contains(requiredPermission) || 
               permissions.contains("*:*") || // è¶…çº§ç®¡ç†å‘˜æƒé™
               permissions.contains(resource + ":*"); // èµ„æºæ‰€æœ‰æƒé™
    }
    
    /**
     * æ¸…é™¤ç”¨æˆ·æƒé™ç¼“å­˜
     */
    @CacheEvict(value = "user_permissions", key = "#userId")
    public void clearUserPermissionCache(Long userId) {
        // ç¼“å­˜æ¸…é™¤é€»è¾‘
    }
}
```

### 2. å†…å®¹ç®¡ç†èƒ½åŠ›å®ç°

| èƒ½åŠ›é¡¹ | å®ç°ç±» | å…³é”®æ–¹æ³• | æ€§èƒ½æŒ‡æ ‡ | å­˜å‚¨ç­–ç•¥ |
|--------|--------|----------|----------|----------|
| æ–‡æ¡£åˆ›å»º | DocumentDomainService | createDocument() | å“åº”æ—¶é—´<300ms | MySQLå­˜å‚¨ |
| å…¨æ–‡æœç´¢ | SearchService | searchDocuments() | å“åº”æ—¶é—´<500ms | Elasticsearch |
| ç‰ˆæœ¬æ§åˆ¶ | VersionService | createVersion() | å“åº”æ—¶é—´<200ms | MongoDBå­˜å‚¨ |
| å†…å®¹å®¡æ ¸ | ReviewService | submitForReview() | å“åº”æ—¶é—´<400ms | å·¥ä½œæµå¼•æ“ |

**æœç´¢æœåŠ¡å®ç°**:
```java
@Service
public class SearchService {
    
    @Autowired
    private ElasticsearchOperations elasticsearchOperations;
    
    @Autowired
    private DocumentRepository documentRepository;
    
    /**
     * å…¨æ–‡æœç´¢æ–‡æ¡£
     */
    public SearchResult<DocumentDTO> searchDocuments(SearchQuery query) {
        // 1. æ„å»ºæœç´¢æŸ¥è¯¢
        BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();
        
        // å…³é”®è¯æœç´¢
        if (StringUtils.hasText(query.getKeyword())) {
            boolQuery.must(QueryBuilders.multiMatchQuery(query.getKeyword())
                .field("title", 2.0f)
                .field("content", 1.0f)
                .field("tags.name", 1.5f)
                .type(MultiMatchQueryBuilder.Type.BEST_FIELDS));
        }
        
        // åˆ†ç±»è¿‡æ»¤
        if (query.getCategoryId() != null) {
            boolQuery.filter(QueryBuilders.termQuery("category.id", query.getCategoryId()));
        }
        
        // çŠ¶æ€è¿‡æ»¤
        if (query.getStatus() != null) {
            boolQuery.filter(QueryBuilders.termQuery("status", query.getStatus().name()));
        }
        
        // æ—¶é—´èŒƒå›´è¿‡æ»¤
        if (query.getStartDate() != null && query.getEndDate() != null) {
            boolQuery.filter(QueryBuilders.rangeQuery("createdAt")
                .gte(query.getStartDate())
                .lte(query.getEndDate()));
        }
        
        // 2. æ„å»ºæ’åº
        List<SortBuilder<?>> sorts = new ArrayList<>();
        if ("relevance".equals(query.getSortBy())) {
            sorts.add(ScoreSortBuilder.DESC);
        } else if ("date".equals(query.getSortBy())) {
            sorts.add(FieldSortBuilder.DESC.field("createdAt"));
        } else if ("title".equals(query.getSortBy())) {
            sorts.add(FieldSortBuilder.ASC.field("title.keyword"));
        }
        
        // 3. æ„å»ºé«˜äº®
        HighlightBuilder highlightBuilder = new HighlightBuilder()
            .field("title")
            .field("content")
            .fragmentSize(150)
            .numOfFragments(3);
        
        // 4. æ‰§è¡Œæœç´¢
        NativeSearchQuery searchQuery = new NativeSearchQueryBuilder()
            .withQuery(boolQuery)
            .withSorts(sorts)
            .withHighlightBuilder(highlightBuilder)
            .withPageable(PageRequest.of(query.getPage(), query.getSize()))
            .build();
        
        SearchHits<DocumentDocument> searchHits = elasticsearchOperations.search(searchQuery, DocumentDocument.class);
        
        // 5. è½¬æ¢ç»“æœ
        List<DocumentDTO> documents = searchHits.getSearchHits().stream()
            .map(hit -> {
                DocumentDocument doc = hit.getContent();
                DocumentDTO dto = DocumentMapper.toDTO(doc);
                
                // è®¾ç½®é«˜äº®ç‰‡æ®µ
                if (hit.getHighlightFields().containsKey("title")) {
                    dto.setHighlightedTitle(hit.getHighlightFields().get("title").getFragments()[0].string());
                }
                if (hit.getHighlightFields().containsKey("content")) {
                    dto.setHighlightedContent(hit.getHighlightFields().get("content").getFragments()[0].string());
                }
                
                return dto;
            })
            .collect(Collectors.toList());
        
        return SearchResult.<DocumentDTO>builder()
            .content(documents)
            .totalElements(searchHits.getTotalHits())
            .totalPages((int) Math.ceil((double) searchHits.getTotalHits() / query.getSize()))
            .currentPage(query.getPage())
            .build();
    }
}
```

## ğŸ”§ ä¸šåŠ¡è§„åˆ™å¼•æ“

### 1. è§„åˆ™å¼•æ“æ¶æ„

```java
@Component
public class BusinessRuleEngine {
    
    @Autowired
    private KieContainer kieContainer;
    
    @Autowired
    private RuleRepository ruleRepository;
    
    /**
     * æ‰§è¡Œä¸šåŠ¡è§„åˆ™
     */
    public RuleExecutionResult executeRules(String ruleGroup, Map<String, Object> facts) {
        // 1. è·å–KIEä¼šè¯
        KieSession kieSession = kieContainer.newKieSession();
        
        try {
            // 2. æ’å…¥äº‹å®å¯¹è±¡
            facts.forEach(kieSession::insert);
            
            // 3. è®¾ç½®å…¨å±€å˜é‡
            kieSession.setGlobal("ruleLogger", new RuleLogger());
            
            // 4. æ‰§è¡Œè§„åˆ™
            kieSession.fireAllRules();
            
            // 5. è·å–æ‰§è¡Œç»“æœ
            RuleExecutionResult result = extractExecutionResult(kieSession);
            
            return result;
        } finally {
            kieSession.dispose();
        }
    }
    
    /**
     * ç”¨æˆ·æ³¨å†Œè§„åˆ™éªŒè¯
     */
    public ValidationResult validateUserRegistration(CreateUserCommand command) {
        Map<String, Object> facts = new HashMap<>();
        facts.put("command", command);
        facts.put("result", new ValidationResult());
        
        RuleExecutionResult executionResult = executeRules("user_registration", facts);
        
        return (ValidationResult) executionResult.getFact("result");
    }
}
```

### 2. ä¸šåŠ¡è§„åˆ™ç¤ºä¾‹ (DRL)

```drools
// ç”¨æˆ·æ³¨å†Œè§„åˆ™.drl
package com.kev1n.spring4demo.rules

import com.kev1n.spring4demo.core.domain.user.command.CreateUserCommand
import com.kev1n.spring4demo.core.domain.user.validation.ValidationResult

rule "ç”¨æˆ·åé•¿åº¦éªŒè¯"
when
    $command : CreateUserCommand(username == null || username.length < 3 || username.length > 50)
    $result : ValidationResult()
then
    $result.addError("ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´");
end

rule "é‚®ç®±æ ¼å¼éªŒè¯"
when
    $command : CreateUserCommand(email == null || !email.matches("^[A-Za-z0-9+_.-]+@(.+)$"))
    $result : ValidationResult()
then
    $result.addError("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®");
end

rule "å¯†ç å¼ºåº¦éªŒè¯"
when
    $command : CreateUserCommand(password == null || !password.matches("^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]"))
    $result : ValidationResult()
then
    $result.addError("å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦");
end

rule "ä¼ä¸šé‚®ç®±åŸŸåéªŒè¯"
when
    $command : CreateUserCommand(email != null && !email.endsWith("@company.com"))
    $result : ValidationResult()
then
    $result.addWarning("å»ºè®®ä½¿ç”¨ä¼ä¸šé‚®ç®±æ³¨å†Œ");
end
```

## ğŸ“ˆ ä¸šåŠ¡ç›‘æ§ä¸åˆ†æ

### 1. ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§

```java
@Component
public class BusinessMetrics {
    
    private final Counter userRegistrationCounter;
    private final Counter documentCreationCounter;
    private final Timer userLoginTimer;
    private final Gauge activeUsersGauge;
    
    public BusinessMetrics(MeterRegistry meterRegistry) {
        this.userRegistrationCounter = Counter.builder("business.user.registrations")
            .description("Number of user registrations")
            .register(meterRegistry);
        
        this.documentCreationCounter = Counter.builder("business.document.creations")
            .description("Number of document creations")
            .register(meterRegistry);
        
        this.userLoginTimer = Timer.builder("business.user.login.time")
            .description("User login response time")
            .register(meterRegistry);
        
        this.activeUsersGauge = Gauge.builder("business.users.active")
            .description("Number of active users")
            .register(meterRegistry, this, BusinessMetrics::getActiveUserCount);
    }
    
    @EventListener
    public void handleUserRegistered(UserRegisteredEvent event) {
        userRegistrationCounter.increment(
            Tags.of("tenant", event.getTenantId().toString())
        );
    }
    
    @EventListener
    public void handleDocumentCreated(DocumentCreatedEvent event) {
        documentCreationCounter.increment(
            Tags.of("category", event.getCategory(), "author", event.getAuthorId().toString())
        );
    }
    
    public Timer.Sample startLoginTimer() {
        return Timer.start();
    }
    
    public void recordLoginTime(Timer.Sample sample) {
        sample.stop(userLoginTimer);
    }
    
    private double getActiveUserCount() {
        // å®ç°è·å–æ´»è·ƒç”¨æˆ·æ•°çš„é€»è¾‘
        return userService.getActiveUserCount();
    }
}
```

### 2. ä¸šåŠ¡åˆ†ææœåŠ¡

```java
@Service
public class BusinessAnalyticsService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private DocumentRepository documentRepository;
    
    @Autowired
    private ProcessInstanceRepository processInstanceRepository;
    
    /**
     * ç”¨æˆ·æ´»è·ƒåº¦åˆ†æ
     */
    public UserActivityAnalysis analyzeUserActivity(LocalDate startDate, LocalDate endDate) {
        // 1. æŸ¥è¯¢æ—¶é—´æ®µå†…çš„ç”¨æˆ·æ´»åŠ¨æ•°æ®
        List<UserActivity> activities = userRepository.findUserActivities(startDate, endDate);
        
        // 2. è®¡ç®—æ´»è·ƒåº¦æŒ‡æ ‡
        long totalUsers = userRepository.count();
        long activeUsers = activities.stream()
            .map(UserActivity::getUserId)
            .distinct()
            .count();
        
        double activityRate = (double) activeUsers / totalUsers * 100;
        
        // 3. æŒ‰å¤©ç»Ÿè®¡æ´»è·ƒç”¨æˆ·æ•°
        Map<LocalDate, Long> dailyActiveUsers = activities.stream()
            .collect(Collectors.groupingBy(
                UserActivity::getDate,
                Collectors.counting()
            ));
        
        // 4. è®¡ç®—ç•™å­˜ç‡
        double retentionRate = calculateRetentionRate(startDate, endDate);
        
        return UserActivityAnalysis.builder()
            .totalUsers(totalUsers)
            .activeUsers(activeUsers)
            .activityRate(activityRate)
            .dailyActiveUsers(dailyActiveUsers)
            .retentionRate(retentionRate)
            .build();
    }
    
    /**
     * å†…å®¹å‘å¸ƒåˆ†æ
     */
    public ContentPublishingAnalysis analyzeContentPublishing(LocalDate startDate, LocalDate endDate) {
        // 1. æŸ¥è¯¢æ–‡æ¡£å‘å¸ƒæ•°æ®
        List<Document> documents = documentRepository.findByPublishedAtBetween(startDate, endDate);
        
        // 2. æŒ‰åˆ†ç±»ç»Ÿè®¡
        Map<String, Long> documentsByCategory = documents.stream()
            .collect(Collectors.groupingBy(
                doc -> doc.getCategory().getName(),
                Collectors.counting()
            ));
        
        // 3. æŒ‰ä½œè€…ç»Ÿè®¡
        Map<String, Long> documentsByAuthor = documents.stream()
            .collect(Collectors.groupingBy(
                doc -> doc.getAuthor().getUsername(),
                Collectors.counting()
            ));
        
        // 4. è®¡ç®—å¹³å‡å®¡æ ¸æ—¶é—´
        double averageReviewTime = documents.stream()
            .filter(doc -> doc.getReviewedAt() != null)
            .mapToLong(doc -> Duration.between(doc.getCreatedAt(), doc.getReviewedAt()).toHours())
            .average()
            .orElse(0.0);
        
        return ContentPublishingAnalysis.builder()
            .totalDocuments(documents.size())
            .documentsByCategory(documentsByCategory)
            .documentsByAuthor(documentsByAuthor)
            .averageReviewTime(averageReviewTime)
            .build();
    }
}
```

---

*æœ¬æ–‡æ¡£æä¾›äº†è¯¦ç»†çš„ä¸šåŠ¡æ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬å…·ä½“çš„å®ç°ä»£ç ã€é…ç½®ç¤ºä¾‹å’Œæœ€ä½³å®è·µï¼Œä¸ºå¼€å‘å›¢é˜Ÿæä¾›äº†ç›´æ¥çš„æŠ€æœ¯æŒ‡å¯¼ã€‚*