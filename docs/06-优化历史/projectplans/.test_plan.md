# Junmo Platform 测试覆盖计划

## 概述

本文档基于 `docs/05-最佳实践/TEST-SOLUTIONS.md` 制定，旨在为 Junmo Platform 项目提供完整的测试覆盖计划。

**测试覆盖率目标：**
- 代码行覆盖率：85%
- 分支覆盖率：75%

---

## 一、框架层面测试覆盖计划

### 1.1 Spring Boot 核心框架测试

#### 1.1.1 配置属性测试

| 配置类 | 测试类 | 测试点 | 优先级 | 状态 |
|--------|--------|--------|--------|------|
| RustFSProperties | RustFSPropertiesTest | 配置绑定、默认值、验证 | 高 | 待创建 |
| KKFileViewProperties | KKFileViewPropertiesTest | 配置绑定、默认值、验证 | 高 | 待创建 |
| QuartzProperties | QuartzPropertiesTest | 配置绑定、默认值、验证 | 高 | 待创建 |
| DynamicDataSourceProperties | DynamicDataSourcePropertiesTest | 多数据源配置绑定 | 高 | 待创建 |
| RedissonProperties | RedissonPropertiesTest | Redisson 配置绑定 | 中 | 待创建 |
| CustomSeataProperties | CustomSeataPropertiesTest | Seata 配置绑定 | 中 | 待创建 |

**测试类位置：** `Junmo Platform-common/src/test/java/com/kev1n/Junmo Platform/common/config/`

**测试要点：**
- 使用 `@ConfigurationPropertiesTest` 验证配置绑定
- 测试默认值是否正确
- 测试配置验证注解（如有）

#### 1.1.2 配置类测试

| 配置类 | 测试类 | 测试点 | 优先级 | 状态 |
|--------|--------|--------|--------|------|
| MybatisPlusConfig | MybatisPlusConfigTest | Bean 创建、分页插件配置 | 高 | 已创建 |
| WebMvcConfig | WebMvcConfigTest | 拦截器注册、CORS 配置 | 高 | 已创建 |
| SwaggerConfig | SwaggerConfigTest | OpenAPI Bean 创建 | 中 | 已创建 |
| SaTokenSecurityConfig | SaTokenSecurityConfigTest | Sa-Token 安全配置 | 高 | 已创建 |
| PasswordSecurityConfig | PasswordSecurityConfigTest | 密码加密器 Bean | 高 | 已创建 |
| RedissonConfig | RedissonConfigTest | Redisson 客户端 Bean | 中 | 已创建 |
| S3ClientConfig | S3ClientConfigTest | S3 客户端 Bean | 中 | 已创建 |
| ScheduledTaskConfig | ScheduledTaskConfigTest | Spring Task 线程池配置 | 高 | 已创建 |
| QuartzConfig | QuartzConfigTest | Quartz 调度器配置 | 高 | 已创建 |
| DynamicDataSourceConfig | DynamicDataSourceConfigTest | 动态数据源配置 | 高 | 已创建 |
| SeataConfig | SeataConfigTest | Seata 分布式事务配置 | 中 | 已创建 |

**测试类位置：**
- `Junmo Platform-common/src/test/java/com/kev1n/Junmo Platform/common/config/`
- `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/config/`
- `Junmo Platform-web/src/test/java/com/kev1n/Junmo Platform/web/config/`

**测试要点：**
- 使用 `@SpringBootTest` 验证 Bean 创建
- 使用 `@MockBean` 模拟外部依赖
- 验证配置属性是否正确注入

---

### 1.2 Web 框架测试

#### 1.2.1 Controller 测试

| Controller | 测试类 | 测试点 | 优先级 | 状态 |
|------------|--------|--------|--------|------|
| UserController | UserControllerTest | CRUD 接口、参数绑定、异常处理 | 高 | 待创建 |
| AuthController | AuthControllerTest | 登录、登出、Token 刷新 | 高 | 待创建 |
| FileStorageController | FileStorageControllerTest | 文件上传、下载、删除 | 高 | 待创建 |
| DocumentPreviewController | DocumentPreviewControllerTest | 预览 URL 生成 | 中 | 待创建 |
| JobScheduleController | JobScheduleControllerTest | 任务管理接口 | 中 | 待创建 |
| SeataController | SeataControllerTest | 分布式事务接口 | 中 | 待创建 |
| RedissonAndDataSourceController | RedissonAndDataSourceControllerTest | Redisson + 数据源测试 | 中 | 待创建 |
| ApiVersionController | ApiVersionControllerTest | API 版本控制 | 低 | 待创建 |

**测试类位置：** `Junmo Platform-web/src/test/java/com/kev1n/Junmo Platform/web/controller/`

**测试要点：**
- 使用 `@WebMvcTest` 进行单元测试
- 使用 `@AutoConfigureMockMvc` 进行集成测试
- 测试请求/响应序列化/反序列化
- 测试参数校验（`@Valid`、`@Validated`）
- 测试异常处理

#### 1.2.2 集成测试

| Controller | 集成测试类 | 测试点 | 优先级 | 状态 |
|------------|------------|--------|--------|------|
| UserController | UserControllerIT | 完整 CRUD 流程 | 高 | 已创建 |
| AuthController | AuthControllerIT | 完整认证流程 | 高 | 待创建 |
| FileStorageController | FileStorageControllerIT | 完整文件操作流程 | 高 | 待创建 |

**测试类位置：** `Junmo Platform-web/src/test/java/com/kev1n/Junmo Platform/web/controller/`

**测试要点：**
- 使用 `@SpringBootTest` + `@AutoConfigureMockMvc`
- 集成真实数据库（H2 或 Testcontainers）
- 测试完整业务流程

---

## 二、数据存储测试覆盖计划

### 2.1 MySQL 测试

#### 2.1.1 Mapper 层测试

| Mapper | 测试类 | 测试点 | 优先级 | 状态 |
|--------|--------|--------|--------|------|
| UserMapper | UserMapperTest | CRUD、条件查询、分页 | 高 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/mapper/`

**测试要点：**
- 使用 `@SpringBootTest` + H2 内存数据库（单元测试）
- 使用 `@Testcontainers` + MySQL（集成测试）
- 测试 MyBatis-Plus CRUD 操作
- 测试 LambdaQueryWrapper 条件查询
- 测试分页查询
- 测试逻辑删除
- 测试乐观锁

#### 2.1.2 Mapper 集成测试

| Mapper | 集成测试类 | 测试点 | 优先级 | 状态 |
|--------|------------|--------|--------|------|
| UserMapper | UserMapperIT | 完整 CRUD 流程、事务管理 | 高 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/mapper/`

**测试要点：**
- 使用 `@Testcontainers` + MySQL 容器
- 测试真实数据库操作
- 测试事务回滚
- 测试并发场景（乐观锁）

---

### 2.2 Redis 测试

#### 2.2.1 Redis 操作测试

| Service | 测试类 | 测试点 | 优先级 | 状态 |
|---------|--------|--------|--------|------|
| RedissonService | RedissonServiceTest | 分布式锁、限流、布隆过滤器 | 高 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/service/`

**测试要点：**
- 使用 `@Testcontainers` + Redis 容器
- 测试分布式锁（RLock）
- 测试读写锁（ReadWriteLock）
- 测试限流器（RRateLimiter）
- 测试布隆过滤器（RBloomFilter）
- 测试分布式集合（RMap、RSet、RList）

---

### 2.3 动态数据源测试

| Service | 测试类 | 测试点 | 优先级 | 状态 |
|---------|--------|--------|--------|------|
| DynamicDataSourceService | DynamicDataSourceServiceTest | 数据源切换、事务绑定 | 高 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/service/`

**测试要点：**
- 使用 `@Testcontainers` + 多个 MySQL 实例
- 测试 `@DS` 注解数据源切换
- 测试手动数据源切换
- 测试事务与数据源绑定

---

### 2.4 其他数据存储（待实现）

| 数据存储 | 测试类 | 测试点 | 优先级 | 状态 |
|----------|--------|--------|--------|------|
| MongoDB | (待创建) | CRUD、聚合查询 | 低 | 待创建 |
| Elasticsearch | (待创建) | 索引管理、文档操作、搜索 | 低 | 待创建 |
| Neo4j | (待创建) | 节点/关系操作、图遍历 | 低 | 待创建 |
| InfluxDB | (待创建) | 时序数据写入、Flux 查询 | 低 | 待创建 |

**测试要点：**
- 使用 `@Testcontainers` 对应容器
- 测试基础 CRUD 操作
- 测试复杂查询

---

### 2.5 H2 内存数据库配置

**配置文件位置：** `Junmo Platform-core/src/test/resources/application-test.yml`

**测试要点：**
- 确保 H2 兼容 MySQL 模式
- 配置正确的驱动和 URL
- 测试数据自动回滚

---

## 三、消息中间件测试覆盖计划

### 3.1 RabbitMQ 测试（待实现）

| 测试点 | 测试类 | 测试内容 | 优先级 | 状态 |
|--------|--------|---------|--------|------|
| 消息发送 | RabbitMQProducerTest | RabbitTemplate 发送消息 | 中 | 待创建 |
| 消息消费 | RabbitMQConsumerTest | @RabbitListener 监听 | 中 | 待创建 |
| 消息确认 | RabbitMQAckTest | ACK/NACK 机制 | 中 | 待创建 |
| 死信队列 | RabbitMQDLXTest | DLX、DLK 配置 | 低 | 待创建 |
| 延迟队列 | RabbitMQDelayTest | 延迟消息投递 | 低 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/messaging/rabbitmq/`

**测试要点：**
- 使用 `@Testcontainers` + RabbitMQ 容器
- 测试消息发送和接收
- 测试消息确认机制

---

### 3.2 Kafka 测试（待实现）

| 测试点 | 测试类 | 测试内容 | 优先级 | 状态 |
|--------|--------|---------|--------|------|
| 消息发送 | KafkaProducerTest | KafkaTemplate 发送 | 中 | 待创建 |
| 消息消费 | KafkaConsumerTest | @KafkaListener 监听 | 中 | 待创建 |
| 分区策略 | KafkaPartitionTest | 自定义分区器 | 低 | 待创建 |
| 消费者组 | KafkaGroupTest | 组内消费、Rebalance | 低 | 待创建 |
| 事务消息 | KafkaTransactionTest | 事务性发送/消费 | 低 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/messaging/kafka/`

**测试要点：**
- 使用 `@Testcontainers` + Kafka 容器
- 测试消息发送和接收
- 测试分区和消费者组

---

### 3.3 RocketMQ 测试（待实现）

| 测试点 | 测试类 | 测试内容 | 优先级 | 状态 |
|--------|--------|---------|--------|------|
| 消息发送 | RocketMQProducerTest | 同步/异步/单向发送 | 低 | 待创建 |
| 消息消费 | RocketMQConsumerTest | Push/Pull 模式 | 低 | 待创建 |
| 顺序消息 | RocketMQOrderTest | 分区有序消息 | 低 | 待创建 |
| 事务消息 | RocketMQTransactionTest | 两阶段提交 | 低 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/messaging/rocketmq/`

---

## 四、安全认证测试覆盖计划

### 4.1 Sa-Token 测试

| Service | 测试类 | 测试点 | 优先级 | 状态 |
|---------|--------|--------|--------|------|
| AuthService | AuthServiceTest | 登录认证、Token 管理 | 高 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/service/`

**测试要点：**
- 测试登录认证（StpUtil.login）
- 测试 Token 生成和验证
- 测试 Token 刷新
- 测试权限校验（@SaCheckPermission、@SaCheckRole）
- 测试会话管理
- 测试踢人下线

---

### 4.2 密码加密测试

| 配置类 | 测试类 | 测试点 | 优先级 | 状态 |
|--------|--------|--------|--------|------|
| PasswordSecurityConfig | PasswordSecurityConfigTest | BCrypt 加密、密码强度 | 高 | 待创建 |

**测试类位置：** `Junmo Platform-common/src/test/java/com/kev1n/Junmo Platform/common/config/`

**测试要点：**
- 测试 BCrypt 密码加密
- 测试密码验证
- 测试密码强度校验

---

### 4.3 安全配置测试

| 配置类 | 测试类 | 测试点 | 优先级 | 状态 |
|--------|--------|--------|--------|------|
| SaTokenSecurityConfig | SaTokenSecurityConfigTest | 权限拦截器配置 | 高 | 待创建 |

**测试类位置：** `Junmo Platform-web/src/test/java/com/kev1n/Junmo Platform/web/config/`

**测试要点：**
- 测试权限拦截器注册
- 测试路由规则配置
- 测试登录验证逻辑

---

## 五、任务调度测试覆盖计划

### 5.1 Spring Task 测试

| 测试点 | 测试类 | 测试内容 | 优先级 | 状态 |
|--------|--------|---------|--------|------|
| 定时任务 | ScheduledTaskTest | @Scheduled、Cron 表达式 | 高 | 待创建 |
| 异步任务 | AsyncTaskTest | @Async、线程池配置 | 高 | 待创建 |
| 线程池配置 | ThreadPoolTest | 线程池创建、执行 | 中 | 待创建 |

**测试类位置：** `Junmo Platform-common/src/test/java/com/kev1n/Junmo Platform/common/config/`

**测试要点：**
- 测试 @Scheduled 注解的各种模式（fixedRate、fixedDelay、cron）
- 测试 @Async 异步任务执行
- 测试线程池配置和任务执行
- 测试任务异常处理

---

### 5.2 Quartz 测试

| 测试点 | 测试类 | 测试内容 | 优先级 | 状态 |
|--------|--------|---------|--------|------|
| Job/Trigger | QuartzJobTest | 任务定义、触发器 | 高 | 待创建 |
| 任务调度 | QuartzSchedulerTest | 任务调度、暂停、恢复 | 高 | 待创建 |
| 持久化 | QuartzPersistenceTest | 数据库存储（可选） | 中 | 待创建 |
| 动态任务 | QuartzDynamicJobTest | 动态创建、更新、删除任务 | 中 | 待创建 |

**测试类位置：** `Junmo Platform-common/src/test/java/com/kev1n/Junmo Platform/common/config/`

**测试要点：**
- 测试 Quartz Job 执行
- 测试 CronTrigger 触发器
- 测试任务暂停和恢复
- 测试任务删除
- 测试任务状态查询
- 测试动态任务创建和更新

---

## 六、分布式组件测试覆盖计划

### 6.1 Seata 分布式事务测试

| Service | 测试类 | 测试点 | 优先级 | 状态 |
|---------|--------|--------|--------|------|
| SeataService | SeataServiceTest | 全局事务、回滚 | 高 | 待创建 |
| SeataExampleService | SeataExampleServiceTest | 跨库事务示例 | 中 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/service/`

**测试要点：**
- 使用 `@Testcontainers` + Seata Server + MySQL
- 测试 `@GlobalTransactional` 注解
- 测试全局事务提交
- 测试异常回滚
- 测试事务超时

---

### 6.2 Redisson 测试

| Service | 测试类 | 测试点 | 优先级 | 状态 |
|---------|--------|--------|--------|------|
| RedissonService | RedissonServiceTest | 分布式锁、限流、布隆过滤器 | 高 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/service/`

**测试要点：**
- 使用 `@Testcontainers` + Redis 容器
- 测试分布式锁（可重入锁）
- 测试读写锁
- 测试限流器
- 测试布隆过滤器
- 测试分布式集合

---

### 6.3 动态数据源测试

| Service | 测试类 | 测试点 | 优先级 | 状态 |
|---------|--------|--------|--------|------|
| DynamicDataSourceService | DynamicDataSourceServiceTest | 数据源切换、事务绑定 | 高 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/service/`

**测试要点：**
- 使用 `@Testcontainers` + 多个 MySQL 实例
- 测试 `@DS` 注解切换
- 测试手动切换
- 测试事务绑定

---

## 七、文件存储测试覆盖计划

### 7.1 RustFS (S3 兼容) 测试

| Service | 测试类 | 测试点 | 优先级 | 状态 |
|---------|--------|--------|--------|------|
| FileStorageService | FileStorageServiceTest | 上传、下载、删除 | 高 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/service/`

**测试要点：**
- 使用 `@Testcontainers` + MinIO 容器（S3 兼容）
- 测试单文件上传
- 测试分片上传
- 测试文件下载（流式、断点续传）
- 测试文件删除（单文件、批量）
- 测试预签名 URL
- 测试生命周期管理

---

### 7.2 KKFileView 文档预览测试

| Service | 测试类 | 测试点 | 优先级 | 状态 |
|---------|--------|--------|--------|------|
| DocumentPreviewService | DocumentPreviewServiceTest | 预览 URL 生成、水印 | 中 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/service/`

**测试要点：**
- Mock KKFileView 服务
- 测试预览 URL 生成
- 测试水印处理
- 测试缓存机制

---

## 八、缓存测试覆盖计划

### 8.1 Caffeine 本地缓存测试（待实现）

| 测试点 | 测试类 | 测试内容 | 优先级 | 状态 |
|--------|--------|---------|--------|------|
| 缓存操作 | CaffeineCacheTest | put/get/evict | 低 | 待创建 |
| 过期策略 | CaffeineExpirationTest | 基于时间、基于大小 | 低 | 待创建 |
| 异步加载 | CaffeineAsyncTest | CacheLoader | 低 | 待创建 |

**测试类位置：** `Junmo Platform-common/src/test/java/com/kev1n/Junmo Platform/common/cache/`

---

### 8.2 Guava Cache 测试（待实现）

| 测试点 | 测试类 | 测试内容 | 优先级 | 状态 |
|--------|--------|---------|--------|------|
| 缓存操作 | GuavaCacheTest | put/get/invalidate | 低 | 待创建 |
| 刷新机制 | GuavaRefreshTest | 自动刷新 | 低 | 待创建 |

**测试类位置：** `Junmo Platform-common/src/test/java/com/kev1n/Junmo Platform/common/cache/`

---

## 九、监控运维测试覆盖计划

### 9.1 Spring Boot Actuator 测试（待实现）

| 测试点 | 测试类 | 测试内容 | 优先级 | 状态 |
|--------|--------|---------|--------|------|
| 健康检查 | ActuatorHealthTest | /actuator/health | 低 | 待创建 |
| 指标收集 | ActuatorMetricsTest | /actuator/metrics | 低 | 待创建 |
| 环境信息 | ActuatorEnvTest | /actuator/env | 低 | 待创建 |
| 日志配置 | ActuatorLoggersTest | /actuator/loggers | 低 | 待创建 |

**测试类位置：** `Junmo Platform-starter/src/test/java/com/kev1n/Junmo Platform/starter/actuator/`

**测试要点：**
- 使用 `@SpringBootTest` + MockMvc
- 测试 Actuator 端点
- 测试自定义健康指标

---

### 9.2 Micrometer + Prometheus 测试（待实现）

| 测试点 | 测试类 | 测试内容 | 优先级 | 状态 |
|--------|--------|---------|--------|------|
| 自定义指标 | CustomMetricsTest | Counter、Gauge、Timer | 低 | 待创建 |
| 指标导出 | PrometheusExportTest | Prometheus 格式 | 低 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/metrics/`

---

### 9.3 Zipkin 链路追踪测试（待实现）

| 测试点 | 测试类 | 测试内容 | 优先级 | 状态 |
|--------|--------|---------|--------|------|
| Span 生成 | ZipkinSpanTest | HTTP 调用、数据库调用 | 低 | 待创建 |
| 链路传递 | ZipkinPropagationTest | B3 Header 传递 | 低 | 待创建 |

**测试类位置：** `Junmo Platform-web/src/test/java/com/kev1n/Junmo Platform/web/tracing/`

---

## 十、API 文档测试覆盖计划

### 10.1 SpringDoc OpenAPI 测试（待实现）

| 测试点 | 测试类 | 测试内容 | 优先级 | 状态 |
|--------|--------|---------|--------|------|
| 文档生成 | OpenAPIDocTest | OpenAPI JSON 规范 | 低 | 待创建 |
| Schema 定义 | OpenAPISchemaTest | DTO 验证 | 低 | 待创建 |
| 安全定义 | OpenAPISecurityTest | JWT、OAuth2 | 低 | 待创建 |

**测试类位置：** `Junmo Platform-web/src/test/java/com/kev1n/Junmo Platform/web/doc/`

**测试要点：**
- 使用 `@SpringBootTest` + MockMvc
- 测试 OpenAPI 文档生成
- 验证 Schema 定义

---

### 10.2 Knife4j 测试（待实现）

| 测试点 | 测试类 | 测试内容 | 优先级 | 状态 |
|--------|--------|---------|--------|------|
| UI 渲染 | Knife4jUITest | Swagger UI | 低 | 待创建 |
| 增强功能 | Knife4jEnhancedTest | 文档排序、分组 | 低 | 待创建 |

**测试类位置：** `Junmo Platform-web/src/test/java/com/kev1n/Junmo Platform/web/doc/`

---

## 十一、业务模块测试覆盖计划

### 11.1 User 模块

#### 11.1.1 Service 层测试

| Service | 测试类 | 测试点 | 优先级 | 状态 |
|---------|--------|--------|--------|------|
| UserService | UserServiceTest | CRUD、查询、分页 | 高 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/service/`

**测试要点：**
- 使用 `@ExtendWith(MockitoExtension.class)` Mock Mapper
- 测试用户创建
- 测试用户查询（按用户名、邮箱、状态）
- 测试用户更新
- 测试用户删除（逻辑删除）
- 测试分页查询

#### 11.1.2 Service 集成测试

| Service | 集成测试类 | 测试点 | 优先级 | 状态 |
|---------|------------|--------|--------|------|
| UserService | UserServiceIT | 完整 CRUD 流程 | 高 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/service/`

**测试要点：**
- 使用 `@SpringBootTest` + H2 或 Testcontainers MySQL
- 测试完整业务流程
- 测试事务管理

---

### 11.2 Auth 模块

#### 11.2.1 Service 层测试

| Service | 测试类 | 测试点 | 优先级 | 状态 |
|---------|--------|--------|--------|------|
| AuthService | AuthServiceTest | 登录、登出、Token 管理 | 高 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/service/`

**测试要点：**
- Mock Sa-Token 和 Mapper
- 测试用户名密码登录
- 测试 Token 生成
- 测试 Token 验证
- 测试 Token 刷新
- 测试登出
- 测试权限校验

---

### 11.3 FileStorage 模块

#### 11.3.1 Service 层测试

| Service | 测试类 | 测试点 | 优先级 | 状态 |
|---------|--------|--------|--------|------|
| FileStorageService | FileStorageServiceTest | 上传、下载、删除 | 高 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/service/`

**测试要点：**
- 使用 `@Testcontainers` + MinIO 容器
- Mock S3 客户端或使用真实 MinIO
- 测试单文件上传
- 测试多文件上传
- 测试文件下载
- 测试文件删除
- 测试预签名 URL 生成

---

### 11.4 DocumentPreview 模块

#### 11.4.1 Service 层测试

| Service | 测试类 | 测试点 | 优先级 | 状态 |
|---------|--------|--------|--------|------|
| DocumentPreviewService | DocumentPreviewServiceTest | 预览 URL 生成 | 中 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/service/`

**测试要点：**
- Mock KKFileView 服务
- 测试预览 URL 生成
- 测试带水印的预览 URL
- 测试格式检查

---

### 11.5 JobSchedule 模块

#### 11.5.1 Service 层测试

| Service | 测试类 | 测试点 | 优先级 | 状态 |
|---------|--------|--------|--------|------|
| JobScheduleService | JobScheduleServiceTest | 任务注册、执行 | 中 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/service/`

**测试要点：**
- Mock XXL-Job Admin
- 测试任务注册
- 测试任务执行

---

### 11.6 Seata 模块

#### 11.6.1 Service 层测试

| Service | 测试类 | 测试点 | 优先级 | 状态 |
|---------|--------|--------|--------|------|
| SeataService | SeataServiceTest | 全局事务、回滚 | 高 | 待创建 |
| SeataExampleService | SeataExampleServiceTest | 跨库事务示例 | 中 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/service/`

**测试要点：**
- 使用 `@Testcontainers` + Seata Server + MySQL
- 测试 `@GlobalTransactional` 注解
- 测试全局事务提交
- 测试异常回滚
- 测试跨库事务

---

### 11.7 Redisson + 数据源模块

#### 11.7.1 Service 层测试

| Service | 测试类 | 测试点 | 优先级 | 状态 |
|---------|--------|--------|--------|------|
| RedissonService | RedissonServiceTest | 分布式锁 + 数据库操作 | 中 | 待创建 |
| DynamicDataSourceService | DynamicDataSourceServiceTest | 数据源切换 | 高 | 待创建 |

**测试类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/service/`

**测试要点：**
- 使用 `@Testcontainers` + Redis + MySQL
- 测试分布式锁保护数据库操作
- 测试数据源切换

---

## 十二、通用测试点覆盖计划

### 12.1 工具类测试

| 工具类 | 测试类 | 测试点 | 优先级 | 状态 |
|--------|--------|--------|--------|------|
| 字符串工具 | (待创建) | Hutool、自定义工具 | 中 | 待创建 |
| 日期时间 | (待创建) | 日期格式化、计算 | 中 | 待创建 |
| JSON 处理 | (待创建) | Fastjson2 序列化/反序列化 | 中 | 待创建 |
| 加密解密 | (待创建) | AES、RSA、MD5 | 中 | 待创建 |

**测试类位置：** `Junmo Platform-common/src/test/java/com/kev1n/Junmo Platform/common/util/`

**测试要点：**
- 纯单元测试（无外部依赖）
- 测试边界条件
- 测试异常情况

---

### 12.2 异常处理测试

| 测试点 | 测试类 | 测试内容 | 优先级 | 状态 |
|--------|--------|---------|--------|------|
| 全局异常 | GlobalExceptionHandlerTest | @ControllerAdvice | 中 | 待创建 |
| 自定义异常 | CustomExceptionTest | 业务异常、系统异常 | 中 | 待创建 |

**测试类位置：** `Junmo Platform-web/src/test/java/com/kev1n/Junmo Platform/web/exception/`

**测试要点：**
- 使用 `@SpringBootTest` + MockMvc
- 测试异常处理器
- 测试自定义异常

---

### 12.3 拦截器测试

| 测试点 | 测试类 | 测试内容 | 优先级 | 状态 |
|--------|--------|---------|--------|------|
| 日志拦截 | LoggingInterceptorTest | 请求日志记录 | 中 | 待创建 |
| 权限拦截 | AuthInterceptorTest | Token 验证 | 高 | 待创建 |

**测试类位置：** `Junmo Platform-web/src/test/java/com/kev1n/Junmo Platform/web/interceptor/`

**测试要点：**
- 使用 `@SpringBootTest` + MockMvc
- 测试拦截器逻辑
- 测试拦截器注册

---

## 十三、测试基类设计

### 13.1 Core 模块基类

**基类位置：** `Junmo Platform-core/src/test/java/com/kev1n/Junmo Platform/core/BaseTest.java`

```java
@SpringBootTest
@ActiveProfiles("test")
@Transactional
@TestPropertySource(locations = "classpath:application-test.yml")
public abstract class BaseTest {

    @BeforeEach
    void setUp() {
        setupTest();
    }

    protected void setupTest() {
        // 子类覆盖
    }
}
```

---

### 13.2 Web 模块基类

**基类位置：** `Junmo Platform-web/src/test/java/com/kev1n/Junmo Platform/web/BaseWebTest.java`

```java
@SpringBootTest
@AutoConfigureMockMvc
@ActiveProfiles("test")
@Transactional
public abstract class BaseWebTest {

    @Autowired
    protected MockMvc mockMvc;

    protected void mockLogin(Long userId) {
        StpUtil.login(userId);
    }
}
```

---

## 十四、Testcontainers 配置

### 14.1 Testcontainers 依赖补充

需要在 `pom.xml` 中补充的依赖：

| 依赖 | 版本 | 用途 |
|------|------|------|
| testcontainers-junit-jupiter | 1.19.6 | 核心模块 |
| testcontainers-mysql | 1.19.6 | MySQL 容器 |
| testcontainers-postgresql | 1.19.6 | PostgreSQL 容器 |
| testcontainers-redis | 1.19.6 | Redis 容器 |
| testcontainers-mongodb | 1.19.6 | MongoDB 容器 |
| testcontainers-elasticsearch | 1.19.6 | Elasticsearch 容器 |
| testcontainers-rabbitmq | 1.19.6 | RabbitMQ 容器 |
| testcontainers-kafka | 1.19.6 | Kafka 容器 |
| testcontainers-neo4j | 1.19.6 | Neo4j 容器 |
| testcontainers-influxdb | 1.19.6 | InfluxDB 容器 |
| testcontainers-minio | 1.19.6 | MinIO 容器 |

---

### 14.2 Testcontainers 示例配置

**MySQL 示例：**
```java
@Testcontainers
class UserRepositoryTest {
    @Container
    static MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0")
            .withDatabaseName("testdb")
            .withUsername("test")
            .withPassword("test");

    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", mysql::getJdbcUrl);
        registry.add("spring.datasource.username", mysql::getUsername);
        registry.add("spring.datasource.password", mysql::getPassword);
    }
}
```

**Redis 示例：**
```java
@Testcontainers
class RedisServiceTest {
    @Container
    static GenericContainer<?> redis = new GenericContainer<>("redis:7-alpine")
            .withExposedPorts(6379);

    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.data.redis.host", redis::getHost);
        registry.add("spring.data.redis.port", () -> redis.getMappedPort(6379));
    }
}
```

**MinIO 示例：**
```java
@Testcontainers
class FileStorageTest {
    @Container
    static MinIOContainer minio = new MinIOContainer("minio/minio:latest")
            .withUserName("admin")
            .withPassword("admin123");

    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        registry.add("rustfs.endpoint", minio::getS3Endpoint);
        registry.add("rustfs.access-key", minio::getUserName);
        registry.add("rustfs.secret-key", minio::getPassword);
    }
}
```

---

## 十五、测试覆盖率统计

### 15.1 测试类统计

| 模块 | 类型 | 数量 | 状态 |
|------|------|------|------|
| **common** | Properties 测试类 | 6 | 待创建 |
| **common** | Config 测试类 | 7 | 待创建 |
| **common** | 工具类测试类 | 4 | 待创建 |
| **core** | Mapper 测试类 | 1 | 待创建 |
| **core** | Mapper 集成测试类 | 1 | 待创建 |
| **core** | Service 测试类 | 8 | 待创建 |
| **core** | Service 集成测试类 | 3 | 待创建 |
| **core** | 消息中间件测试类 | 5+ | 待创建 |
| **core** | 任务调度测试类 | 7+ | 待创建 |
| **core** | 监控运维测试类 | 6+ | 待创建 |
| **core** | 缓存测试类 | 6+ | 待创建 |
| **core** | 数据存储测试类 | 6+ | 待创建 |
| **web** | Config 测试类 | 4 | 待创建 |
| **web** | Controller 测试类 | 8 | 待创建 |
| **web** | Controller 集成测试类 | 3 | 待创建 |
| **web** | 异常处理测试类 | 2 | 待创建 |
| **web** | 拦截器测试类 | 2 | 待创建 |
| **web** | API 文档测试类 | 4+ | 待创建 |
| **总计** | | 70+ |  |

### 15.2 优先级统计

| 优先级 | 测试类数量 | 说明 |
|--------|-----------|------|
| 高 | 30+ | 核心业务、安全认证、数据存储 |
| 中 | 25+ | 配置、服务、缓存 |
| 低 | 15+ | 待实现功能、辅助功能 |

---

## 十六、测试执行计划

### 16.1 第一阶段：核心功能测试（高优先级）

**目标：** 完成核心业务流程测试，确保基本功能可用

**测试类：**
- Properties 测试类（6 个）
- Config 测试类（11 个）
- Controller 测试类（8 个）
- Controller 集成测试类（2 个新增）
- Mapper 测试类（1 个）
- Mapper 集成测试类（1 个）
- Service 测试类（8 个）
- Service 集成测试类（3 个）

**预计工作量：** 40+ 测试类

---

### 16.2 第二阶段：分布式组件测试（中优先级）

**目标：** 完成分布式组件测试，确保分布式功能可用

**测试类：**
- Redisson 测试类
- Seata 测试类
- 动态数据源测试类
- FileStorage 测试类
- DocumentPreview 测试类
- JobSchedule 测试类

**预计工作量：** 15+ 测试类

---

### 16.3 第三阶段：消息中间件测试（中优先级）

**目标：** 完成消息中间件测试，确保消息功能可用

**测试类：**
- RabbitMQ 测试类（5 个）
- Kafka 测试类（5 个）
- RocketMQ 测试类（4 个）

**预计工作量：** 14+ 测试类

---

### 16.4 第四阶段：辅助功能测试（低优先级）

**目标：** 完成辅助功能测试，提高代码覆盖率

**测试类：**
- 工具类测试类（4 个）
- 异常处理测试类（2 个）
- 拦截器测试类（2 个）
- API 文档测试类（4 个）
- 监控运维测试类（6 个）
- 缓存测试类（6 个）
- 其他数据存储测试类（6 个）

**预计工作量：** 30+ 测试类

---

## 进度跟踪

- [x] 任务 1：制定框架层面测试覆盖计划（已完成）
- [ ] 任务 2：制定数据存储测试覆盖计划
- [ ] 任务 3：制定消息中间件测试覆盖计划
- [ ] 任务 4：制定安全认证测试覆盖计划
- [ ] 任务 5：制定任务调度测试覆盖计划
- [ ] 任务 6：制定分布式组件测试覆盖计划
- [ ] 任务 7：制定文件存储测试覆盖计划
- [ ] 任务 8：制定缓存测试覆盖计划
- [ ] 任务 9：制定监控运维测试覆盖计划
- [ ] 任务 10：制定 API 文档测试覆盖计划
- [ ] 任务 11：制定业务模块测试覆盖计划
- [ ] 任务 12：制定通用测试点覆盖计划
- [ ] 任务 13：输出完整测试覆盖计划

---

*最后更新：2025-12-30*