# Spring4demo æ•°æ®æ¶æ„è®¾è®¡

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **æ–‡æ¡£åç§°** | Spring4demo æ•°æ®æ¶æ„è®¾è®¡ |
| **ç‰ˆæœ¬å·** | v1.1.0 |
| **åˆ›å»ºæ—¥æœŸ** | 2025-12-24 |
| **æ›´æ–°æ—¥æœŸ** | 2026-01-07 |
| **ä½œè€…** | æ•°æ®æ¶æ„å¸ˆ |
| **å®¡æ ¸äºº** | æ•°æ®åº“ç®¡ç†å‘˜ |
| **æ‰¹å‡†äºº** | æŠ€æœ¯æ€»ç›‘ |

## ğŸ“ æ›´æ–°è¯´æ˜

**v1.2.0 (2026-01-07)**:
- æ¶æ„å®šä½ä»å¾®æœåŠ¡æ¶æ„è°ƒæ•´ä¸ºå•ä½“Spring Bootåº”ç”¨
- å»æ‰å¾®æœåŠ¡ç›¸å…³ç»„ä»¶
- ä¿ç•™MongoDBã€Elasticsearchã€Neo4jã€InfluxDBç­‰æ•°æ®å­˜å‚¨
- æ›´æ–°æ•°æ®å­˜å‚¨æŠ€æœ¯æ ˆï¼Œåæ˜ å•ä½“åº”ç”¨æ¶æ„

**v1.1.0 (2026-01-07)**:
- ä¸»é”®ç­–ç•¥ä»AUTO_INCREMENTè°ƒæ•´ä¸ºé›ªèŠ±ç®—æ³•
- æ›´æ–°æ‰€æœ‰è¡¨çš„ä¸»é”®å®šä¹‰ï¼Œä½¿ç”¨é›ªèŠ±ç®—æ³•ç”Ÿæˆå”¯ä¸€ID
- æ·»åŠ è¡¨æ³¨é‡Šå’Œå­—æ®µæ³¨é‡Š

## ğŸ¯ æ•°æ®æ¶æ„æ¦‚è¿°

Spring4demoé‡‡ç”¨å¤šå±‚æ•°æ®æ¶æ„è®¾è®¡ï¼Œç»“åˆå…³ç³»å‹æ•°æ®åº“ã€NoSQLæ•°æ®åº“ã€ç¼“å­˜ç³»ç»Ÿå’Œæœç´¢å¼•æ“ï¼Œæ„å»ºé«˜æ€§èƒ½ã€é«˜å¯ç”¨ã€å¯æ‰©å±•çš„æ•°æ®å­˜å‚¨ä½“ç³»ã€‚æ•´ä¸ªæ¶æ„æ”¯æŒæ•°æ®åˆ†å±‚å­˜å‚¨ã€è¯»å†™åˆ†ç¦»ã€åˆ†åº“åˆ†è¡¨å’Œå®æ—¶æ•°æ®åŒæ­¥ã€‚

## ğŸ—ï¸ å­˜å‚¨æŠ€æœ¯æ¶æ„

### 1. æ•°æ®å­˜å‚¨é€‰å‹

**æŠ€æœ¯æ ˆç»„åˆ**:
```yaml
# æ•°æ®å­˜å‚¨æŠ€æœ¯æ ˆ
storage_stack:
  relational_database:
    engine: "MySQL 8.0"
    purpose: "æ ¸å¿ƒä¸šåŠ¡æ•°æ®å­˜å‚¨"
    features:
      - "ACIDäº‹åŠ¡æ”¯æŒ"
      - "å¼ºä¸€è‡´æ€§"
      - "å¤æ‚æŸ¥è¯¢"
      - "æ•°æ®å®Œæ•´æ€§"
    
  document_database:
    engine: "MongoDB 6.0.8"
    purpose: "æ–‡æ¡£å‹æ•°æ®å­˜å‚¨"
    features:
      - "çµæ´»çš„æ•°æ®æ¨¡å‹"
      - "æ°´å¹³æ‰©å±•"
      - "å…¨æ–‡æœç´¢"
      - "ç‰ˆæœ¬æ§åˆ¶"
    
  cache_database:
    engine: "Redis 7.0"
    purpose: "é«˜é€Ÿç¼“å­˜å­˜å‚¨"
    features:
      - "å†…å­˜å­˜å‚¨"
      - "æ•°æ®ç»“æ„ä¸°å¯Œ"
      - "æŒä¹…åŒ–æ”¯æŒ"
      - "é«˜å¹¶å‘"
    
  search_engine:
    engine: "Elasticsearch 8.8.0"
    purpose: "å…¨æ–‡æœç´¢å’Œåˆ†æ"
    features:
      - "å…¨æ–‡æœç´¢"
      - "å®æ—¶åˆ†æ"
      - "èšåˆæŸ¥è¯¢"
      - "åœ°ç†ç©ºé—´æœç´¢"
    
  time_series_database:
    engine: "InfluxDB 2.7.0"
    purpose: "æ—¶åºæ•°æ®å­˜å‚¨"
    features:
      - "æ—¶é—´åºåˆ—ä¼˜åŒ–"
      - "é«˜å†™å…¥æ€§èƒ½"
      - "æ•°æ®å‹ç¼©"
      - "å®æ—¶ç›‘æ§"
```

### 2. æ•°æ®åˆ†å±‚æ¶æ„

```mermaid
graph TB
    subgraph "åº”ç”¨å±‚"
        A1[Spring Bootåº”ç”¨] --> A2[æ•°æ®è®¿é—®å±‚]
    end
    
    subgraph "ç¼“å­˜å±‚"
        B1[æœ¬åœ°ç¼“å­˜ Caffeine] --> B2[åˆ†å¸ƒå¼ç¼“å­˜ Redis]
    end
    
    subgraph "æ•°æ®æœåŠ¡å±‚"
        C1[è¯»æœåŠ¡] --> C2[å†™æœåŠ¡]
        C3[æœç´¢æœåŠ¡] --> C4[åˆ†ææœåŠ¡]
    end
    
    subgraph "å­˜å‚¨å±‚"
        D1[MySQLä¸»åº“] --> D2[MySQLä»åº“]
        D3[MongoDBé›†ç¾¤] --> D4[Elasticsearché›†ç¾¤]
        D5[InfluxDBé›†ç¾¤]
    end
    
    A2 --> B1
    B1 --> B2
    B2 --> C1
    B2 --> C2
    C1 --> D2
    C2 --> D1
    C3 --> D4
    C4 --> D5
    D1 --> D3
```

**åˆ†å±‚å®ç°ç­–ç•¥**:

```java
// æ•°æ®è®¿é—®è·¯ç”±é…ç½®
@Configuration
public class DataRoutingConfig {
    
    @Bean
    @Primary
    public DataSource masterDataSource() {
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setJdbcUrl("jdbc:mysql://mysql-master:3306/spring4demo");
        dataSource.setUsername("spring4demo");
        dataSource.setPassword("password");
        dataSource.setDriverClassName("com.mysql.cj.jdbc.Driver");
        
        // è¿æ¥æ± é…ç½®
        dataSource.setMaximumPoolSize(20);
        dataSource.setMinimumIdle(5);
        dataSource.setIdleTimeout(300000);
        dataSource.setMaxLifetime(1200000);
        dataSource.setConnectionTimeout(20000);
        
        return dataSource;
    }
    
    @Bean
    public DataSource slaveDataSource() {
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setJdbcUrl("jdbc:mysql://mysql-slave:3306/spring4demo");
        dataSource.setUsername("spring4demo");
        dataSource.setPassword("password");
        dataSource.setDriverClassName("com.mysql.cj.jdbc.Driver");
        
        dataSource.setMaximumPoolSize(20);
        dataSource.setMinimumIdle(5);
        dataSource.setIdleTimeout(300000);
        dataSource.setMaxLifetime(1200000);
        dataSource.setConnectionTimeout(20000);
        
        return dataSource;
    }
    
    @Bean
    public DataSource routingDataSource() {
        RoutingDataSource routingDataSource = new RoutingDataSource();
        Map<Object, Object> dataSourceMap = new HashMap<>();
        dataSourceMap.put("master", masterDataSource());
        dataSourceMap.put("slave", slaveDataSource());
        routingDataSource.setTargetDataSources(dataSourceMap);
        routingDataSource.setDefaultTargetDataSource(masterDataSource());
        return routingDataSource;
    }
}

// è¯»å†™åˆ†ç¦»æ³¨è§£
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface ReadOnly {
}

// è¯»å†™åˆ†ç¦»AOP
@Aspect
@Component
public class DataSourceAspect {
    
    @Before("@annotation(readOnly)")
    public void setReadDataSource(ReadOnly readOnly) {
        DataSourceContextHolder.setDataSource("slave");
    }
    
    @Before("@annotation(org.springframework.transaction.annotation.Transactional)")
    public void setWriteDataSource(Transactional transactional) {
        if (!transactional.readOnly()) {
            DataSourceContextHolder.setDataSource("master");
        }
    }
    
    @After("@annotation(ReadOnly) || @annotation(org.springframework.transaction.annotation.Transactional)")
    public void clearDataSource() {
        DataSourceContextHolder.clearDataSource();
    }
}

// æ•°æ®æºä¸Šä¸‹æ–‡
public class DataSourceContextHolder {
    private static final ThreadLocal<String> contextHolder = new ThreadLocal<>();
    
    public static void setDataSource(String dataSourceType) {
        contextHolder.set(dataSourceType);
    }
    
    public static String getDataSource() {
        return contextHolder.get();
    }
    
    public static void clearDataSource() {
        contextHolder.remove();
    }
}
```

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. MySQLæ•°æ®åº“è®¾è®¡

#### 1.1 ç”¨æˆ·æƒé™è¡¨è®¾è®¡

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE sys_user (
    id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰',
    username VARCHAR(50) UNIQUE NOT NULL COMMENT 'ç”¨æˆ·å',
    email VARCHAR(100) UNIQUE NOT NULL COMMENT 'é‚®ç®±',
    password VARCHAR(255) NOT NULL COMMENT 'å¯†ç ',
    real_name VARCHAR(100) COMMENT 'çœŸå®å§“å',
    phone_number VARCHAR(20) COMMENT 'æ‰‹æœºå·',
    avatar_url VARCHAR(255) COMMENT 'å¤´åƒURL',
    status INT DEFAULT 1 COMMENT 'ç”¨æˆ·çŠ¶æ€ï¼ˆ1-å¯ç”¨ï¼Œ0-ç¦ç”¨ï¼‰',
    last_login_time TIMESTAMP NULL COMMENT 'æœ€åç™»å½•æ—¶é—´',
    last_login_ip VARCHAR(45) COMMENT 'æœ€åç™»å½•IP',
    login_count INT DEFAULT 0 COMMENT 'ç™»å½•æ¬¡æ•°',
    email_verified BOOLEAN DEFAULT FALSE COMMENT 'é‚®ç®±æ˜¯å¦éªŒè¯',
    phone_verified BOOLEAN DEFAULT FALSE COMMENT 'æ‰‹æœºæ˜¯å¦éªŒè¯',
    tenant_id BIGINT COMMENT 'ç§Ÿæˆ·ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    created_by BIGINT COMMENT 'åˆ›å»ºäºº',
    updated_by BIGINT COMMENT 'æ›´æ–°äºº',

    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_status (status),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç”¨æˆ·è¡¨';

-- è§’è‰²è¡¨
CREATE TABLE roles (
    id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰',
    name VARCHAR(50) UNIQUE NOT NULL COMMENT 'è§’è‰²åç§°',
    description VARCHAR(255) COMMENT 'è§’è‰²æè¿°',
    role_type ENUM('SYSTEM', 'BUSINESS', 'CUSTOM') DEFAULT 'CUSTOM' COMMENT 'è§’è‰²ç±»å‹',
    is_system BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ç³»ç»Ÿè§’è‰²',
    sort_order INT DEFAULT 0 COMMENT 'æ’åº',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE' COMMENT 'çŠ¶æ€',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    
    INDEX idx_name (name),
    INDEX idx_role_type (role_type),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è§’è‰²è¡¨';

-- æƒé™è¡¨
CREATE TABLE permissions (
    id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰',
    name VARCHAR(100) UNIQUE NOT NULL COMMENT 'æƒé™åç§°',
    resource VARCHAR(100) NOT NULL COMMENT 'èµ„æº',
    action VARCHAR(50) NOT NULL COMMENT 'æ“ä½œ',
    description VARCHAR(255) COMMENT 'æƒé™æè¿°',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    
    INDEX idx_resource (resource),
    INDEX idx_action (action),
    INDEX idx_name (name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æƒé™è¡¨';

-- ç”¨æˆ·è§’è‰²å…³è”è¡¨
CREATE TABLE user_roles (
    id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    role_id BIGINT NOT NULL COMMENT 'è§’è‰²ID',
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ†é…æ—¶é—´',
    assigned_by BIGINT COMMENT 'åˆ†é…äºº',

    FOREIGN KEY (user_id) REFERENCES sys_user(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_role (user_id, role_id),
    INDEX idx_user_id (user_id),
    INDEX idx_role_id (role_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç”¨æˆ·è§’è‰²å…³è”è¡¨';

-- è§’è‰²æƒé™å…³è”è¡¨
CREATE TABLE role_permissions (
    id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰',
    role_id BIGINT NOT NULL COMMENT 'è§’è‰²ID',
    permission_id BIGINT NOT NULL COMMENT 'æƒé™ID',
    granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'æˆæƒæ—¶é—´',
    granted_by BIGINT COMMENT 'æˆæƒäºº',
    
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE,
    UNIQUE KEY uk_role_permission (role_id, permission_id),
    INDEX idx_role_id (role_id),
    INDEX idx_permission_id (permission_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è§’è‰²æƒé™å…³è”è¡¨';
```

#### 1.2 å†…å®¹ç®¡ç†è¡¨è®¾è®¡

```sql
-- æ–‡æ¡£è¡¨
CREATE TABLE documents (
    id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰',
    title VARCHAR(255) NOT NULL COMMENT 'æ ‡é¢˜',
    content LONGTEXT COMMENT 'å†…å®¹',
    category_id BIGINT COMMENT 'åˆ†ç±»ID',
    author_id BIGINT NOT NULL COMMENT 'ä½œè€…ID',
    status ENUM('DRAFT', 'PUBLISHED', 'ARCHIVED', 'DELETED') DEFAULT 'DRAFT' COMMENT 'çŠ¶æ€',
    version INT DEFAULT 1 COMMENT 'ç‰ˆæœ¬å·',
    access_level ENUM('PUBLIC', 'PRIVATE', 'RESTRICTED') DEFAULT 'PUBLIC' COMMENT 'è®¿é—®çº§åˆ«',
    view_count INT DEFAULT 0 COMMENT 'æŸ¥çœ‹æ¬¡æ•°',
    like_count INT DEFAULT 0 COMMENT 'ç‚¹èµæ¬¡æ•°',
    published_at TIMESTAMP NULL COMMENT 'å‘å¸ƒæ—¶é—´',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    created_by BIGINT COMMENT 'åˆ›å»ºäºº',
    updated_by BIGINT COMMENT 'æ›´æ–°äºº',
    
    FOREIGN KEY (category_id) REFERENCES categories(id),
    FOREIGN KEY (author_id) REFERENCES users(id),
    INDEX idx_title (title),
    INDEX idx_category_id (category_id),
    INDEX idx_author_id (author_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    INDEX idx_published_at (published_at),
    FULLTEXT KEY ft_title_content (title, content)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æ–‡æ¡£è¡¨';

-- åˆ†ç±»è¡¨
CREATE TABLE categories (
    id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰',
    name VARCHAR(100) NOT NULL COMMENT 'åˆ†ç±»åç§°',
    parent_id BIGINT COMMENT 'çˆ¶åˆ†ç±»ID',
    description TEXT COMMENT 'æè¿°',
    sort_order INT DEFAULT 0 COMMENT 'æ’åº',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE' COMMENT 'çŠ¶æ€',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    
    FOREIGN KEY (parent_id) REFERENCES categories(id),
    INDEX idx_parent_id (parent_id),
    INDEX idx_name (name),
    INDEX idx_status (status),
    INDEX idx_sort_order (sort_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='åˆ†ç±»è¡¨';

-- æ ‡ç­¾è¡¨
CREATE TABLE tags (
    id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰',
    name VARCHAR(50) UNIQUE NOT NULL COMMENT 'æ ‡ç­¾åç§°',
    color VARCHAR(7) DEFAULT '#1890ff' COMMENT 'é¢œè‰²',
    description VARCHAR(255) COMMENT 'æè¿°',
    usage_count INT DEFAULT 0 COMMENT 'ä½¿ç”¨æ¬¡æ•°',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    
    INDEX idx_name (name),
    INDEX idx_usage_count (usage_count)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æ ‡ç­¾è¡¨';

-- æ–‡æ¡£æ ‡ç­¾å…³è”è¡¨
CREATE TABLE document_tags (
    id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰',
    document_id BIGINT NOT NULL COMMENT 'æ–‡æ¡£ID',
    tag_id BIGINT NOT NULL COMMENT 'æ ‡ç­¾ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    
    FOREIGN KEY (document_id) REFERENCES documents(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE,
    UNIQUE KEY uk_document_tag (document_id, tag_id),
    INDEX idx_document_id (document_id),
    INDEX idx_tag_id (tag_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æ–‡æ¡£æ ‡ç­¾å…³è”è¡¨';
```

#### 1.3 å·¥ä½œæµè¡¨è®¾è®¡

```sql
-- æµç¨‹å®šä¹‰è¡¨
CREATE TABLE process_definitions (
    id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰',
    name VARCHAR(255) NOT NULL COMMENT 'æµç¨‹åç§°',
    key VARCHAR(255) UNIQUE NOT NULL COMMENT 'æµç¨‹é”®',
    version INT DEFAULT 1 COMMENT 'ç‰ˆæœ¬',
    description TEXT COMMENT 'æè¿°',
    bpmn_xml LONGTEXT NOT NULL COMMENT 'BPMN XML',
    svg_data LONGTEXT COMMENT 'SVGæ•°æ®',
    status ENUM('ACTIVE', 'INACTIVE', 'DEPRECATED') DEFAULT 'ACTIVE' COMMENT 'çŠ¶æ€',
    is_latest BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦æœ€æ–°ç‰ˆæœ¬',
    created_by BIGINT NOT NULL COMMENT 'åˆ›å»ºäºº',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    
    INDEX idx_key (key),
    INDEX idx_version (version),
    INDEX idx_status (status),
    INDEX idx_created_by (created_by)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æµç¨‹å®šä¹‰è¡¨';

-- æµç¨‹å®ä¾‹è¡¨
CREATE TABLE process_instances (
    id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰',
    process_instance_id VARCHAR(64) UNIQUE NOT NULL COMMENT 'æµç¨‹å®ä¾‹ID',
    process_definition_id BIGINT NOT NULL COMMENT 'æµç¨‹å®šä¹‰ID',
    process_definition_key VARCHAR(255) NOT NULL COMMENT 'æµç¨‹é”®',
    business_key VARCHAR(255) COMMENT 'ä¸šåŠ¡é”®',
    status ENUM('RUNNING', 'COMPLETED', 'SUSPENDED', 'TERMINATED') DEFAULT 'RUNNING' COMMENT 'çŠ¶æ€',
    started_by BIGINT NOT NULL COMMENT 'å¯åŠ¨äºº',
    start_time TIMESTAMP NOT NULL COMMENT 'å¼€å§‹æ—¶é—´',
    end_time TIMESTAMP NULL COMMENT 'ç»“æŸæ—¶é—´',
    duration BIGINT COMMENT 'æŒç»­æ—¶é—´(æ¯«ç§’)',
    variables JSON COMMENT 'æµç¨‹å˜é‡',
    
    FOREIGN KEY (process_definition_id) REFERENCES process_definitions(id),
    FOREIGN KEY (started_by) REFERENCES users(id),
    INDEX idx_process_instance_id (process_instance_id),
    INDEX idx_process_definition_key (process_definition_key),
    INDEX idx_business_key (business_key),
    INDEX idx_status (status),
    INDEX idx_started_by (started_by),
    INDEX idx_start_time (start_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æµç¨‹å®ä¾‹è¡¨';

-- ä»»åŠ¡å®ä¾‹è¡¨
CREATE TABLE task_instances (
    id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰',
    task_id VARCHAR(64) UNIQUE NOT NULL COMMENT 'ä»»åŠ¡ID',
    process_instance_id VARCHAR(64) NOT NULL COMMENT 'æµç¨‹å®ä¾‹ID',
    name VARCHAR(255) NOT NULL COMMENT 'ä»»åŠ¡åç§°',
    description TEXT COMMENT 'æè¿°',
    assignee BIGINT COMMENT 'åˆ†é…äºº',
    candidate_groups JSON COMMENT 'å€™é€‰ç»„',
    priority INT DEFAULT 50 COMMENT 'ä¼˜å…ˆçº§',
    status ENUM('ACTIVE', 'COMPLETED', 'CANCELLED') DEFAULT 'ACTIVE' COMMENT 'çŠ¶æ€',
    create_time TIMESTAMP NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
    due_time TIMESTAMP NULL COMMENT 'åˆ°æœŸæ—¶é—´',
    completion_time TIMESTAMP NULL COMMENT 'å®Œæˆæ—¶é—´',
    variables JSON COMMENT 'ä»»åŠ¡å˜é‡',
    
    FOREIGN KEY (assignee) REFERENCES users(id),
    INDEX idx_task_id (task_id),
    INDEX idx_process_instance_id (process_instance_id),
    INDEX idx_assignee (assignee),
    INDEX idx_status (status),
    INDEX idx_create_time (create_time),
    INDEX idx_due_time (due_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ä»»åŠ¡å®ä¾‹è¡¨';
```

### 2. MongoDBé›†åˆè®¾è®¡

#### 2.1 æ–‡æ¡£ç‰ˆæœ¬é›†åˆ

```javascript
// æ–‡æ¡£ç‰ˆæœ¬é›†åˆ
db.createCollection("document_versions", {
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["documentId", "version", "content", "authorId", "createdAt"],
      properties: {
        documentId: {
          bsonType: "long",
          description: "æ–‡æ¡£ID"
        },
        version: {
          bsonType: "int",
          minimum: 1,
          description: "ç‰ˆæœ¬å·"
        },
        title: {
          bsonType: "string",
          description: "æ ‡é¢˜"
        },
        content: {
          bsonType: "string",
          description: "å†…å®¹"
        },
        authorId: {
          bsonType: "long",
          description: "ä½œè€…ID"
        },
        changeDescription: {
          bsonType: "string",
          description: "å˜æ›´æè¿°"
        },
        tags: {
          bsonType: "array",
          items: {
            bsonType: "string"
          },
          description: "æ ‡ç­¾"
        },
        metadata: {
          bsonType: "object",
          description: "å…ƒæ•°æ®"
        },
        createdAt: {
          bsonType: "date",
          description: "åˆ›å»ºæ—¶é—´"
        },
        fileSize: {
          bsonType: "long",
          description: "æ–‡ä»¶å¤§å°"
        },
        checksum: {
          bsonType: "string",
          description: "æ ¡éªŒå’Œ"
        }
      }
    }
  }
});

// åˆ›å»ºç´¢å¼•
db.document_versions.createIndex({ "documentId": 1, "version": -1 });
db.document_versions.createIndex({ "authorId": 1 });
db.document_versions.createIndex({ "createdAt": -1 });

// ç¤ºä¾‹æ–‡æ¡£
db.document_versions.insertOne({
  documentId: NumberLong(1),
  version: 1,
  title: "Spring Bootæœ€ä½³å®è·µ",
  content: "Spring Bootæ˜¯ä¸€ä¸ªå¿«é€Ÿå¼€å‘æ¡†æ¶...",
  authorId: NumberLong(1001),
  changeDescription: "åˆå§‹ç‰ˆæœ¬",
  tags: ["Spring Boot", "Java", "æœ€ä½³å®è·µ"],
  metadata: {
    wordCount: 2500,
    readingTime: 10,
    difficulty: "intermediate"
  },
  createdAt: new Date(),
  fileSize: NumberLong(15360),
  checksum: "sha256:abc123..."
});
```

#### 2.2 ç³»ç»Ÿæ—¥å¿—é›†åˆ

```javascript
// ç³»ç»Ÿæ—¥å¿—é›†åˆ
db.createCollection("system_logs", {
  capped: true,
  size: 1073741824, // 1GB
  max: 1000000
});

// åˆ›å»ºç´¢å¼•
db.system_logs.createIndex({ "timestamp": -1 });
db.system_logs.createIndex({ "level": 1 });
db.system_logs.createIndex({ "userId": 1 });
db.system_logs.createIndex({ "module": 1 });
db.system_logs.createIndex({ "action": 1 });

// ç¤ºä¾‹æ—¥å¿—
db.system_logs.insertOne({
  timestamp: new Date(),
  level: "INFO",
  message: "ç”¨æˆ·ç™»å½•æˆåŠŸ",
  userId: NumberLong(1001),
  username: "admin",
  module: "auth",
  action: "login",
  ip: "192.168.1.100",
  userAgent: "Mozilla/5.0...",
  sessionId: "sess_abc123",
  requestId: "req_xyz789",
  duration: NumberLong(150),
  metadata: {
    loginMethod: "password",
    mfaVerified: true
  }
});
```

### 3. Redisæ•°æ®ç»“æ„è®¾è®¡

#### 3.1 ç¼“å­˜é”®å‘½åè§„èŒƒ

```yaml
# ç¼“å­˜é”®å‘½åè§„èŒƒ
cache_keys:
  user:
    profile: "user:profile:{userId}"
    permissions: "user:permissions:{userId}"
    sessions: "user:sessions:{userId}"
    
  document:
    detail: "document:detail:{documentId}"
    list: "document:list:{hash}"
    search: "document:search:{query_hash}"
    
  workflow:
    instances: "workflow:instances:{userId}"
    tasks: "workflow:tasks:{userId}"
    
  system:
    config: "system:config:{key}"
    metrics: "system:metrics:{timestamp}"
```

#### 3.2 Redisæ•°æ®æ“ä½œå®ç°

```java
@Service
public class CacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private UserMapper userMapper;
    
    /**
     * ç¼“å­˜ç”¨æˆ·ä¿¡æ¯
     */
    @Cacheable(value = "users", key = "#userId", unless = "#result == null")
    public UserDTO getUserProfile(Long userId) {
        User user = userMapper.selectById(userId);
        return user != null ? UserMapper.toDTO(user) : null;
    }
    
    /**
     * ç¼“å­˜ç”¨æˆ·æƒé™
     */
    public Set<String> getUserPermissions(Long userId) {
        String cacheKey = "user:permissions:" + userId;
        
        // å°è¯•ä»ç¼“å­˜è·å–
        Set<String> permissions = (Set<String>) redisTemplate.opsForValue().get(cacheKey);
        
        if (permissions == null) {
            // ä»æ•°æ®åº“åŠ è½½
            permissions = userMapper.selectPermissionsByUserId(userId);
            
            // ç¼“å­˜30åˆ†é’Ÿ
            redisTemplate.opsForValue().set(cacheKey, permissions, Duration.ofMinutes(30));
        }
        
        return permissions;
    }
    
    /**
     * æ¸…é™¤ç”¨æˆ·æƒé™ç¼“å­˜
     */
    public void clearUserPermissions(Long userId) {
        String cacheKey = "user:permissions:" + userId;
        redisTemplate.delete(cacheKey);
    }
    
    /**
     * ç¼“å­˜æ–‡æ¡£è¯¦æƒ…
     */
    public void cacheDocumentDetail(Long documentId, DocumentDTO document) {
        String cacheKey = "document:detail:" + documentId;
        
        // ç¼“å­˜2å°æ—¶
        redisTemplate.opsForValue().set(cacheKey, document, Duration.ofHours(2));
        
        // åŒæ—¶æ·»åŠ åˆ°æ–‡æ¡£åˆ—è¡¨ç¼“å­˜
        String listKey = "document:list:recent";
        redisTemplate.opsForZSet().add(listKey, documentId, System.currentTimeMillis());
        
        // ä¿æŒæœ€è¿‘100ä¸ªæ–‡æ¡£
        redisTemplate.opsForZSet().removeRange(listKey, 0, -101);
    }
    
    /**
     * è·å–ç¼“å­˜çš„æ–‡æ¡£è¯¦æƒ…
     */
    public DocumentDTO getCachedDocumentDetail(Long documentId) {
        String cacheKey = "document:detail:" + documentId;
        return (DocumentDTO) redisTemplate.opsForValue().get(cacheKey);
    }
    
    /**
     * å®ç°åˆ†å¸ƒå¼é”
     */
    public boolean tryLock(String lockKey, String requestId, long expireTime) {
        return redisTemplate.opsForValue().setIfAbsent(
            lockKey, 
            requestId, 
            Duration.ofMillis(expireTime)
        );
    }
    
    /**
     * é‡Šæ”¾åˆ†å¸ƒå¼é”
     */
    public boolean releaseLock(String lockKey, String requestId) {
        String script = "if redis.call('get', KEYS[1]) == ARGV[1] " +
                       "then return redis.call('del', KEYS[1]) " +
                       "else return 0 end";
        
        Long result = redisTemplate.execute(
            new DefaultRedisScript<>(script, Long.class),
            Collections.singletonList(lockKey),
            requestId
        );
        
        return result != null && result == 1;
    }
    
    /**
     * å®ç°é™æµ
     */
    public boolean isAllowed(String key, int limit, int window) {
        String luaScript = "local current = redis.call('get', KEYS[1]) " +
                          "if current and tonumber(current) > tonumber(ARGV[1]) " +
                          "then return 0 " +
                          "end " +
                          "redis.call('incr', KEYS[1]) " +
                          "if tonumber(redis.call('get', KEYS[1])) == 1 " +
                          "then redis.call('expire', KEYS[1], ARGV[2]) " +
                          "end " +
                          "return 1";
        
        Long result = redisTemplate.execute(
            new DefaultRedisScript<>(luaScript, Long.class),
            Collections.singletonList(key),
            String.valueOf(limit),
            String.valueOf(window)
        );
        
        return result != null && result == 1;
    }
}
```

## ğŸ” æœç´¢å¼•æ“è®¾è®¡

### 1. Elasticsearchç´¢å¼•è®¾è®¡

#### 1.1 æ–‡æ¡£ç´¢å¼•æ˜ å°„

```json
{
  "mappings": {
    "properties": {
      "id": {
        "type": "long"
      },
      "title": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart",
        "fields": {
          "keyword": {
            "type": "keyword",
            "ignore_above": 256
          }
        }
      },
      "content": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart"
      },
      "summary": {
        "type": "text",
        "analyzer": "ik_max_word"
      },
      "author": {
        "type": "object",
        "properties": {
          "id": {
            "type": "long"
          },
          "username": {
            "type": "keyword"
          },
          "displayName": {
            "type": "text",
            "analyzer": "ik_max_word"
          }
        }
      },
      "category": {
        "type": "object",
        "properties": {
          "id": {
            "type": "long"
          },
          "name": {
            "type": "keyword"
          },
          "path": {
            "type": "keyword"
          }
        }
      },
      "tags": {
        "type": "keyword"
      },
      "status": {
        "type": "keyword"
      },
      "accessLevel": {
        "type": "keyword"
      },
      "viewCount": {
        "type": "long"
      },
      "likeCount": {
        "type": "long"
      },
      "createdAt": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"
      },
      "updatedAt": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"
      },
      "publishedAt": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"
      },
      "metadata": {
        "type": "object",
        "properties": {
          "wordCount": {
            "type": "integer"
          },
          "readingTime": {
            "type": "integer"
          },
          "difficulty": {
            "type": "keyword"
          }
        }
      },
      "attachments": {
        "type": "nested",
        "properties": {
          "name": {
            "type": "text",
            "analyzer": "ik_max_word"
          },
          "type": {
            "type": "keyword"
          },
          "size": {
            "type": "long"
          },
          "url": {
            "type": "keyword"
          }
        }
      }
    }
  },
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1,
    "analysis": {
      "analyzer": {
        "ik_max_word": {
          "type": "ik_max_word"
        },
        "ik_smart": {
          "type": "ik_smart"
        }
      }
    }
  }
}
```

#### 1.2 æœç´¢æœåŠ¡å®ç°

```java
@Service
public class DocumentSearchService {
    
    @Autowired
    private ElasticsearchOperations elasticsearchOperations;
    
    @Autowired
    private DocumentRepository documentRepository;
    
    /**
     * åˆ›å»ºæ–‡æ¡£ç´¢å¼•
     */
    public void indexDocument(Document document) {
        DocumentDocument documentDocument = DocumentMapper.toDocument(document);
        
        IndexQuery indexQuery = new IndexQueryBuilder()
            .withId(document.getId().toString())
            .withObject(documentDocument)
            .build();
        
        elasticsearchOperations.index(indexQuery);
    }
    
    /**
     * æ‰¹é‡ç´¢å¼•æ–‡æ¡£
     */
    public void indexDocuments(List<Document> documents) {
        List<IndexQuery> indexQueries = documents.stream()
            .map(doc -> {
                DocumentDocument doc = DocumentMapper.toDocument(doc);
                return new IndexQueryBuilder()
                    .withId(doc.getId().toString())
                    .withObject(doc)
                    .build();
            })
            .collect(Collectors.toList());
        
        elasticsearchOperations.bulkIndex(indexQueries);
    }
    
    /**
     * æœç´¢æ–‡æ¡£
     */
    public SearchResult<DocumentDTO> searchDocuments(DocumentSearchRequest request) {
        // 1. æ„å»ºæŸ¥è¯¢æ¡ä»¶
        BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();
        
        // å…³é”®è¯æœç´¢
        if (StringUtils.hasText(request.getKeyword())) {
            MultiMatchQueryBuilder multiMatchQuery = QueryBuilders.multiMatchQuery(request.getKeyword())
                .field("title", 2.0f)
                .field("content", 1.0f)
                .field("summary", 1.5f)
                .field("author.displayName", 1.2f)
                .type(MultiMatchQueryBuilder.Type.BEST_FIELDS)
                .fuzziness("AUTO");
            
            boolQuery.must(multiMatchQuery);
        }
        
        // åˆ†ç±»è¿‡æ»¤
        if (request.getCategoryIds() != null && !request.getCategoryIds().isEmpty()) {
            boolQuery.filter(QueryBuilders.termsQuery("category.id", request.getCategoryIds()));
        }
        
        // æ ‡ç­¾è¿‡æ»¤
        if (request.getTags() != null && !request.getTags().isEmpty()) {
            boolQuery.filter(QueryBuilders.termsQuery("tags", request.getTags()));
        }
        
        // çŠ¶æ€è¿‡æ»¤
        if (request.getStatus() != null) {
            boolQuery.filter(QueryBuilders.termQuery("status", request.getStatus().name()));
        }
        
        // ä½œè€…è¿‡æ»¤
        if (request.getAuthorIds() != null && !request.getAuthorIds().isEmpty()) {
            boolQuery.filter(QueryBuilders.termsQuery("author.id", request.getAuthorIds()));
        }
        
        // æ—¶é—´èŒƒå›´è¿‡æ»¤
        if (request.getStartDate() != null || request.getEndDate() != null) {
            RangeQueryBuilder rangeQuery = QueryBuilders.rangeQuery("createdAt");
            
            if (request.getStartDate() != null) {
                rangeQuery.gte(request.getStartDate());
            }
            
            if (request.getEndDate() != null) {
                rangeQuery.lte(request.getEndDate());
            }
            
            boolQuery.filter(rangeQuery);
        }
        
        // 2. æ„å»ºæ’åº
        List<SortBuilder<?>> sorts = new ArrayList<>();
        
        if ("relevance".equals(request.getSortBy())) {
            sorts.add(ScoreSortBuilder.DESC);
        } else if ("date".equals(request.getSortBy())) {
            sorts.add(FieldSortBuilder.DESC.field("createdAt"));
        } else if ("title".equals(request.getSortBy())) {
            sorts.add(FieldSortBuilder.ASC.field("title.keyword"));
        } else if ("views".equals(request.getSortBy())) {
            sorts.add(FieldSortBuilder.DESC.field("viewCount"));
        }
        
        // 3. æ„å»ºé«˜äº®
        HighlightBuilder highlightBuilder = new HighlightBuilder()
            .field("title")
            .field("content")
            .field("summary")
            .fragmentSize(150)
            .numOfFragments(3)
            .preTags("<em>")
            .postTags("</em>");
        
        // 4. æ„å»ºèšåˆ
        Aggregations aggregations = null;
        
        if (request.isIncludeAggregations()) {
            aggregations = buildAggregations();
        }
        
        // 5. æ‰§è¡Œæœç´¢
        NativeSearchQuery searchQuery = new NativeSearchQueryBuilder()
            .withQuery(boolQuery)
            .withSorts(sorts)
            .withHighlightBuilder(highlightBuilder)
            .withPageable(PageRequest.of(request.getPage(), request.getSize()))
            .build();
        
        if (aggregations != null) {
            searchQuery.setAggregations(aggregations);
        }
        
        SearchHits<DocumentDocument> searchHits = elasticsearchOperations.search(searchQuery, DocumentDocument.class);
        
        // 6. è½¬æ¢ç»“æœ
        List<DocumentDTO> documents = searchHits.getSearchHits().stream()
            .map(hit -> {
                DocumentDocument doc = hit.getContent();
                DocumentDTO dto = DocumentMapper.toDTO(doc);
                
                // è®¾ç½®é«˜äº®ç‰‡æ®µ
                if (hit.getHighlightFields().containsKey("title")) {
                    dto.setHighlightedTitle(hit.getHighlightFields().get("title").getFragments()[0].string());
                }
                if (hit.getHighlightFields().containsKey("content")) {
                    dto.setHighlightedContent(hit.getHighlightFields().get("content").getFragments()[0].string());
                }
                
                // è®¾ç½®æœç´¢åˆ†æ•°
                dto.setScore(hit.getScore());
                
                return dto;
            })
            .collect(Collectors.toList());
        
        // 7. å¤„ç†èšåˆç»“æœ
        Map<String, Object> aggregationResults = new HashMap<>();
        if (request.isIncludeAggregations() && searchHits.hasAggregations()) {
            aggregationResults = processAggregations(searchHits.getAggregations());
        }
        
        return SearchResult.<DocumentDTO>builder()
            .content(documents)
            .totalElements(searchHits.getTotalHits())
            .totalPages((int) Math.ceil((double) searchHits.getTotalHits() / request.getSize()))
            .currentPage(request.getPage())
            .aggregations(aggregationResults)
            .build();
    }
    
    /**
     * æ„å»ºèšåˆæŸ¥è¯¢
     */
    private Aggregations buildAggregations() {
        AggregationBuilder categoryAggregation = AggregationBuilders.terms("categories")
            .field("category.name")
            .size(20);
        
        AggregationBuilder tagAggregation = AggregationBuilders.terms("tags")
            .field("tags")
            .size(20);
        
        AggregationBuilder authorAggregation = AggregationBuilders.terms("authors")
            .field("author.username")
            .size(20);
        
        AggregationBuilder dateHistogram = AggregationBuilders.dateHistogram("dateHistogram")
            .field("createdAt")
            .calendarInterval(DateHistogramInterval.MONTH)
            .format("yyyy-MM");
        
        return Aggregations.from(Arrays.asList(
            categoryAggregation,
            tagAggregation,
            authorAggregation,
            dateHistogram
        ));
    }
    
    /**
     * å¤„ç†èšåˆç»“æœ
     */
    private Map<String, Object> processAggregations(Aggregations aggregations) {
        Map<String, Object> results = new HashMap<>();
        
        // åˆ†ç±»èšåˆ
        Terms categoryTerms = aggregations.get("categories");
        List<Map<String, Object>> categories = categoryTerms.getBuckets().stream()
            .map(bucket -> {
                Map<String, Object> category = new HashMap<>();
                category.put("name", bucket.getKeyAsString());
                category.put("count", bucket.getDocCount());
                return category;
            })
            .collect(Collectors.toList());
        results.put("categories", categories);
        
        // æ ‡ç­¾èšåˆ
        Terms tagTerms = aggregations.get("tags");
        List<Map<String, Object>> tags = tagTerms.getBuckets().stream()
            .map(bucket -> {
                Map<String, Object> tag = new HashMap<>();
                tag.put("name", bucket.getKeyAsString());
                tag.put("count", bucket.getDocCount());
                return tag;
            })
            .collect(Collectors.toList());
        results.put("tags", tags);
        
        // ä½œè€…èšåˆ
        Terms authorTerms = aggregations.get("authors");
        List<Map<String, Object>> authors = authorTerms.getBuckets().stream()
            .map(bucket -> {
                Map<String, Object> author = new HashMap<>();
                author.put("name", bucket.getKeyAsString());
                author.put("count", bucket.getDocCount());
                return author;
            })
            .collect(Collectors.toList());
        results.put("authors", authors);
        
        // æ—¥æœŸç›´æ–¹å›¾
        ParsedDateHistogram dateHistogram = aggregations.get("dateHistogram");
        List<Map<String, Object>> dateBuckets = dateHistogram.getBuckets().stream()
            .map(bucket -> {
                Map<String, Object> dateBucket = new HashMap<>();
                dateBucket.put("date", bucket.getKeyAsString());
                dateBucket.put("count", bucket.getDocCount());
                return dateBucket;
            })
            .collect(Collectors.toList());
        results.put("dateHistogram", dateBuckets);
        
        return results;
    }
}
```

## ğŸ“Š æ•°æ®åŒæ­¥ä¸è¿ç§»

### 1. æ•°æ®åŒæ­¥ç­–ç•¥

#### 1.1 MySQLåˆ°MongoDBåŒæ­¥

```java
@Service
public class DataSyncService {
    
    @Autowired
    private DocumentRepository documentRepository;
    
    @Autowired
    private MongoTemplate mongoTemplate;
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    /**
     * åŒæ­¥æ–‡æ¡£åˆ°MongoDB
     */
    @EventListener
    @Async
    public void syncDocumentToMongoDB(DocumentCreatedEvent event) {
        try {
            Document document = documentRepository.findById(event.getDocumentId())
                .orElseThrow(() -> new DocumentNotFoundException("æ–‡æ¡£ä¸å­˜åœ¨"));
            
            // è½¬æ¢ä¸ºMongoDBæ–‡æ¡£
            DocumentDocument mongoDocument = DocumentMapper.toMongoDocument(document);
            
            // ä¿å­˜åˆ°MongoDB
            mongoTemplate.save(mongoDocument, "documents");
            
            log.info("Document {} synced to MongoDB", document.getId());
        } catch (Exception e) {
            log.error("Failed to sync document {} to MongoDB", event.getDocumentId(), e);
            
            // å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
            rabbitTemplate.convertAndSend("sync.dlx", "document.sync.failed", event);
        }
    }
    
    /**
     * æ‰¹é‡åŒæ­¥å†å²æ•°æ®
     */
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    public void syncHistoricalData() {
        int batchSize = 100;
        int page = 0;
        boolean hasMore = true;
        
        while (hasMore) {
            Pageable pageable = PageRequest.of(page, batchSize);
            Page<Document> documents = documentRepository.findAll(pageable);
            
            if (documents.hasContent()) {
                List<DocumentDocument> mongoDocuments = documents.getContent().stream()
                    .map(DocumentMapper::toMongoDocument)
                    .collect(Collectors.toList());
                
                // æ‰¹é‡æ’å…¥MongoDB
                mongoTemplate.insertAll(mongoDocuments);
                
                log.info("Synced {} documents to MongoDB", mongoDocuments.size());
            } else {
                hasMore = false;
            }
            
            page++;
        }
    }
}
```

#### 1.2 å¢é‡æ•°æ®åŒæ­¥

```java
@Component
public class IncrementalSyncService {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    @Autowired
    private MongoTemplate mongoTemplate;
    
    @Value("${sync.batch.size:1000}")
    private int batchSize;
    
    /**
     * åŸºäºæ—¶é—´æˆ³çš„å¢é‡åŒæ­¥
     */
    @Scheduled(fixedDelay = 60000) // æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void incrementalSync() {
        // è·å–ä¸Šæ¬¡åŒæ­¥æ—¶é—´æˆ³
        LocalDateTime lastSyncTime = getLastSyncTime();
        
        // æŸ¥è¯¢å¢é‡æ•°æ®
        List<Map<String, Object>> changes = queryIncrementalChanges(lastSyncTime);
        
        if (!changes.isEmpty()) {
            // å¤„ç†å¢é‡æ•°æ®
            processIncrementalChanges(changes);
            
            // æ›´æ–°åŒæ­¥æ—¶é—´æˆ³
            updateLastSyncTime(LocalDateTime.now());
        }
    }
    
    private List<Map<String, Object>> queryIncrementalChanges(LocalDateTime lastSyncTime) {
        String sql = "SELECT * FROM document_changes WHERE changed_at > ? ORDER BY changed_at LIMIT ?";
        
        return jdbcTemplate.queryForList(sql, lastSyncTime, batchSize);
    }
    
    private void processIncrementalChanges(List<Map<String, Object>> changes) {
        for (Map<String, Object> change : changes) {
            String operation = (String) change.get("operation");
            Long documentId = ((Number) change.get("document_id")).longValue();
            
            switch (operation) {
                case "INSERT":
                case "UPDATE":
                    syncDocument(documentId);
                    break;
                case "DELETE":
                    deleteDocument(documentId);
                    break;
            }
        }
    }
    
    private void syncDocument(Long documentId) {
        Document document = documentRepository.findById(documentId).orElse(null);
        if (document != null) {
            DocumentDocument mongoDocument = DocumentMapper.toMongoDocument(document);
            mongoTemplate.save(mongoDocument, "documents");
        }
    }
    
    private void deleteDocument(Long documentId) {
        mongoTemplate.remove(
            Query.query(Criteria.where("id").is(documentId)), 
            "documents"
        );
    }
    
    private LocalDateTime getLastSyncTime() {
        // ä»Redisæˆ–é…ç½®ä¸­è·å–ä¸Šæ¬¡åŒæ­¥æ—¶é—´
        return LocalDateTime.now().minusMinutes(5);
    }
    
    private void updateLastSyncTime(LocalDateTime syncTime) {
        // æ›´æ–°åŒæ­¥æ—¶é—´æˆ³
    }
}
```

### 2. æ•°æ®è¿ç§»å·¥å…·

#### 2.1 æ•°æ®åº“è¿ç§»è„šæœ¬

```sql
-- V1__Create_initial_tables.sql
-- åˆ›å»ºåˆå§‹è¡¨ç»“æ„

-- V2__Add_user_preferences.sql
ALTER TABLE users ADD COLUMN preferences JSON COMMENT 'ç”¨æˆ·åå¥½è®¾ç½®';

-- V3__Create_audit_tables.sql
CREATE TABLE audit_logs (
    id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰',
    table_name VARCHAR(100) NOT NULL COMMENT 'è¡¨å',
    record_id BIGINT NOT NULL COMMENT 'è®°å½•ID',
    operation ENUM('INSERT', 'UPDATE', 'DELETE') NOT NULL COMMENT 'æ“ä½œç±»å‹',
    old_values JSON COMMENT 'æ—§å€¼',
    new_values JSON COMMENT 'æ–°å€¼',
    changed_by BIGINT NOT NULL COMMENT 'æ“ä½œäºº',
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'æ“ä½œæ—¶é—´',
    
    INDEX idx_table_record (table_name, record_id),
    INDEX idx_changed_by (changed_by),
    INDEX idx_changed_at (changed_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='å®¡è®¡æ—¥å¿—è¡¨';

-- V4__Add_fulltext_indexes.sql
ALTER TABLE documents ADD FULLTEXT INDEX ft_title_content (title, content);
```

#### 2.2 Javaè¿ç§»å·¥å…·

```java
@Component
public class DataMigrationTool {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    @Autowired
    private MongoTemplate mongoTemplate;
    
    /**
     * è¿ç§»ç”¨æˆ·åå¥½è®¾ç½®
     */
    public void migrateUserPreferences() {
        String sql = "SELECT id, preferences FROM users WHERE preferences IS NOT NULL";
        
        List<Map<String, Object>> users = jdbcTemplate.queryForList(sql);
        
        for (Map<String, Object> user : users) {
            Long userId = ((Number) user.get("id")).longValue();
            String preferencesJson = (String) user.get("preferences");
            
            try {
                UserPreferences preferences = objectMapper.readValue(preferencesJson, UserPreferences.class);
                
                // ä¿å­˜åˆ°MongoDB
                mongoTemplate.save(preferences, "user_preferences_" + userId);
                
                // æ¸…é™¤MySQLä¸­çš„å­—æ®µ
                jdbcTemplate.update("UPDATE users SET preferences = NULL WHERE id = ?", userId);
                
            } catch (Exception e) {
                log.error("Failed to migrate preferences for user {}", userId, e);
            }
        }
    }
    
    /**
     * æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
     */
    public ConsistencyReport checkDataConsistency() {
        ConsistencyReport report = new ConsistencyReport();
        
        // æ£€æŸ¥ç”¨æˆ·æ•°é‡ä¸€è‡´æ€§
        long mysqlUserCount = jdbcTemplate.queryForObject("SELECT COUNT(*) FROM users", Long.class);
        long mongoUserCount = mongoTemplate.count(new Query(), "users");
        
        report.addCheck("ç”¨æˆ·æ•°é‡", mysqlUserCount, mongoUserCount, mysqlUserCount == mongoUserCount);
        
        // æ£€æŸ¥æ–‡æ¡£æ•°é‡ä¸€è‡´æ€§
        long mysqlDocCount = jdbcTemplate.queryForObject("SELECT COUNT(*) FROM documents", Long.class);
        long mongoDocCount = mongoTemplate.count(new Query(), "documents");
        
        report.addCheck("æ–‡æ¡£æ•°é‡", mysqlDocCount, mongoDocCount, mysqlDocCount == mongoDocCount);
        
        return report;
    }
}
```

---

*æœ¬æ–‡æ¡£æä¾›äº†è¯¦ç»†çš„æ•°æ®æ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬æ•°æ®åº“è®¾è®¡ã€ç¼“å­˜ç­–ç•¥ã€æœç´¢å¼•æ“å’Œæ•°æ®åŒæ­¥çš„å…·ä½“å®ç°ï¼Œä¸ºå¼€å‘å›¢é˜Ÿæä¾›äº†å®Œæ•´çš„æ•°æ®ç®¡ç†æŒ‡å¯¼ã€‚*