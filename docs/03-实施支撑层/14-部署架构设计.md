# Spring4demo éƒ¨ç½²æ¶æ„è®¾è®¡

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **æ–‡æ¡£åç§°** | Spring4demo éƒ¨ç½²æ¶æ„è®¾è®¡ |
| **ç‰ˆæœ¬å·** | v1.0.0 |
| **åˆ›å»ºæ—¥æœŸ** | 2025-12-24 |
| **ä½œè€…** | DevOpsæ¶æ„å¸ˆ |
| **å®¡æ ¸äºº** | è¿ç»´ç»ç† |
| **æ‰¹å‡†äºº** | æŠ€æœ¯æ€»ç›‘ |

## ğŸ¯ éƒ¨ç½²æ¶æ„æ¦‚è¿°

Spring4demoé‡‡ç”¨å®¹å™¨åŒ–éƒ¨ç½²æ¶æ„ï¼ŒåŸºäºDockerå’ŒKubernetesæ„å»ºäº‘åŸç”Ÿéƒ¨ç½²ä½“ç³»ã€‚æ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²ï¼ˆå¼€å‘ã€æµ‹è¯•ã€é¢„ç”Ÿäº§ã€ç”Ÿäº§ï¼‰ï¼Œå…·å¤‡è‡ªåŠ¨åŒ–CI/CDæµæ°´çº¿ã€ç›‘æ§å‘Šè­¦ã€æ—¥å¿—æ”¶é›†ã€å¤‡ä»½æ¢å¤ç­‰å®Œæ•´çš„è¿ç»´èƒ½åŠ›ã€‚

## ğŸ—ï¸ å®¹å™¨åŒ–æ¶æ„

### 1. Dockeré•œåƒè®¾è®¡

#### 1.1 å¤šé˜¶æ®µæ„å»ºDockerfile

```dockerfile
# åŸºç¡€é•œåƒ - æ„å»ºé˜¶æ®µ
FROM eclipse-temurin:25-jdk-alpine AS builder
WORKDIR /app

# å®‰è£…æ„å»ºä¾èµ–
RUN apk add --no-cache curl

# å¤åˆ¶Mavené…ç½®
COPY pom.xml .
COPY .mvn .mvn
COPY mvnw .

# ä¸‹è½½ä¾èµ–
RUN ./mvnw dependency:go-offline -B

# å¤åˆ¶æºä»£ç 
COPY src src

# æ„å»ºåº”ç”¨
RUN ./mvnw clean package -DskipTests

# è¿è¡Œæ—¶é•œåƒ
FROM eclipse-temurin:25-jre-alpine

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apk add --no-cache \
    curl \
    dumb-init \
    && rm -rf /var/cache/apk/*

# åˆ›å»ºåº”ç”¨ç”¨æˆ·
RUN addgroup -g 1001 spring && \
    adduser -u 1001 -G spring -s /bin/sh -D spring

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/target/spring4demo-*.jar app.jar

# åˆ›å»ºæ—¥å¿—ç›®å½•
RUN mkdir -p /app/logs && \
    chown -R spring:spring /app

# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
USER spring

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8080/actuator/health || exit 1

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¯åŠ¨åº”ç”¨
ENTRYPOINT ["dumb-init", "--"]
CMD ["java", "-XX:+UseContainerSupport", "-XX:MaxRAMPercentage=75.0", "-jar", "app.jar"]
```

#### 1.2 Docker Composeå¼€å‘ç¯å¢ƒ

```yaml
# docker-compose.dev.yml
version: '3.8'

services:
  # åº”ç”¨æœåŠ¡
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/spring4demo
      - SPRING_DATASOURCE_USERNAME=spring4demo
      - SPRING_DATASOURCE_PASSWORD=password
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./logs:/app/logs
    networks:
      - spring4demo-network

  # MySQLæ•°æ®åº“
  mysql:
    image: mysql:8.0.35
    environment:
      - MYSQL_ROOT_PASSWORD=rootpassword
      - MYSQL_DATABASE=spring4demo
      - MYSQL_USER=spring4demo
      - MYSQL_PASSWORD=password
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - spring4demo-network

  # Redisç¼“å­˜
  redis:
    image: redis:7.0.5-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - spring4demo-network

  # MongoDB
  mongodb:
    image: mongo:6.0.8
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=password
      - MONGO_INITDB_DATABASE=spring4demo
    volumes:
      - mongodb_data:/data/db
      - ./docker/mongodb/init.js:/docker-entrypoint-initdb.d/init.js
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - spring4demo-network

  # Elasticsearch
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.8.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - spring4demo-network

  # RabbitMQ
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    environment:
      - RABBITMQ_DEFAULT_USER=spring4demo
      - RABBITMQ_DEFAULT_PASS=password
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - spring4demo-network

  # Nginxåå‘ä»£ç†
  nginx:
    image: nginx:1.24-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./docker/nginx/conf.d:/etc/nginx/conf.d
      - ./docker/ssl:/etc/nginx/ssl
    depends_on:
      - app
    networks:
      - spring4demo-network

volumes:
  mysql_data:
  redis_data:
  mongodb_data:
  elasticsearch_data:
  rabbitmq_data:

networks:
  spring4demo-network:
    driver: bridge
```

#### 1.3 ç”Ÿäº§ç¯å¢ƒDocker Compose

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  # åº”ç”¨æœåŠ¡ - å¤šå®ä¾‹
  app:
    image: ${REGISTRY}/spring4demo:${VERSION}
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-master:3306/spring4demo
      - SPRING_DATASOURCE_USERNAME=${DB_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
      - SPRING_REDIS_HOST=redis-cluster
      - SPRING_REDIS_PORT=6379
      - JAVA_OPTS=-Xms1g -Xmx2g -XX:+UseG1GC
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      - mysql-master
      - redis-cluster
    networks:
      - spring4demo-network

  # MySQLä¸»åº“
  mysql-master:
    image: mysql:8.0.35
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=spring4demo
      - MYSQL_USER=${DB_USERNAME}
      - MYSQL_PASSWORD=${DB_PASSWORD}
    volumes:
      - mysql_master_data:/var/lib/mysql
      - ./docker/mysql/master.cnf:/etc/mysql/conf.d/master.cnf
    command: --server-id=1 --log-bin=mysql-bin --binlog-format=ROW
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    networks:
      - spring4demo-network

  # MySQLä»åº“
  mysql-slave:
    image: mysql:8.0.35
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=spring4demo
      - MYSQL_USER=${DB_USERNAME}
      - MYSQL_PASSWORD=${DB_PASSWORD}
    volumes:
      - mysql_slave_data:/var/lib/mysql
      - ./docker/mysql/slave.cnf:/etc/mysql/conf.d/slave.cnf
    command: --server-id=2 --relay-log=relay-bin --read-only=1
    depends_on:
      - mysql-master
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    networks:
      - spring4demo-network

  # Redisé›†ç¾¤
  redis-cluster:
    image: redis:7.0.5-alpine
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf
    deploy:
      replicas: 6
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    volumes:
      - redis_cluster_data:/data
    networks:
      - spring4demo-network

  # MongoDBå‰¯æœ¬é›†
  mongodb-primary:
    image: mongo:6.0.8
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD}
      - MONGO_INITDB_DATABASE=spring4demo
    volumes:
      - mongodb_primary_data:/data/db
      - ./docker/mongodb/primary.conf:/etc/mongod.conf
    command: mongod --replSet rs0 --config /etc/mongod.conf
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    networks:
      - spring4demo-network

  # Elasticsearché›†ç¾¤
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.8.0
    environment:
      - cluster.name=spring4demo
      - node.name=elasticsearch-1
      - discovery.seed_hosts=elasticsearch-2,elasticsearch-3
      - cluster.initial_master_nodes=elasticsearch-1,elasticsearch-2,elasticsearch-3
      - xpack.security.enabled=true
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    networks:
      - spring4demo-network

  # Nginxè´Ÿè½½å‡è¡¡å™¨
  nginx:
    image: nginx:1.24-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.prod.conf:/etc/nginx/nginx.conf
      - ./docker/nginx/conf.d:/etc/nginx/conf.d
      - ./docker/ssl:/etc/nginx/ssl
      - nginx_logs:/var/log/nginx
    depends_on:
      - app
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    networks:
      - spring4demo-network

volumes:
  mysql_master_data:
  mysql_slave_data:
  redis_cluster_data:
  mongodb_primary_data:
  elasticsearch_data:
  nginx_logs:

networks:
  spring4demo-network:
    driver: overlay
    attachable: true
```

## â˜¸ï¸ Kuberneteséƒ¨ç½²

### 1. Kubernetesèµ„æºå®šä¹‰

#### 1.1 å‘½åç©ºé—´å’Œé…ç½®

```yaml
# namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: spring4demo
  labels:
    name: spring4demo
    environment: production

---
# configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: spring4demo-config
  namespace: spring4demo
data:
  application.yml: |
    spring:
      profiles:
        active: prod
      datasource:
        url: jdbc:mysql://mysql-service:3306/spring4demo
        username: ${DB_USERNAME}
        password: ${DB_PASSWORD}
        hikari:
          maximum-pool-size: 20
          minimum-idle: 5
      redis:
        host: redis-service
        port: 6379
      jpa:
        hibernate:
          ddl-auto: validate
    logging:
      level:
        com.kev1n.spring4demo: INFO
        org.springframework.security: DEBUG
    management:
      endpoints:
        web:
          exposure:
            include: health,info,metrics,prometheus
      endpoint:
        health:
          show-details: always

---
# secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: spring4demo-secrets
  namespace: spring4demo
type: Opaque
data:
  db-username: c3ByaW5nNGRlbW8=  # spring4demo (base64)
  db-password: cGFzc3dvcmQ=      # password (base64)
  jwt-secret: bXlfc2VjcmV0X2tleQ==  # my_secret_key (base64)
```

#### 1.2 åº”ç”¨éƒ¨ç½²

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: spring4demo-app
  namespace: spring4demo
  labels:
    app: spring4demo-app
    version: v1.0.0
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: spring4demo-app
  template:
    metadata:
      labels:
        app: spring4demo-app
        version: v1.0.0
    spec:
      containers:
      - name: spring4demo-app
        image: registry.example.com/spring4demo:1.0.0
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
          name: http
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        - name: DB_USERNAME
          valueFrom:
            secretKeyRef:
              name: spring4demo-secrets
              key: db-username
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: spring4demo-secrets
              key: db-password
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: spring4demo-secrets
              key: jwt-secret
        volumeMounts:
        - name: config-volume
          mountPath: /app/config
        - name: logs-volume
          mountPath: /app/logs
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        lifecycle:
          preStop:
            exec:
              command: ["sh", "-c", "sleep 15"]
      volumes:
      - name: config-volume
        configMap:
          name: spring4demo-config
      - name: logs-volume
        emptyDir: {}
      imagePullSecrets:
      - name: registry-secret

---
# service.yaml
apiVersion: v1
kind: Service
metadata:
  name: spring4demo-service
  namespace: spring4demo
  labels:
    app: spring4demo-app
spec:
  type: ClusterIP
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP
    name: http
  selector:
    app: spring4demo-app

---
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: spring4demo-ingress
  namespace: spring4demo
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
spec:
  tls:
  - hosts:
    - spring4demo.example.com
    secretName: spring4demo-tls
  rules:
  - host: spring4demo.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: spring4demo-service
            port:
              number: 80
```

#### 1.3 æ•°æ®åº“éƒ¨ç½²

```yaml
# mysql-master.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql-master
  namespace: spring4demo
spec:
  serviceName: mysql-master
  replicas: 1
  selector:
    matchLabels:
      app: mysql-master
  template:
    metadata:
      labels:
        app: mysql-master
    spec:
      containers:
      - name: mysql
        image: mysql:8.0.35
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secrets
              key: root-password
        - name: MYSQL_DATABASE
          value: spring4demo
        - name: MYSQL_USER
          valueFrom:
            secretKeyRef:
              name: mysql-secrets
              key: username
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secrets
              key: password
        ports:
        - containerPort: 3306
        volumeMounts:
        - name: mysql-data
          mountPath: /var/lib/mysql
        - name: mysql-config
          mountPath: /etc/mysql/conf.d
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
      volumes:
      - name: mysql-config
        configMap:
          name: mysql-config
  volumeClaimTemplates:
  - metadata:
      name: mysql-data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 100Gi

---
# mysql-master-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: mysql-master
  namespace: spring4demo
spec:
  selector:
    app: mysql-master
  ports:
  - port: 3306
    targetPort: 3306
  clusterIP: None

---
# redis-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: spring4demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7.0.5-alpine
        ports:
        - containerPort: 6379
        volumeMounts:
        - name: redis-data
          mountPath: /data
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
      volumes:
      - name: redis-data
        persistentVolumeClaim:
          claimName: redis-pvc

---
# redis-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: redis-service
  namespace: spring4demo
spec:
  selector:
    app: redis
  ports:
  - port: 6379
    targetPort: 6379
```

### 2. æ°´å¹³è‡ªåŠ¨æ‰©å±•

#### 2.1 HPAé…ç½®

```yaml
# hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: spring4demo-hpa
  namespace: spring4demo
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: spring4demo-app
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  - type: Pods
    pods:
      metric:
        name: http_requests_per_second
      target:
        type: AverageValue
        averageValue: "1000"
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
      - type: Pods
        value: 4
        periodSeconds: 15
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 10
        periodSeconds: 60
      - type: Pods
        value: 2
        periodSeconds: 60
      selectPolicy: Min
```

#### 2.2 VPAé…ç½®

```yaml
# vpa.yaml
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: spring4demo-vpa
  namespace: spring4demo
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: spring4demo-app
  updatePolicy:
    updateMode: "Auto"
  resourcePolicy:
    containerPolicies:
    - containerName: spring4demo-app
      maxAllowed:
        cpu: 2
        memory: 4Gi
      minAllowed:
        cpu: 500m
        memory: 1Gi
```

## ğŸ”„ CI/CDæµæ°´çº¿

### 1. GitHub Actionså·¥ä½œæµ

#### 1.1 æ„å»ºå’Œéƒ¨ç½²æµæ°´çº¿

```yaml
# .github/workflows/ci-cd.yml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0.35
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: spring4demo_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      redis:
        image: redis:7.0.5
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 25
      uses: actions/setup-java@v3
      with:
        java-version: '25'
        distribution: 'temurin'

    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

    - name: Run tests
      run: mvn clean test
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/spring4demo_test
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: password
        SPRING_REDIS_HOST: localhost
        SPRING_REDIS_PORT: 6379

    - name: Generate test report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Maven Tests
        path: target/surefire-reports/*.xml
        reporter: java-junit

    - name: Run integration tests
      run: mvn verify -P integration-tests
      env:
        SPRING_PROFILES_ACTIVE: test

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./target/site/jacoco/jacoco.xml

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  security-scan:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

  deploy-staging:
    needs: [build, security-scan]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.24.0'

    - name: Configure kubectl
      run: |
        echo "${{ secrets.KUBE_CONFIG_STAGING }}" | base64 -d > kubeconfig
        export KUBECONFIG=kubeconfig

    - name: Deploy to staging
      run: |
        kubectl set image deployment/spring4demo-app spring4demo-app=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:develop -n spring4demo-staging
        kubectl rollout status deployment/spring4demo-app -n spring4demo-staging

    - name: Run smoke tests
      run: |
        kubectl wait --for=condition=ready pod -l app=spring4demo-app -n spring4demo-staging --timeout=300s
        ./scripts/smoke-tests.sh https://staging.spring4demo.example.com

  deploy-production:
    needs: [build, security-scan]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.24.0'

    - name: Configure kubectl
      run: |
        echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > kubeconfig
        export KUBECONFIG=kubeconfig

    - name: Deploy to production
      run: |
        # è“ç»¿éƒ¨ç½²
        kubectl apply -f k8s/production/blue-green.yaml -n spring4demo
        kubectl rollout status deployment/spring4demo-app-green -n spring4demo
        
        # å¥åº·æ£€æŸ¥
        kubectl wait --for=condition=ready pod -l app=spring4demo-app,color=green -n spring4demo --timeout=600s
        
        # åˆ‡æ¢æµé‡
        kubectl patch service spring4demo-service -n spring4demo -p '{"spec":{"selector":{"color":"green"}}}'
        
        # æ¸…ç†æ—§ç‰ˆæœ¬
        kubectl delete deployment spring4demo-app-blue -n spring4demo

    - name: Run production smoke tests
      run: |
        ./scripts/smoke-tests.sh https://spring4demo.example.com

    - name: Notify deployment success
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#deployments'
        text: 'ğŸš€ Spring4demo deployed to production successfully!'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
```

### 2. ArgoCD GitOps

#### 2.1 ArgoCDåº”ç”¨é…ç½®

```yaml
# argocd/application.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: spring4demo
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/your-org/spring4demo-k8s
    targetRevision: HEAD
    path: environments/production
  destination:
    server: https://kubernetes.default.svc
    namespace: spring4demo
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
  ignoreDifferences:
  - group: apps
    kind: Deployment
    jsonPointers:
    - /spec/replicas
```

#### 2.2 ç¯å¢ƒé…ç½®

```yaml
# environments/production/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: spring4demo-app
  namespace: spring4demo
spec:
  replicas: 5
  template:
    spec:
      containers:
      - name: spring4demo-app
        image: registry.example.com/spring4demo:1.0.0
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        - name: JAVA_OPTS
          value: "-Xms2g -Xmx4g -XX:+UseG1GC"

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: spring4demo-hpa
  namespace: spring4demo
spec:
  minReplicas: 5
  maxReplicas: 20
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. ç›‘æ§ä½“ç³»

#### 1.1 Prometheusé…ç½®

```yaml
# prometheus-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
    
    rule_files:
      - "/etc/prometheus/rules/*.yml"
    
    alerting:
      alertmanagers:
        - static_configs:
            - targets:
              - alertmanager:9093
    
    scrape_configs:
      - job_name: 'spring4demo'
        kubernetes_sd_configs:
          - role: endpoints
            namespaces:
              names:
                - spring4demo
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$3
            target_label: __address__
      
      - job_name: 'kubernetes-nodes'
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)
      
      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)

  alert.yml: |
    groups:
    - name: spring4demo.rules
      rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value }} errors per second"
      
      - alert: HighMemoryUsage
        expr: (container_memory_usage_bytes / container_spec_memory_limit_bytes) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage"
          description: "Memory usage is above 80%"
      
      - alert: PodCrashLooping
        expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Pod is crash looping"
          description: "Pod {{ $labels.pod }} is crash looping"
```

#### 1.2 Grafanaä»ªè¡¨æ¿

```json
{
  "dashboard": {
    "title": "Spring4demo Application Dashboard",
    "panels": [
      {
        "title": "Request Rate",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])",
            "legendFormat": "{{method}} {{uri}}"
          }
        ],
        "yAxes": [
          {
            "label": "Requests/sec"
          }
        ]
      },
      {
        "title": "Response Time",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "95th percentile"
          },
          {
            "expr": "histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "99th percentile"
          }
        ],
        "yAxes": [
          {
            "label": "Seconds"
          }
        ]
      },
      {
        "title": "Error Rate",
        "type": "singlestat",
        "targets": [
          {
            "expr": "rate(http_requests_total{status=~\"5..\"}[5m]) / rate(http_requests_total[5m]) * 100"
          }
        ],
        "valueMaps": [
          {
            "value": "null",
            "text": "N/A"
          }
        ],
        "thresholds": "1,5,10"
      },
      {
        "title": "JVM Memory",
        "type": "graph",
        "targets": [
          {
            "expr": "jvm_memory_used_bytes{area=\"heap\"} / jvm_memory_max_bytes{area=\"heap\"} * 100",
            "legendFormat": "Heap Usage"
          },
          {
            "expr": "jvm_memory_used_bytes{area=\"nonheap\"} / jvm_memory_max_bytes{area=\"nonheap\"} * 100",
            "legendFormat": "Non-Heap Usage"
          }
        ],
        "yAxes": [
          {
            "label": "Usage %",
            "max": 100
          }
        ]
      }
    ]
  }
}
```

### 2. æ—¥å¿—æ”¶é›†

#### 2.1 EFK Stacké…ç½®

```yaml
# elasticsearch.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: elasticsearch
  namespace: logging
spec:
  serviceName: elasticsearch
  replicas: 3
  selector:
    matchLabels:
      app: elasticsearch
  template:
    metadata:
      labels:
        app: elasticsearch
    spec:
      containers:
      - name: elasticsearch
        image: docker.elastic.co/elasticsearch/elasticsearch:8.8.0
        env:
        - name: cluster.name
          value: "spring4demo-logs"
        - name: node.name
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: discovery.seed_hosts
          value: "elasticsearch-0.elasticsearch,elasticsearch-1.elasticsearch,elasticsearch-2.elasticsearch"
        - name: ES_JAVA_OPTS
          value: "-Xms1g -Xmx1g"
        ports:
        - containerPort: 9200
        - containerPort: 9300
        volumeMounts:
        - name: elasticsearch-data
          mountPath: /usr/share/elasticsearch/data
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
  volumeClaimTemplates:
  - metadata:
      name: elasticsearch-data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 100Gi

---
# fluentd.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd
  namespace: logging
spec:
  selector:
    matchLabels:
      name: fluentd
  template:
    metadata:
      labels:
        name: fluentd
    spec:
      serviceAccount: fluentd
      serviceAccountName: fluentd
      tolerations:
      - key: node-role.kubernetes.io/master
        effect: NoSchedule
      containers:
      - name: fluentd
        image: fluent/fluentd-kubernetes-daemonset:v1-debian-elasticsearch
        env:
        - name: FLUENT_ELASTICSEARCH_HOST
          value: "elasticsearch.logging.svc.cluster.local"
        - name: FLUENT_ELASTICSEARCH_PORT
          value: "9200"
        - name: FLUENT_ELASTICSEARCH_SCHEME
          value: "http"
        - name: FLUENT_ELASTICSEARCH_USER
          value: "elastic"
        - name: FLUENT_ELASTICSEARCH_PASSWORD
          valueFrom:
            secretKeyRef:
              name: elasticsearch-secrets
              key: password
        volumeMounts:
        - name: varlog
          mountPath: /var/log
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        - name: fluentd-config
          mountPath: /fluentd/etc
        resources:
          limits:
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 200Mi
      volumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
      - name: fluentd-config
        configMap:
          name: fluentd-config
```

#### 2.2 æ—¥å¿—é…ç½®

```xml
<!-- logback-spring.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <springProfile name="prod">
        <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
            <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
                <providers>
                    <timestamp/>
                    <logLevel/>
                    <loggerName/>
                    <message/>
                    <mdc/>
                    <stackTrace/>
                </providers>
            </encoder>
        </appender>
        
        <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>/app/logs/spring4demo.log</file>
            <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
                <fileNamePattern>/app/logs/spring4demo.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
                <maxFileSize>100MB</maxFileSize>
                <maxHistory>30</maxHistory>
                <totalSizeCap>3GB</totalSizeCap>
            </rollingPolicy>
            <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
                <providers>
                    <timestamp/>
                    <logLevel/>
                    <loggerName/>
                    <message/>
                    <mdc/>
                    <stackTrace/>
                </providers>
            </encoder>
        </appender>
        
        <root level="INFO">
            <appender-ref ref="STDOUT"/>
            <appender-ref ref="FILE"/>
        </root>
    </springProfile>
</configuration>
```

## ğŸ”’ å®‰å…¨é…ç½®

### 1. ç½‘ç»œå®‰å…¨

#### 1.1 ç½‘ç»œç­–ç•¥

```yaml
# network-policy.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: spring4demo-network-policy
  namespace: spring4demo
spec:
  podSelector:
    matchLabels:
      app: spring4demo-app
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8080
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: spring4demo
    ports:
    - protocol: TCP
      port: 3306
    - protocol: TCP
      port: 6379
    - protocol: TCP
      port: 27017
  - to: []
    ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 443
```

#### 1.2 Podå®‰å…¨ç­–ç•¥

```yaml
# pod-security-policy.yaml
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: spring4demo-psp
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    - 'persistentVolumeClaim'
  runAsUser:
    rule: 'MustRunAsNonRoot'
  seLinux:
    rule: 'RunAsAny'
  fsGroup:
    rule: 'RunAsAny'
```

### 2. RBACé…ç½®

```yaml
# rbac.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: spring4demo-sa
  namespace: spring4demo

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: spring4demo-role
  namespace: spring4demo
rules:
- apiGroups: [""]
  resources: ["pods", "services", "configmaps", "secrets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets"]
  verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: spring4demo-rolebinding
  namespace: spring4demo
subjects:
- kind: ServiceAccount
  name: spring4demo-sa
  namespace: spring4demo
roleRef:
  kind: Role
  name: spring4demo-role
  apiGroup: rbac.authorization.k8s.io
```

## ğŸ”„ å¤‡ä»½å’Œæ¢å¤

### 1. æ•°æ®å¤‡ä»½ç­–ç•¥

#### 1.1 è‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# backup.sh

set -e

# é…ç½®å˜é‡
BACKUP_DIR="/backups"
DATE=$(date +%Y%m%d_%H%M%S)
MYSQL_HOST="mysql-master"
MYSQL_USER="backup_user"
MYSQL_PASSWORD="${MYSQL_BACKUP_PASSWORD}"
REDIS_HOST="redis-service"
MONGODB_HOST="mongodb-primary"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "${BACKUP_DIR}/${DATE}"

# MySQLå¤‡ä»½
echo "Starting MySQL backup..."
mysqldump -h "${MYSQL_HOST}" -u "${MYSQL_USER}" -p"${MYSQL_PASSWORD}" \
  --single-transaction \
  --routines \
  --triggers \
  spring4demo | gzip > "${BACKUP_DIR}/${DATE}/mysql_backup.sql.gz"

# Rediså¤‡ä»½
echo "Starting Redis backup..."
redis-cli -h "${REDIS_HOST}" --rdb "${BACKUP_DIR}/${DATE}/redis_backup.rdb"

# MongoDBå¤‡ä»½
echo "Starting MongoDB backup..."
mongodump --host "${MONGODB_HOST}" --username "${MONGO_BACKUP_USER}" \
  --password "${MONGO_BACKUP_PASSWORD}" --gzip \
  --out "${BACKUP_DIR}/${DATE}/mongodb_backup"

# ä¸Šä¼ åˆ°äº‘å­˜å‚¨
echo "Uploading backups to cloud storage..."
aws s3 sync "${BACKUP_DIR}/${DATE}" s3://spring4demo-backups/${DATE}/

# æ¸…ç†æœ¬åœ°å¤‡ä»½ï¼ˆä¿ç•™7å¤©ï¼‰
find "${BACKUP_DIR}" -type d -mtime +7 -exec rm -rf {} +

echo "Backup completed: ${DATE}"
```

#### 1.2 Kuberneteså¤‡ä»½CronJob

```yaml
# backup-cronjob.yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: database-backup
  namespace: spring4demo
spec:
  schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: backup
            image: registry.example.com/backup-tools:latest
            command:
            - /bin/bash
            - -c
            - |
              # MySQLå¤‡ä»½
              mysqldump -h mysql-master -u backup_user -p${MYSQL_BACKUP_PASSWORD} \
                --single-transaction spring4demo | gzip > /backup/mysql_$(date +%Y%m%d_%H%M%S).sql.gz
              
              # Rediså¤‡ä»½
              redis-cli -h redis-service --rdb /backup/redis_$(date +%Y%m%d_%H%M%S).rdb
              
              # MongoDBå¤‡ä»½
              mongodump --host mongodb-primary --username ${MONGO_BACKUP_USER} \
                --password ${MONGO_BACKUP_PASSWORD} --gzip \
                --out /backup/mongodb_$(date +%Y%m%d_%H%M%S)
              
              # ä¸Šä¼ åˆ°S3
              aws s3 sync /backup s3://spring4demo-backups/$(date +%Y%m%d)/
            env:
            - name: MYSQL_BACKUP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: backup-secrets
                  key: mysql-password
            - name: MONGO_BACKUP_USER
              valueFrom:
                secretKeyRef:
                  name: backup-secrets
                  key: mongodb-user
            - name: MONGO_BACKUP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: backup-secrets
                  key: mongodb-password
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: access-key-id
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: secret-access-key
            volumeMounts:
            - name: backup-storage
              mountPath: /backup
            resources:
              requests:
                memory: "512Mi"
                cpu: "200m"
              limits:
                memory: "1Gi"
                cpu: "500m"
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: backup-pvc
          restartPolicy: OnFailure
```

---

*æœ¬æ–‡æ¡£æä¾›äº†è¯¦ç»†çš„éƒ¨ç½²æ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬å®¹å™¨åŒ–ã€Kuberneteséƒ¨ç½²ã€CI/CDæµæ°´çº¿ã€ç›‘æ§æ—¥å¿—ã€å®‰å…¨é…ç½®å’Œå¤‡ä»½æ¢å¤çš„å…·ä½“å®ç°ï¼Œä¸ºè¿ç»´å›¢é˜Ÿæä¾›äº†å®Œæ•´çš„éƒ¨ç½²å’Œè¿ç»´æŒ‡å¯¼ã€‚*