# Spring4demo æŠ€æœ¯æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **æ–‡æ¡£åç§°** | Spring4demo æŠ€æœ¯æ¶æ„è®¾è®¡ |
| **ç‰ˆæœ¬å·** | v1.1.0 |
| **åˆ›å»ºæ—¥æœŸ** | 2025-12-24 |
| **æ›´æ–°æ—¥æœŸ** | 2026-01-07 |
| **ä½œè€…** | æŠ€æœ¯æ¶æ„å¸ˆ |
| **å®¡æ ¸äºº** | é¦–å¸­æ¶æ„å¸ˆ |
| **æ‰¹å‡†äºº** | æŠ€æœ¯æ€»ç›‘ |

## ğŸ“ æ›´æ–°è¯´æ˜

**v1.2.0 (2026-01-07)**:
- æ¶æ„å®šä½ä»å¾®æœåŠ¡æ¶æ„è°ƒæ•´ä¸ºå•ä½“Spring Bootåº”ç”¨
- å»æ‰å¾®æœåŠ¡ç»„ä»¶ï¼šSpring Cloud Gatewayã€Nacosã€Sentinelã€RSocketã€RocketMQ
- æ¥å…¥å±‚ç®€åŒ–ä¸ºNginxè´Ÿè½½å‡è¡¡å™¨
- é™æµæ–¹æ¡ˆä»Sentinelè°ƒæ•´ä¸ºGuavaé™æµ
- æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨Spring Streamæ¥å…¥RabbitMQå’ŒKafka
- ä¿ç•™MongoDBã€Elasticsearchã€Neo4jã€InfluxDBç­‰æ•°æ®å­˜å‚¨
- æ›´æ–°æ¶æ„åˆ†å±‚æ¨¡å‹ï¼Œå»æ‰å¾®æœåŠ¡ç›¸å…³ç»„ä»¶
- æ›´æ–°æŠ€æœ¯æ ˆæ¶æ„å›¾ï¼Œåæ˜ å•ä½“åº”ç”¨æ¶æ„

**v1.1.0 (2026-01-07)**:
- æ¶æ„åˆ†å±‚ä»DDD 7å±‚è°ƒæ•´ä¸ºä¸‰å±‚æ¶æ„ï¼ˆWebå±‚ã€Serviceå±‚ã€Mapperå±‚ï¼‰
- è®¤è¯æ¡†æ¶ä»Spring Securityè°ƒæ•´ä¸ºSa-Token
- æ•°æ®è®¿é—®ä»Spring Data JPAè°ƒæ•´ä¸ºMyBatis-Plus
- ä¸»é”®ç­–ç•¥ä»AUTO_INCREMENT/UUIDè°ƒæ•´ä¸ºé›ªèŠ±ç®—æ³•
- å»æ‰é¢†åŸŸå±‚ã€èšåˆæ ¹ã€å€¼å¯¹è±¡ã€é¢†åŸŸäº‹ä»¶ç­‰DDDæ¦‚å¿µ
- å»æ‰é™ç•Œä¸Šä¸‹æ–‡ã€é¢†åŸŸæœåŠ¡ç­‰DDDæ¦‚å¿µ
- æ›´æ–°æŠ€æœ¯æ ˆæ¶æ„å›¾ï¼Œåæ˜ å®é™…ä½¿ç”¨çš„æŠ€æœ¯æ ˆ

## ğŸ¯ æ¶æ„è®¾è®¡åŸåˆ™

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

#### 1. åˆ†å±‚æ¶æ„åŸåˆ™
- **å…³æ³¨ç‚¹åˆ†ç¦»**: æ¯å±‚åªå…³æ³¨è‡ªå·±çš„èŒè´£
- **ä¾èµ–æ–¹å‘**: ä¸Šå±‚ä¾èµ–ä¸‹å±‚ï¼Œä¸‹å±‚ä¸ä¾èµ–ä¸Šå±‚
- **æ¥å£éš”ç¦»**: é€šè¿‡æ¥å£å®šä¹‰å±‚é—´äº¤äº’
- **æ¾è€¦åˆ**: å±‚é—´é€šè¿‡æ¥å£å’ŒDTOè§£è€¦

#### 2. æ¨¡å—åŒ–è®¾è®¡åŸåˆ™
- **é«˜å†…èš**: æ¨¡å—å†…éƒ¨åŠŸèƒ½é«˜åº¦ç›¸å…³
- **ä½è€¦åˆ**: æ¨¡å—é—´ä¾èµ–æœ€å°åŒ–
- **å•ä¸€èŒè´£**: æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªä¸šåŠ¡é¢†åŸŸ
- **å¼€æ”¾å°é—­**: å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­

#### 3. ä¸‰å±‚æ¶æ„åŸåˆ™
- **Webå±‚**: è´Ÿè´£æ¥æ”¶HTTPè¯·æ±‚ã€å‚æ•°æ ¡éªŒã€è¿”å›å“åº”
- **Serviceå±‚**: è´Ÿè´£ä¸šåŠ¡é€»è¾‘å¤„ç†ã€äº‹åŠ¡ç®¡ç†ã€ä¸šåŠ¡è§„åˆ™æ ¡éªŒ
- **Mapperå±‚**: è´Ÿè´£æ•°æ®è®¿é—®ã€SQLæ‰§è¡Œã€ç»“æœæ˜ å°„

## ğŸ—ï¸ æ•´ä½“æŠ€æœ¯æ¶æ„

### æ¶æ„åˆ†å±‚æ¨¡å‹

```mermaid
graph TB
    subgraph "æ¥å…¥å±‚ (Access Layer)"
        A1[è´Ÿè½½å‡è¡¡å™¨] --> A2[Nginx]
    end

    subgraph "Webå±‚ (Web Layer)"
        B1[Web MVC] --> B2[Spring MVC]
        B3[WebFlux] --> B4[Spring WebFlux]
        B5[WebSocket] --> B6[Spring WebSocket]
        B7[GraphQL] --> B8[Spring GraphQL]
    end

    subgraph "Serviceå±‚ (Service Layer)"
        C1[ä¸šåŠ¡æœåŠ¡] --> C2[Business Services]
        C3[äº‹åŠ¡ç®¡ç†] --> C4[Transaction Management]
        C5[ä¸šåŠ¡è§„åˆ™] --> C6[Business Rules]
        C7[å·¥ä½œæµ] --> C8[Workflow Engine]
    end

    subgraph "Mapperå±‚ (Mapper Layer)"
        D1[æ•°æ®è®¿é—®] --> D2[MyBatis-Plus]
        D3[SQLæ‰§è¡Œ] --> D4[SQL Execution]
        D5[ç»“æœæ˜ å°„] --> D6[Result Mapping]
    end

    subgraph "åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)"
        E1[æ¶ˆæ¯ä¸­é—´ä»¶] --> E2[Spring Stream]
        E3[ç¼“å­˜æœåŠ¡] --> E4[Redis]
        E5[æœç´¢å¼•æ“] --> E6[Elasticsearch]
    end

    subgraph "æ•°æ®å±‚ (Data Layer)"
        F1[å…³ç³»æ•°æ®åº“] --> F2[MySQL]
        F3[æ–‡æ¡£æ•°æ®åº“] --> F4[MongoDB]
        F5[æ—¶åºæ•°æ®åº“] --> F6[InfluxDB]
        F7[å›¾æ•°æ®åº“] --> F8[Neo4j]
    end

    A1 --> B1
    B1 --> C1
    B3 --> C1
    C1 --> D1
    C3 --> D1
    D1 --> F1
    E1 --> F1
    E3 --> F1
    E5 --> F1
```

### æŠ€æœ¯æ ˆæ¶æ„å›¾

```mermaid
graph LR
    subgraph "å‰ç«¯æŠ€æœ¯æ ˆ"
        A1[Vue.js 3.x] --> A2[Element Plus]
        A3[TypeScript] --> A4[Vite]
        A5[ECharts] --> A6[Axios]
    end

    subgraph "åç«¯æŠ€æœ¯æ ˆ"
        B1[Spring Boot 4.0.1] --> B2[Spring Framework 6.x]
        B3[Java 25] --> B4[Maven 3.9.12]
        B5[Lombok] --> B6[MapStruct]
    end

    subgraph "æ•°æ®æŠ€æœ¯æ ˆ"
        C1[MySQL 8.0] --> C2[MyBatis-Plus]
        C3[Redis 7.0] --> C4[Sa-Token Redis]
        C5[MongoDB 6.0] --> C6[MongoDB Driver]
        C7[Elasticsearch 8.0] --> C8[ES Rest Client]
        C9[Neo4j 5.12] --> C10[Neo4j Driver]
        C11[InfluxDB 2.7] --> C12[InfluxDB Client]
    end

    subgraph "ä¸­é—´ä»¶æŠ€æœ¯æ ˆ"
        D1[Spring Stream] --> D2[RabbitMQ 3.12]
        D1 --> D3[Apache Kafka 3.6]
    end

    subgraph "ç›‘æ§æŠ€æœ¯æ ˆ"
        E1[Spring Boot Actuator] --> E2[Micrometer]
        E3[Prometheus] --> E4[Grafana]
        E5[Zipkin] --> E6[OpenTelemetry]
    end

    subgraph "éƒ¨ç½²æŠ€æœ¯æ ˆ"
        F1[Docker] --> F2[Docker Compose]
        F3[Nginx] --> F4[Let's Encrypt]
        F5[GitHub Actions] --> F6[ArgoCD]
    end
```

## ğŸ”§ æ ¸å¿ƒæ¶æ„ç»„ä»¶

### 1. æ¥å…¥å±‚æ¶æ„

#### è´Ÿè½½å‡è¡¡è®¾è®¡
```yaml
# è´Ÿè½½å‡è¡¡é…ç½®
load_balancer:
  type: "nginx"
  algorithm: "round_robin"
  health_check:
    path: "/actuator/health"
    interval: "30s"
    timeout: "5s"
    retries: 3
  upstream:
    servers:
      - host: "app-server-1"
        port: 8080
        weight: 1
      - host: "app-server-2"
        port: 8080
        weight: 1
```

#### é™æµè®¾è®¡ï¼ˆGuavaï¼‰
```java
@Configuration
public class RateLimiterConfig {

    @Bean
    public LoadingCache<String, RateLimiter> rateLimiterCache() {
        return Caffeine.newBuilder()
                .maximumSize(1000)
                .expireAfterWrite(1, TimeUnit.HOURS)
                .build(key -> RateLimiter.create(100)); // æ¯ç§’100ä¸ªè¯·æ±‚
    }

    @Bean
    public RateLimiterAspect rateLimiterAspect() {
        return new RateLimiterAspect();
    }
}

@Aspect
@Component
@Slf4j
public class RateLimiterAspect {

    @Autowired
    private LoadingCache<String, RateLimiter> rateLimiterCache;

    @Around("@annotation(rateLimit)")
    public Object around(ProceedingJoinPoint joinPoint, RateLimit rateLimit) throws Throwable {
        String key = rateLimit.key();
        RateLimiter rateLimiter = rateLimiterCache.get(key);

        if (!rateLimiter.tryAcquire()) {
            log.warn("é™æµè§¦å‘: key={}, permits={}", key, rateLimit.permits());
            throw new RateLimitException("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•");
        }

        return joinPoint.proceed();
    }
}
```

### 2. åº”ç”¨å±‚æ¶æ„

#### MVCæ¶æ„è®¾è®¡
```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    @Autowired
    private UserService userService;
    
    @GetMapping("/{id}")
    public ResponseEntity<UserDTO> getUser(@PathVariable Long id) {
        UserDTO user = userService.getUserById(id);
        return ResponseEntity.ok(user);
    }
    
    @PostMapping
    public ResponseEntity<UserDTO> createUser(@Valid @RequestBody CreateUserRequest request) {
        UserDTO user = userService.createUser(request);
        return ResponseEntity.status(HttpStatus.CREATED).body(user);
    }
}
```

#### WebFluxå“åº”å¼è®¾è®¡
```java
@RestController
@RequestMapping("/api/reactive")
public class ReactiveUserController {
    
    @Autowired
    private ReactiveUserService userService;
    
    @GetMapping("/users/{id}")
    public Mono<UserDTO> getUser(@PathVariable Long id) {
        return userService.getUserById(id);
    }
    
    @GetMapping("/users")
    public Flux<UserDTO> getAllUsers() {
        return userService.getAllUsers();
    }
}
```

#### WebSocketå®æ—¶é€šä¿¡
```java
@Configuration
@EnableWebSocket
public class WebSocketConfig implements WebSocketConfigurer {
    
    @Override
    public void registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
        registry.addHandler(new NotificationWebSocketHandler(), "/ws/notifications")
                .setAllowedOrigins("*");
    }
}

@Component
public class NotificationWebSocketHandler extends TextWebSocketHandler {
    
    @Override
    public void afterConnectionEstablished(WebSocketSession session) {
        // è¿æ¥å»ºç«‹åçš„å¤„ç†é€»è¾‘
    }
    
    @Override
    protected void handleTextMessage(WebSocketSession session, TextMessage message) {
        // æ¶ˆæ¯å¤„ç†é€»è¾‘
    }
}
```

### 3. Serviceå±‚æ¶æ„

#### ä¸šåŠ¡æœåŠ¡è®¾è®¡
```java
@Service
@Transactional
public class UserServiceImpl implements UserService {

    @Autowired
    private UserMapper userMapper;

    @Autowired
    private PasswordEncoder passwordEncoder;

    @Override
    public UserDTO createUser(CreateUserRequest request) {
        // 1. éªŒè¯ä¸šåŠ¡è§„åˆ™
        validateUserRequest(request);

        // 2. æ£€æŸ¥ç”¨æˆ·åå”¯ä¸€æ€§
        if (userMapper.existsByUsername(request.getUsername())) {
            throw new UserAlreadyExistsException("Username already exists");
        }

        // 3. æ£€æŸ¥é‚®ç®±å”¯ä¸€æ€§
        if (userMapper.existsByEmail(request.getEmail())) {
            throw new UserAlreadyExistsException("Email already exists");
        }

        // 4. å¯†ç åŠ å¯†
        String encodedPassword = passwordEncoder.encode(request.getPassword());

        // 5. åˆ›å»ºç”¨æˆ·å®ä½“
        User user = new User();
        user.setUsername(request.getUsername());
        user.setEmail(request.getEmail());
        user.setPassword(encodedPassword);
        user.setStatus(UserStatus.ACTIVE);
        user.setCreateTime(LocalDateTime.now());
        user.setUpdateTime(LocalDateTime.now());

        // 6. ä¿å­˜åˆ°æ•°æ®åº“
        userMapper.insert(user);

        // 7. è¿”å›DTO
        return UserMapper.toDTO(user);
    }

    @Override
    public UserDTO getUserById(Long id) {
        User user = userMapper.selectById(id);
        if (user == null) {
            throw new UserNotFoundException("User not found");
        }
        return UserMapper.toDTO(user);
    }

    @Override
    public void updateUser(Long id, UpdateUserRequest request) {
        User user = userMapper.selectById(id);
        if (user == null) {
            throw new UserNotFoundException("User not found");
        }

        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        if (request.getEmail() != null) {
            user.setEmail(request.getEmail());
        }
        if (request.getPassword() != null) {
            user.setPassword(passwordEncoder.encode(request.getPassword()));
        }
        user.setUpdateTime(LocalDateTime.now());

        userMapper.updateById(user);
    }

    @Override
    public void deleteUser(Long id) {
        User user = userMapper.selectById(id);
        if (user == null) {
            throw new UserNotFoundException("User not found");
        }
        userMapper.deleteById(id);
    }
}
```

#### äº‹åŠ¡ç®¡ç†è®¾è®¡
```java
@Service
public class OrderServiceImpl implements OrderService {

    @Autowired
    private OrderMapper orderMapper;

    @Autowired
    private OrderItemMapper orderItemMapper;

    @Autowired
    private ProductMapper productMapper;

    @Override
    @Transactional(rollbackFor = Exception.class)
    public OrderDTO createOrder(CreateOrderRequest request) {
        // 1. åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setOrderNo(generateOrderNo());
        order.setUserId(request.getUserId());
        order.setStatus(OrderStatus.PENDING);
        order.setTotalAmount(request.getTotalAmount());
        order.setCreateTime(LocalDateTime.now());
        order.setUpdateTime(LocalDateTime.now());

        orderMapper.insert(order);

        // 2. åˆ›å»ºè®¢å•é¡¹
        for (CreateOrderItemRequest itemRequest : request.getItems()) {
            OrderItem item = new OrderItem();
            item.setOrderId(order.getId());
            item.setProductId(itemRequest.getProductId());
            item.setQuantity(itemRequest.getQuantity());
            item.setPrice(itemRequest.getPrice());
            item.setCreateTime(LocalDateTime.now());

            orderItemMapper.insert(item);

            // 3. æ‰£å‡åº“å­˜
            Product product = productMapper.selectById(itemRequest.getProductId());
            if (product.getStock() < itemRequest.getQuantity()) {
                throw new InsufficientStockException("Insufficient stock");
            }
            product.setStock(product.getStock() - itemRequest.getQuantity());
            product.setUpdateTime(LocalDateTime.now());
            productMapper.updateById(product);
        }

        return OrderMapper.toDTO(order);
    }
}
```

### 4. Mapperå±‚æ¶æ„

#### æ•°æ®è®¿é—®è®¾è®¡
```java
@Mapper
public interface UserMapper extends BaseMapper<User> {

    /**
     * æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·
     */
    @Select("SELECT * FROM users WHERE username = #{username} AND deleted = 0")
    User findByUsername(@Param("username") String username);

    /**
     * æ ¹æ®é‚®ç®±æŸ¥è¯¢ç”¨æˆ·
     */
    @Select("SELECT * FROM users WHERE email = #{email} AND deleted = 0")
    User findByEmail(@Param("email") String email);

    /**
     * æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
     */
    @Select("SELECT COUNT(1) FROM users WHERE username = #{username} AND deleted = 0")
    boolean existsByUsername(@Param("username") String username);

    /**
     * æ£€æŸ¥é‚®ç®±æ˜¯å¦å­˜åœ¨
     */
    @Select("SELECT COUNT(1) FROM users WHERE email = #{email} AND deleted = 0")
    boolean existsByEmail(@Param("email") String email);

    /**
     * æ ¹æ®è§’è‰²æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     */
    @Select("SELECT u.* FROM users u " +
            "JOIN user_roles ur ON u.id = ur.user_id " +
            "JOIN roles r ON ur.role_id = r.id " +
            "WHERE r.name = #{roleName} AND u.deleted = 0")
    List<User> findByRole(@Param("roleName") String roleName);

    /**
     * åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     */
    IPage<User> selectUserPage(Page<User> page, @Param("username") String username, @Param("status") UserStatus status);
}
```

#### å®ä½“ç±»è®¾è®¡
```java
@Data
@TableName("users")
public class User {

    /**
     * ä¸»é”®IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰
     */
    @TableId(type = IdType.ASSIGN_ID)
    private Long id;

    /**
     * ç”¨æˆ·å
     */
    @TableField("username")
    private String username;

    /**
     * é‚®ç®±
     */
    @TableField("email")
    private String email;

    /**
     * å¯†ç ï¼ˆåŠ å¯†åï¼‰
     */
    @TableField("password")
    private String password;

    /**
     * ç”¨æˆ·çŠ¶æ€
     */
    @TableField("status")
    private UserStatus status;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    @TableField("create_time")
    private LocalDateTime createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    @TableField("update_time")
    private LocalDateTime updateTime;

    /**
     * åˆ é™¤æ ‡è®°ï¼ˆ0ï¼šæœªåˆ é™¤ï¼Œ1ï¼šå·²åˆ é™¤ï¼‰
     */
    @TableField("deleted")
    @TableLogic
    private Integer deleted;
}
```

#### DTOæ˜ å°„è®¾è®¡
```java
@Mapper(componentModel = "spring")
public interface UserMapper {

    /**
     * å®ä½“è½¬DTO
     */
    @Mapping(target = "roles", ignore = true)
    UserDTO toDTO(User user);

    /**
     * DTOè½¬å®ä½“
     */
    @Mapping(target = "id", ignore = true)
    @Mapping(target = "createTime", ignore = true)
    @Mapping(target = "updateTime", ignore = true)
    @Mapping(target = "deleted", ignore = true)
    User toEntity(UserDTO userDTO);

    /**
     * å®ä½“åˆ—è¡¨è½¬DTOåˆ—è¡¨
     */
    List<UserDTO> toDTOList(List<User> users);
}
```

#### ç¼“å­˜è®¾è®¡
```java
@Service
@CacheConfig(cacheNames = "users")
public class UserCacheService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Cacheable(key = "#id")
    public User getUserById(Long id) {
        return userRepository.findById(id).orElse(null);
    }
    
    @CachePut(key = "#user.id")
    public User updateUser(User user) {
        return userRepository.save(user);
    }
    
    @CacheEvict(key = "#id")
    public void deleteUser(Long id) {
        userRepository.deleteById(id);
    }
}
```

#### æ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡ï¼ˆSpring Streamï¼‰
```java
// Spring Streamé…ç½®
@Configuration
public class StreamConfig {

    @Bean
    public Function<UserMessage, UserMessage> userProcessor() {
        return message -> {
            log.info("å¤„ç†ç”¨æˆ·æ¶ˆæ¯: {}", message);
            // å¤„ç†é€»è¾‘
            return message;
        };
    }
}

// æ¶ˆæ¯ç”Ÿäº§è€…
@Component
@Slf4j
public class MessageProducer {

    @Autowired
    private StreamBridge streamBridge;

    /**
     * å‘é€ç”¨æˆ·åˆ›å»ºæ¶ˆæ¯åˆ°RabbitMQ
     */
    public void sendUserCreatedMessage(Long userId) {
        UserCreatedMessage message = new UserCreatedMessage(userId);
        streamBridge.send("userCreated-out-0", message);
        log.info("å‘é€ç”¨æˆ·åˆ›å»ºæ¶ˆæ¯: {}", message);
    }

    /**
     * å‘é€ç”¨æˆ·åˆ›å»ºæ¶ˆæ¯åˆ°Kafka
     */
    public void sendUserCreatedMessageToKafka(Long userId) {
        UserCreatedMessage message = new UserCreatedMessage(userId);
        streamBridge.send("userCreatedKafka-out-0", message);
        log.info("å‘é€ç”¨æˆ·åˆ›å»ºæ¶ˆæ¯åˆ°Kafka: {}", message);
    }

    /**
     * å‘é€é€šçŸ¥æ¶ˆæ¯
     */
    public void sendNotificationMessage(NotificationMessage message) {
        streamBridge.send("notification-out-0", message);
        log.info("å‘é€é€šçŸ¥æ¶ˆæ¯: {}", message);
    }
}

// æ¶ˆæ¯æ¶ˆè´¹è€…
@Component
@Slf4j
public class MessageConsumer {

    /**
     * æ¶ˆè´¹RabbitMQç”¨æˆ·åˆ›å»ºæ¶ˆæ¯
     */
    @Bean
    public Consumer<UserCreatedMessage> userCreated() {
        return message -> {
            log.info("æ¶ˆè´¹ç”¨æˆ·åˆ›å»ºæ¶ˆæ¯: {}", message);
            // å¤„ç†ç”¨æˆ·åˆ›å»ºäº‹ä»¶
            handleUserCreated(message);
        };
    }

    /**
     * æ¶ˆè´¹Kafkaç”¨æˆ·åˆ›å»ºæ¶ˆæ¯
     */
    @Bean
    public Consumer<UserCreatedMessage> userCreatedKafka() {
        return message -> {
            log.info("æ¶ˆè´¹Kafkaç”¨æˆ·åˆ›å»ºæ¶ˆæ¯: {}", message);
            // å¤„ç†ç”¨æˆ·åˆ›å»ºäº‹ä»¶
            handleUserCreated(message);
        };
    }

    /**
     * æ¶ˆè´¹é€šçŸ¥æ¶ˆæ¯
     */
    @Bean
    public Consumer<NotificationMessage> notification() {
        return message -> {
            log.info("æ¶ˆè´¹é€šçŸ¥æ¶ˆæ¯: {}", message);
            // å¤„ç†é€šçŸ¥æ¶ˆæ¯
            handleNotification(message);
        };
    }

    private void handleUserCreated(UserCreatedMessage message) {
        // å¤„ç†ç”¨æˆ·åˆ›å»ºäº‹ä»¶é€»è¾‘
    }

    private void handleNotification(NotificationMessage message) {
        // å¤„ç†é€šçŸ¥æ¶ˆæ¯é€»è¾‘
    }
}
```

## ğŸ”’ å®‰å…¨æ¶æ„è®¾è®¡

### è®¤è¯æˆæƒæ¶æ„

```mermaid
graph TB
    subgraph "è®¤è¯å±‚"
        A1[ç”¨æˆ·è®¤è¯] --> A2[Sa-Token]
        A3[OAuth2] --> A4[Sa-Token OAuth2]
        A5[SSO] --> A6[Sa-Token SSO]
    end
    
    subgraph "æˆæƒå±‚"
        B1[RBAC] --> B2[è§’è‰²æƒé™]
        B3[ABAC] --> B4[å±æ€§æƒé™]
        B5[èµ„æºæƒé™] --> B6[APIæƒé™æ§åˆ¶]
    end
    
    subgraph "å®‰å…¨ç­–ç•¥å±‚"
        C1[å¯†ç ç­–ç•¥] --> C2[å¼ºå¯†ç è¦æ±‚]
        C3[ä¼šè¯ç­–ç•¥] --> C4[ä¼šè¯è¶…æ—¶]
        C5[è®¿é—®ç­–ç•¥] --> C6[IPé™åˆ¶]
    end
    
    A1 --> B1
    B1 --> C1
```

### å®‰å…¨é…ç½®å®ç°

```java
@Configuration
public class SaTokenConfig {
    
    @Bean
    public SaTokenDao saTokenDao() {
        // ä½¿ç”¨ Redis å­˜å‚¨ Token
        return new SaTokenDaoRedisImpl();
    }
    
    @Bean
    public StpInterface stpInterface() {
        return new StpInterfaceImpl();
    }
}

@Component
public class StpInterfaceImpl implements StpInterface {
    
    @Autowired
    private UserMapper userMapper;
    
    @Override
    public List<String> getPermissionList(Object loginId, String loginType) {
        // è¿”å›æ­¤ loginId æ‹¥æœ‰çš„æƒé™åˆ—è¡¨
        User user = userMapper.selectById((Long) loginId);
        return user.getPermissions();
    }
    
    @Override
    public List<String> getRoleList(Object loginId, String loginType) {
        // è¿”å›æ­¤ loginId æ‹¥æœ‰çš„è§’è‰²ç åˆ—è¡¨
        User user = userMapper.selectById((Long) loginId);
        return user.getRoles();
    }
}
```

## ğŸ“Š ç›‘æ§æ¶æ„è®¾è®¡

### ç›‘æ§ä½“ç³»æ¶æ„

```mermaid
graph TB
    subgraph "åº”ç”¨ç›‘æ§"
        A1[Spring Boot Actuator] --> A2[å¥åº·æ£€æŸ¥]
        A1 --> A3[æŒ‡æ ‡æ”¶é›†]
        A1 --> A4[ä¿¡æ¯ç«¯ç‚¹]
    end
    
    subgraph "æŒ‡æ ‡ç›‘æ§"
        B1[Micrometer] --> B2[Prometheus]
        B2 --> B3[Grafana]
        B3 --> B4[ç›‘æ§é¢æ¿]
    end
    
    subgraph "é“¾è·¯è¿½è¸ª"
        C1[OpenTelemetry] --> C2[Zipkin]
        C2 --> C3[é“¾è·¯åˆ†æ]
    end
    
    subgraph "æ—¥å¿—ç›‘æ§"
        D1[Logback] --> D2[ELK Stack]
        D2 --> D3[æ—¥å¿—åˆ†æ]
    end
    
    A1 --> B1
    A1 --> C1
    A1 --> D1
```

### ç›‘æ§é…ç½®å®ç°

```java
@Configuration
public class MonitoringConfig {
    
    @Bean
    public MeterRegistryCustomizer<MeterRegistry> metricsCommonTags() {
        return registry -> registry.config().commonTags(
            "application", "spring4demo",
            "region", System.getenv().getOrDefault("REGION", "local")
        );
    }
    
    @Bean
    public TimedAspect timedAspect(MeterRegistry registry) {
        return new TimedAspect(registry);
    }
    
    @Bean
    public CountedAspect countedAspect(MeterRegistry registry) {
        return new CountedAspect(registry);
    }
}
```

## ğŸš€ æ€§èƒ½æ¶æ„è®¾è®¡

### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 1. ç¼“å­˜æ¶æ„
```java
@Configuration
@EnableCaching
public class CacheConfig {
    
    @Bean
    public CacheManager cacheManager() {
        RedisCacheManager.Builder builder = RedisCacheManager
            .RedisCacheManagerBuilder
            .fromConnectionFactory(redisConnectionFactory())
            .cacheDefaults(cacheConfiguration());
        
        return builder.build();
    }
    
    private RedisCacheConfiguration cacheConfiguration() {
        return RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(30))
            .serializeKeysWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new GenericJackson2JsonRedisSerializer()));
    }
}
```

#### 2. è¿æ¥æ± é…ç½®
```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      idle-timeout: 300000
      max-lifetime: 1200000
      connection-timeout: 20000
      leak-detection-threshold: 60000
      
  redis:
    lettuce:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0
        max-wait: -1ms
```

#### 3. å¼‚æ­¥å¤„ç†
```java
@Configuration
@EnableAsync
public class AsyncConfig {
    
    @Bean(name = "taskExecutor")
    public Executor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(25);
        executor.setThreadNamePrefix("Async-");
        executor.initialize();
        return executor;
    }
}

@Service
public class AsyncService {
    
    @Async("taskExecutor")
    public CompletableFuture<String> asyncMethod() {
        // å¼‚æ­¥å¤„ç†é€»è¾‘
        return CompletableFuture.completedFuture("Result");
    }
}
```

## ğŸ”„ æ¶æ„æ¼”è¿›è®¾è®¡

### å•ä½“åº”ç”¨ä¼˜åŒ–è·¯å¾„

```mermaid
graph LR
    subgraph "é˜¶æ®µ1: åŸºç¡€å•ä½“æ¶æ„"
        A1[Spring Boot App] --> A2[MySQL]
        A1 --> A3[Redis]
        A1 --> A4[åŸºç¡€ç›‘æ§]
    end

    subgraph "é˜¶æ®µ2: åŠŸèƒ½å¢å¼º"
        B1[Spring Boot App] --> B2[æ¶ˆæ¯é˜Ÿåˆ—]
        B1 --> B3[æœç´¢å¼•æ“]
        B1 --> B4[åˆ†å¸ƒå¼ç¼“å­˜]
        B1 --> B5[é™æµä¿æŠ¤]
    end

    subgraph "é˜¶æ®µ3: æ€§èƒ½ä¼˜åŒ–"
        C1[Spring Boot App] --> C2[è¯»å†™åˆ†ç¦»]
        C1 --> C3[æ•°æ®åº“åˆ†åº“åˆ†è¡¨]
        C1 --> C4[ç¼“å­˜ä¼˜åŒ–]
        C1 --> C5[å¼‚æ­¥å¤„ç†]
    end

    subgraph "é˜¶æ®µ4: æ¨¡å—åŒ–é‡æ„"
        D1[æ¨¡å—åŒ–å•ä½“] --> D2[æ¸…æ™°çš„æ¨¡å—è¾¹ç•Œ]
        D2 --> D3[ç‹¬ç«‹éƒ¨ç½²å‡†å¤‡]
        D3 --> D4[å¯æ‹†åˆ†ä¸ºå¾®æœåŠ¡]
    end

    A1 --> B1
    B1 --> C1
    C1 --> D1
```

### æ¶æ„å†³ç­–è®°å½• (ADR)

#### ADR-001: é€‰æ‹©å•ä½“Spring Bootæ¶æ„
**çŠ¶æ€**: å·²æ¥å—
**å†³ç­–**: ä½¿ç”¨å•ä½“Spring Bootåº”ç”¨æ¶æ„ï¼Œè€Œéå¾®æœåŠ¡æ¶æ„
**ç†ç”±**:
- å½“å‰ä¸šåŠ¡è§„æ¨¡é€‚åˆå•ä½“æ¶æ„
- å¼€å‘å›¢é˜Ÿè§„æ¨¡è¾ƒå°ï¼Œå•ä½“æ¶æ„æ›´æ˜“ç»´æŠ¤
- é™ä½ç³»ç»Ÿå¤æ‚åº¦å’Œè¿ç»´æˆæœ¬
- å¿«é€Ÿè¿­ä»£å’Œéƒ¨ç½²æ›´ä¾¿æ·

**åæœ**:
- æ­£é¢: å¼€å‘æ•ˆç‡é«˜ï¼Œéƒ¨ç½²ç®€å•ï¼Œè°ƒè¯•æ–¹ä¾¿
- è´Ÿé¢: æ‰©å±•æ€§å—é™ï¼ŒæŠ€æœ¯æ ˆç»Ÿä¸€æ€§è¦æ±‚é«˜
- é£é™©: éšç€ä¸šåŠ¡å¢é•¿å¯èƒ½éœ€è¦é‡æ„ä¸ºå¾®æœåŠ¡

#### ADR-002: é€‰æ‹©Spring Bootä½œä¸ºåº”ç”¨æ¡†æ¶
**çŠ¶æ€**: å·²æ¥å—
**å†³ç­–**: ä½¿ç”¨Spring Boot 4.0.1ä½œä¸ºä¸»è¦åº”ç”¨æ¡†æ¶
**ç†ç”±**:
- æˆç†Ÿçš„ç”Ÿæ€ç³»ç»Ÿå’Œä¸°å¯Œçš„åŠŸèƒ½
- ç®€åŒ–é…ç½®å’Œå¿«é€Ÿå¼€å‘èƒ½åŠ›
- ä¸ç°æœ‰æŠ€æœ¯æ ˆå…¼å®¹æ€§å¥½
- ç¤¾åŒºæ´»è·ƒï¼Œæ–‡æ¡£å®Œå–„

**åæœ**:
- æ­£é¢: å¼€å‘æ•ˆç‡é«˜ï¼Œå­¦ä¹ æˆæœ¬ä½
- è´Ÿé¢: æ¡†æ¶è¾ƒé‡ï¼Œå¯åŠ¨æ—¶é—´è¾ƒé•¿
- é£é™©: ç‰ˆæœ¬å‡çº§å¯èƒ½å¸¦æ¥å…¼å®¹æ€§é—®é¢˜

#### ADR-003: é€‰æ‹©MySQLä½œä¸ºä¸»æ•°æ®åº“
**çŠ¶æ€**: å·²æ¥å—
**å†³ç­–**: ä½¿ç”¨MySQL 8.0ä½œä¸ºä¸»æ•°æ®åº“
**ç†ç”±**:
- å…³ç³»å‹æ•°æ®æ¨¡å‹é€‚åˆä¸šåŠ¡éœ€æ±‚
- äº‹åŠ¡æ”¯æŒå®Œå–„ï¼Œæ•°æ®ä¸€è‡´æ€§å¼º
- è¿ç»´å·¥å…·ä¸°å¯Œï¼Œç¤¾åŒºæ”¯æŒå¥½
- ä¸MyBatis-Plusé›†æˆè‰¯å¥½ï¼ŒSQLæ§åˆ¶çµæ´»

**åæœ**:
- æ­£é¢: æ•°æ®ä¸€è‡´æ€§å¼ºï¼Œè¿ç»´æˆç†Ÿï¼ŒSQLå¯æ§æ€§å¼º
- è´Ÿé¢: æ‰©å±•æ€§ç›¸å¯¹æœ‰é™
- é£é™©: å¤§æ•°æ®é‡åœºæ™¯æ€§èƒ½ç“¶é¢ˆ

#### ADR-004: ä½¿ç”¨Guavaé™æµæ›¿ä»£Sentinel
**çŠ¶æ€**: å·²æ¥å—
**å†³ç­–**: ä½¿ç”¨Guava RateLimiterè¿›è¡Œé™æµï¼Œè€ŒéSentinel
**ç†ç”±**:
- å•ä½“åº”ç”¨ä¸éœ€è¦åˆ†å¸ƒå¼é™æµ
- Guavaè½»é‡çº§ï¼Œé›†æˆç®€å•
- æ€§èƒ½å¼€é”€å°ï¼Œé€‚åˆå•ä½“åº”ç”¨åœºæ™¯
- é¿å…å¼•å…¥ä¸å¿…è¦çš„å¾®æœåŠ¡ç»„ä»¶ä¾èµ–

**åæœ**:
- æ­£é¢: è½»é‡çº§ã€é«˜æ€§èƒ½ã€æ˜“é›†æˆ
- è´Ÿé¢: ä¸æ”¯æŒåˆ†å¸ƒå¼é™æµï¼ŒåŠŸèƒ½ç›¸å¯¹ç®€å•
- é£é™©: éšç€åº”ç”¨æ‰©å±•å¯èƒ½éœ€è¦å‡çº§åˆ°åˆ†å¸ƒå¼é™æµæ–¹æ¡ˆ

#### ADR-005: ä½¿ç”¨Spring Streamæ¥å…¥æ¶ˆæ¯é˜Ÿåˆ—
**çŠ¶æ€**: å·²æ¥å—
**å†³ç­–**: ä½¿ç”¨Spring Cloud Streamç»Ÿä¸€æ¥å…¥RabbitMQå’ŒKafka
**ç†ç”±**:
- ç»Ÿä¸€çš„æ¶ˆæ¯ç¼–ç¨‹æ¨¡å‹
- æ”¯æŒå¤šç§æ¶ˆæ¯ä¸­é—´ä»¶åˆ‡æ¢
- ä¸Springç”Ÿæ€é›†æˆè‰¯å¥½
- ç®€åŒ–æ¶ˆæ¯é˜Ÿåˆ—çš„å¼€å‘å’Œç»´æŠ¤

**åæœ**:
- æ­£é¢: ç»Ÿä¸€APIã€çµæ´»æ€§é«˜ã€æ˜“æ‰©å±•
- è´Ÿé¢: å¢åŠ ä¸€å±‚æŠ½è±¡ï¼Œå­¦ä¹ æˆæœ¬ç¨é«˜
- é£é™©: ç‰¹å®šæ¶ˆæ¯ä¸­é—´ä»¶çš„é«˜çº§ç‰¹æ€§å¯èƒ½å—é™
---

*æœ¬æ–‡æ¡£ä¸ºæŠ€æœ¯æ¶æ„çš„æ ¸å¿ƒæŒ‡å¯¼æ–‡æ¡£ï¼Œæ‰€æœ‰æŠ€æœ¯å®ç°éƒ½åº”éµå¾ªæœ¬æ–‡æ¡£çš„æ¶æ„è®¾è®¡åŸåˆ™ã€‚*