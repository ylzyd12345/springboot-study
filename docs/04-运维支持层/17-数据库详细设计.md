# Spring4demo æ•°æ®åº“è¯¦ç»†è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **æ–‡æ¡£åç§°** | Spring4demo æ•°æ®åº“è¯¦ç»†è®¾è®¡ |
| **ç‰ˆæœ¬å·** | v1.1.0 |
| **åˆ›å»ºæ—¥æœŸ** | 2025-12-24 |
| **æ›´æ–°æ—¥æœŸ** | 2026-01-07 |
| **ä½œè€…** | æ•°æ®åº“æ¶æ„å¸ˆ |
| **å®¡æ ¸äºº** | æŠ€æœ¯æ¶æ„å¸ˆ |
| **æ‰¹å‡†äºº** | é¡¹ç›®ç»ç† |

## ğŸ“ æ›´æ–°è¯´æ˜

**v1.1.0 (2026-01-07)**:
- ä¸»é”®ç­–ç•¥ä»AUTO_INCREMENTè°ƒæ•´ä¸ºé›ªèŠ±ç®—æ³•
- æ›´æ–°æ‰€æœ‰è¡¨çš„ä¸»é”®å®šä¹‰ï¼Œä½¿ç”¨é›ªèŠ±ç®—æ³•ç”Ÿæˆå”¯ä¸€ID

## ğŸ¯ è®¾è®¡æ¦‚è¿°

### æ•°æ®åº“æ¶æ„ç›®æ ‡
Spring4demoé‡‡ç”¨å¤šæ•°æ®åº“æ¶æ„ï¼Œç»“åˆå…³ç³»å‹æ•°æ®åº“ã€æ–‡æ¡£æ•°æ®åº“ã€ç¼“å­˜æ•°æ®åº“å’Œæœç´¢å¼•æ“ï¼Œä¸ºä¸åŒä¸šåŠ¡åœºæ™¯æä¾›æœ€ä¼˜çš„æ•°æ®å­˜å‚¨è§£å†³æ–¹æ¡ˆã€‚

### æŠ€æœ¯é€‰å‹
- **å…³ç³»å‹æ•°æ®åº“**: MySQL 8.0 - å­˜å‚¨ç»“æ„åŒ–ä¸šåŠ¡æ•°æ®
- **æ–‡æ¡£æ•°æ®åº“**: MongoDB 6.0 - å­˜å‚¨éç»“æ„åŒ–å†…å®¹å’Œæ—¥å¿—æ•°æ®
- **ç¼“å­˜æ•°æ®åº“**: Redis 7.0 - ç¼“å­˜çƒ­ç‚¹æ•°æ®å’Œä¼šè¯ä¿¡æ¯
- **æœç´¢å¼•æ“**: Elasticsearch 8.0 - å…¨æ–‡æœç´¢å’Œæ•°æ®åˆ†æ

## ğŸ—ï¸ æ•´ä½“æ•°æ®æ¶æ„

### æ•°æ®æ¶æ„å›¾

```mermaid
graph TB
    subgraph "åº”ç”¨å±‚"
        A1[Spring Bootåº”ç”¨] --> A2[ä¸šåŠ¡é€»è¾‘]
        A3[ç¼“å­˜å±‚] --> A4[Redisé›†ç¾¤]
    end
    
    subgraph "æ•°æ®è®¿é—®å±‚"
        B1[MyBatis-Plus] --> B2[MySQLä¸»ä»]
        B3[MongoDB Driver] --> B4[MongoDBå‰¯æœ¬é›†]
        B5[ES Rest Client] --> B6[ESé›†ç¾¤]
    end
    
    subgraph "æ•°æ®å­˜å‚¨å±‚"
        C1[MySQL Master] --> C2[MySQL Slave1]
        C1 --> C3[MySQL Slave2]
        C4[MongoDB Primary] --> C5[MongoDB Secondary1]
        C4 --> C6[MongoDB Secondary2]
        C7[Elasticsearch Node1] --> C8[Elasticsearch Node2]
        C7 --> C9[Elasticsearch Node3]
    end
    
    A1 --> B1
    A1 --> B3
    A1 --> B5
    A2 --> A3
    B1 --> C1
    B3 --> C4
    B5 --> C7
```

### æ•°æ®æµå‘å›¾

```mermaid
graph LR
    subgraph "å†™æ“ä½œ"
        A1[ç”¨æˆ·è¯·æ±‚] --> A2[åº”ç”¨æœåŠ¡]
        A2 --> A3[MySQLå†™å…¥]
        A3 --> A4[Redisç¼“å­˜æ›´æ–°]
        A4 --> A5[ESç´¢å¼•æ›´æ–°]
    end
    
    subgraph "è¯»æ“ä½œ"
        B1[ç”¨æˆ·è¯·æ±‚] --> B2[åº”ç”¨æœåŠ¡]
        B2 --> B3{Redisç¼“å­˜}
        B3 -->|å‘½ä¸­| B4[è¿”å›ç¼“å­˜æ•°æ®]
        B3 -->|æœªå‘½ä¸­| B5[MySQLæŸ¥è¯¢]
        B5 --> B6[Redisç¼“å­˜å†™å…¥]
        B6 --> B7[è¿”å›æ•°æ®]
    end
    
    subgraph "æœç´¢æ“ä½œ"
        C1[æœç´¢è¯·æ±‚] --> C2[Elasticsearch]
        C2 --> C3[è¿”å›æœç´¢ç»“æœ]
    end
```

## ğŸ“Š MySQLæ•°æ®åº“è®¾è®¡

### 1. æ•°æ®åº“é…ç½®

#### ä¸»åº“é…ç½®
```yaml
spring:
  datasource:
    master:
      url: jdbc:mysql://mysql-master:3306/spring4demo?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
      username: ${DB_USERNAME}
      password: ${DB_PASSWORD}
      driver-class-name: com.mysql.cj.jdbc.Driver
      type: com.alibaba.druid.pool.DruidDataSource
      druid:
        initial-size: 5
        min-idle: 5
        max-active: 20
        max-wait: 60000
        time-between-eviction-runs-millis: 60000
        min-evictable-idle-time-millis: 300000
        validation-query: SELECT 1
        test-while-idle: true
        test-on-borrow: false
        test-on-return: false

# MyBatis-Plus é…ç½®
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true
    cache-enabled: false
    call-setters-on-nulls: true
    jdbc-type-for-null: 'null'
  global-config:
    db-config:
      id-type: auto
      logic-delete-field: deleted
      logic-delete-value: 1
      logic-not-delete-value: 0
  mapper-locations: classpath*:/mapper/**/*.xml
        minimum-idle: 5
        idle-timeout: 300000
        max-lifetime: 1200000
        connection-timeout: 20000
        leak-detection-threshold: 60000
```

#### ä»åº“é…ç½®
```yaml
spring:
  datasource:
    slave:
      url: jdbc:mysql://mysql-slave:3306/spring4demo?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
      username: ${DB_USERNAME}
      password: ${DB_PASSWORD}
      driver-class-name: com.mysql.cj.jdbc.Driver
      hikari:
        maximum-pool-size: 10
        minimum-idle: 2
        idle-timeout: 300000
        max-lifetime: 1200000
        connection-timeout: 20000
```

### 2. ç”¨æˆ·æƒé™æ¨¡å—è¡¨è®¾è®¡

#### ç”¨æˆ·è¡¨ (sys_user)
```sql
CREATE TABLE sys_user (
    id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰',
    username VARCHAR(50) UNIQUE NOT NULL COMMENT 'ç”¨æˆ·å',
    email VARCHAR(100) UNIQUE NOT NULL COMMENT 'é‚®ç®±åœ°å€',
    password VARCHAR(255) NOT NULL COMMENT 'å¯†ç ï¼ˆåŠ å¯†ï¼‰',
    real_name VARCHAR(100) COMMENT 'çœŸå®å§“å',
    phone VARCHAR(20) COMMENT 'æ‰‹æœºå·ç ',
    avatar VARCHAR(255) COMMENT 'å¤´åƒURL',
    status INT DEFAULT 1 COMMENT 'ç”¨æˆ·çŠ¶æ€ï¼ˆ1-å¯ç”¨ï¼Œ0-ç¦ç”¨ï¼‰',
    last_login_time DATETIME COMMENT 'æœ€åç™»å½•æ—¶é—´',
    last_login_ip VARCHAR(45) COMMENT 'æœ€åç™»å½•IP',
    password_updated_at DATETIME COMMENT 'å¯†ç æ›´æ–°æ—¶é—´',
    email_verified BOOLEAN DEFAULT FALSE COMMENT 'é‚®ç®±æ˜¯å¦éªŒè¯',
    phone_verified BOOLEAN DEFAULT FALSE COMMENT 'æ‰‹æœºæ˜¯å¦éªŒè¯',
    two_factor_enabled BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦å¯ç”¨åŒå› å­è®¤è¯',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    created_by BIGINT COMMENT 'åˆ›å»ºäºº',
    updated_by BIGINT COMMENT 'æ›´æ–°äºº',

    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_phone (phone),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    INDEX idx_last_login_time (last_login_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç”¨æˆ·è¡¨';
```

#### è§’è‰²è¡¨ (roles)
```sql
CREATE TABLE roles (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'è§’è‰²ID',
    name VARCHAR(50) UNIQUE NOT NULL COMMENT 'è§’è‰²åç§°',
    code VARCHAR(50) UNIQUE NOT NULL COMMENT 'è§’è‰²ç¼–ç ',
    description VARCHAR(255) COMMENT 'è§’è‰²æè¿°',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE' COMMENT 'è§’è‰²çŠ¶æ€',
    is_system BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ç³»ç»Ÿè§’è‰²',
    sort_order INT DEFAULT 0 COMMENT 'æ’åº',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    created_by BIGINT COMMENT 'åˆ›å»ºäºº',
    updated_by BIGINT COMMENT 'æ›´æ–°äºº',
    
    INDEX idx_name (name),
    INDEX idx_code (code),
    INDEX idx_status (status),
    INDEX idx_sort_order (sort_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è§’è‰²è¡¨';
```

#### æƒé™è¡¨ (permissions)
```sql
CREATE TABLE permissions (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'æƒé™ID',
    name VARCHAR(100) UNIQUE NOT NULL COMMENT 'æƒé™åç§°',
    code VARCHAR(100) UNIQUE NOT NULL COMMENT 'æƒé™ç¼–ç ',
    resource VARCHAR(100) NOT NULL COMMENT 'èµ„æº',
    action VARCHAR(50) NOT NULL COMMENT 'æ“ä½œ',
    description VARCHAR(255) COMMENT 'æƒé™æè¿°',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE' COMMENT 'æƒé™çŠ¶æ€',
    is_system BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ç³»ç»Ÿæƒé™',
    parent_id BIGINT COMMENT 'çˆ¶æƒé™ID',
    sort_order INT DEFAULT 0 COMMENT 'æ’åº',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    
    INDEX idx_name (name),
    INDEX idx_code (code),
    INDEX idx_resource (resource),
    INDEX idx_action (action),
    INDEX idx_status (status),
    INDEX idx_parent_id (parent_id),
    INDEX idx_sort_order (sort_order),
    FOREIGN KEY (parent_id) REFERENCES permissions(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æƒé™è¡¨';
```

#### ç”¨æˆ·è§’è‰²å…³è”è¡¨ (user_roles)
```sql
CREATE TABLE user_roles (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'å…³è”ID',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    role_id BIGINT NOT NULL COMMENT 'è§’è‰²ID',
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ†é…æ—¶é—´',
    assigned_by BIGINT COMMENT 'åˆ†é…äºº',
    expires_at TIMESTAMP COMMENT 'è¿‡æœŸæ—¶é—´',
    
    UNIQUE KEY uk_user_role (user_id, role_id),
    INDEX idx_user_id (user_id),
    INDEX idx_role_id (role_id),
    INDEX idx_assigned_at (assigned_at),
    INDEX idx_expires_at (expires_at),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç”¨æˆ·è§’è‰²å…³è”è¡¨';
```

#### è§’è‰²æƒé™å…³è”è¡¨ (role_permissions)
```sql
CREATE TABLE role_permissions (
    id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰',
    role_id BIGINT NOT NULL COMMENT 'è§’è‰²ID',
    permission_id BIGINT NOT NULL COMMENT 'æƒé™ID',
    granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'æˆæƒæ—¶é—´',
    granted_by BIGINT COMMENT 'æˆæƒäºº',
    
    UNIQUE KEY uk_role_permission (role_id, permission_id),
    INDEX idx_role_id (role_id),
    INDEX idx_permission_id (permission_id),
    INDEX idx_granted_at (granted_at),
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è§’è‰²æƒé™å…³è”è¡¨';
```

### 3. å†…å®¹ç®¡ç†æ¨¡å—è¡¨è®¾è®¡

#### æ–‡æ¡£è¡¨ (documents)
```sql
CREATE TABLE documents (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'æ–‡æ¡£ID',
    title VARCHAR(255) NOT NULL COMMENT 'æ–‡æ¡£æ ‡é¢˜',
    summary TEXT COMMENT 'æ–‡æ¡£æ‘˜è¦',
    content LONGTEXT COMMENT 'æ–‡æ¡£å†…å®¹',
    category_id BIGINT COMMENT 'åˆ†ç±»ID',
    author_id BIGINT NOT NULL COMMENT 'ä½œè€…ID',
    status ENUM('DRAFT', 'PUBLISHED', 'ARCHIVED', 'DELETED') DEFAULT 'DRAFT' COMMENT 'æ–‡æ¡£çŠ¶æ€',
    version INT DEFAULT 1 COMMENT 'ç‰ˆæœ¬å·',
    view_count BIGINT DEFAULT 0 COMMENT 'æŸ¥çœ‹æ¬¡æ•°',
    download_count BIGINT DEFAULT 0 COMMENT 'ä¸‹è½½æ¬¡æ•°',
    like_count BIGINT DEFAULT 0 COMMENT 'ç‚¹èµæ•°',
    comment_count BIGINT DEFAULT 0 COMMENT 'è¯„è®ºæ•°',
    file_path VARCHAR(500) COMMENT 'æ–‡ä»¶è·¯å¾„',
    file_size BIGINT COMMENT 'æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰',
    file_type VARCHAR(50) COMMENT 'æ–‡ä»¶ç±»å‹',
    thumbnail_path VARCHAR(500) COMMENT 'ç¼©ç•¥å›¾è·¯å¾„',
    is_top BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ç½®é¡¶',
    is_featured BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦æ¨è',
    published_at TIMESTAMP NULL COMMENT 'å‘å¸ƒæ—¶é—´',
    archived_at TIMESTAMP NULL COMMENT 'å½’æ¡£æ—¶é—´',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    created_by BIGINT COMMENT 'åˆ›å»ºäºº',
    updated_by BIGINT COMMENT 'æ›´æ–°äºº',
    
    INDEX idx_title (title),
    INDEX idx_category_id (category_id),
    INDEX idx_author_id (author_id),
    INDEX idx_status (status),
    INDEX idx_published_at (published_at),
    INDEX idx_created_at (created_at),
    INDEX idx_updated_at (updated_at),
    INDEX idx_view_count (view_count),
    INDEX idx_is_top (is_top),
    INDEX idx_is_featured (is_featured),
    FULLTEXT INDEX ft_title_content (title, content),
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL,
    FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æ–‡æ¡£è¡¨';
```

#### åˆ†ç±»è¡¨ (categories)
```sql
CREATE TABLE categories (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'åˆ†ç±»ID',
    name VARCHAR(100) NOT NULL COMMENT 'åˆ†ç±»åç§°',
    code VARCHAR(50) UNIQUE COMMENT 'åˆ†ç±»ç¼–ç ',
    description TEXT COMMENT 'åˆ†ç±»æè¿°',
    parent_id BIGINT COMMENT 'çˆ¶åˆ†ç±»ID',
    icon VARCHAR(100) COMMENT 'å›¾æ ‡',
    sort_order INT DEFAULT 0 COMMENT 'æ’åº',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE' COMMENT 'åˆ†ç±»çŠ¶æ€',
    document_count BIGINT DEFAULT 0 COMMENT 'æ–‡æ¡£æ•°é‡',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    created_by BIGINT COMMENT 'åˆ›å»ºäºº',
    updated_by BIGINT COMMENT 'æ›´æ–°äºº',
    
    INDEX idx_name (name),
    INDEX idx_code (code),
    INDEX idx_parent_id (parent_id),
    INDEX idx_status (status),
    INDEX idx_sort_order (sort_order),
    INDEX idx_document_count (document_count),
    FOREIGN KEY (parent_id) REFERENCES categories(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='åˆ†ç±»è¡¨';
```

#### æ ‡ç­¾è¡¨ (tags)
```sql
CREATE TABLE tags (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'æ ‡ç­¾ID',
    name VARCHAR(50) UNIQUE NOT NULL COMMENT 'æ ‡ç­¾åç§°',
    color VARCHAR(7) DEFAULT '#1890ff' COMMENT 'æ ‡ç­¾é¢œè‰²',
    description VARCHAR(255) COMMENT 'æ ‡ç­¾æè¿°',
    usage_count BIGINT DEFAULT 0 COMMENT 'ä½¿ç”¨æ¬¡æ•°',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE' COMMENT 'æ ‡ç­¾çŠ¶æ€',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    created_by BIGINT COMMENT 'åˆ›å»ºäºº',
    
    INDEX idx_name (name),
    INDEX idx_status (status),
    INDEX idx_usage_count (usage_count)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æ ‡ç­¾è¡¨';
```

#### æ–‡æ¡£æ ‡ç­¾å…³è”è¡¨ (document_tags)
```sql
CREATE TABLE document_tags (
    id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰',
    document_id BIGINT NOT NULL COMMENT 'æ–‡æ¡£ID',
    tag_id BIGINT NOT NULL COMMENT 'æ ‡ç­¾ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    created_by BIGINT COMMENT 'åˆ›å»ºäºº',
    
    UNIQUE KEY uk_document_tag (document_id, tag_id),
    INDEX idx_document_id (document_id),
    INDEX idx_tag_id (tag_id),
    INDEX idx_created_at (created_at),
    FOREIGN KEY (document_id) REFERENCES documents(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æ–‡æ¡£æ ‡ç­¾å…³è”è¡¨';
```

### 4. å·¥ä½œæµæ¨¡å—è¡¨è®¾è®¡

#### æµç¨‹å®šä¹‰è¡¨ (process_definitions)
```sql
CREATE TABLE process_definitions (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'æµç¨‹å®šä¹‰ID',
    name VARCHAR(255) NOT NULL COMMENT 'æµç¨‹åç§°',
    key VARCHAR(100) UNIQUE NOT NULL COMMENT 'æµç¨‹é”®',
    version INT DEFAULT 1 COMMENT 'ç‰ˆæœ¬å·',
    description TEXT COMMENT 'æµç¨‹æè¿°',
    bpmn_xml LONGTEXT NOT NULL COMMENT 'BPMN XMLå†…å®¹',
    status ENUM('ACTIVE', 'INACTIVE', 'DEPRECATED') DEFAULT 'ACTIVE' COMMENT 'æµç¨‹çŠ¶æ€',
    category VARCHAR(100) COMMENT 'æµç¨‹åˆ†ç±»',
    start_form_config JSON COMMENT 'å¯åŠ¨è¡¨å•é…ç½®',
    is_system BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ç³»ç»Ÿæµç¨‹',
    deployed_at TIMESTAMP NULL COMMENT 'éƒ¨ç½²æ—¶é—´',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    created_by BIGINT COMMENT 'åˆ›å»ºäºº',
    updated_by BIGINT COMMENT 'æ›´æ–°äºº',
    
    INDEX idx_name (name),
    INDEX idx_key (key),
    INDEX idx_version (version),
    INDEX idx_status (status),
    INDEX idx_category (category),
    INDEX idx_deployed_at (deployed_at),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æµç¨‹å®šä¹‰è¡¨';
```

#### æµç¨‹å®ä¾‹è¡¨ (process_instances)
```sql
CREATE TABLE process_instances (
    id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰',
    process_definition_id BIGINT NOT NULL COMMENT 'æµç¨‹å®šä¹‰ID',
    process_definition_key VARCHAR(100) NOT NULL COMMENT 'æµç¨‹å®šä¹‰é”®',
    business_key VARCHAR(255) COMMENT 'ä¸šåŠ¡é”®',
    name VARCHAR(255) COMMENT 'æµç¨‹å®ä¾‹åç§°',
    status ENUM('RUNNING', 'COMPLETED', 'SUSPENDED', 'TERMINATED') DEFAULT 'RUNNING' COMMENT 'æµç¨‹çŠ¶æ€',
    start_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'å¼€å§‹æ—¶é—´',
    end_time TIMESTAMP NULL COMMENT 'ç»“æŸæ—¶é—´',
    duration BIGINT COMMENT 'æŒç»­æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰',
    started_by BIGINT COMMENT 'å¯åŠ¨äºº',
    current_activity VARCHAR(255) COMMENT 'å½“å‰æ´»åŠ¨',
    variables JSON COMMENT 'æµç¨‹å˜é‡',
    delete_reason VARCHAR(255) COMMENT 'åˆ é™¤åŸå› ',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    
    INDEX idx_process_definition_id (process_definition_id),
    INDEX idx_process_definition_key (process_definition_key),
    INDEX idx_business_key (business_key),
    INDEX idx_status (status),
    INDEX idx_start_time (start_time),
    INDEX idx_end_time (end_time),
    INDEX idx_started_by (started_by),
    INDEX idx_current_activity (current_activity),
    FOREIGN KEY (process_definition_id) REFERENCES process_definitions(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æµç¨‹å®ä¾‹è¡¨';
```

#### ä»»åŠ¡å®ä¾‹è¡¨ (task_instances)
```sql
CREATE TABLE task_instances (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ä»»åŠ¡ID',
    process_instance_id BIGINT NOT NULL COMMENT 'æµç¨‹å®ä¾‹ID',
    name VARCHAR(255) NOT NULL COMMENT 'ä»»åŠ¡åç§°',
    description TEXT COMMENT 'ä»»åŠ¡æè¿°',
    assignee BIGINT COMMENT 'åˆ†é…äºº',
    owner BIGINT COMMENT 'ä»»åŠ¡æ‰€æœ‰è€…',
    status ENUM('ACTIVE', 'COMPLETED', 'CANCELLED') DEFAULT 'ACTIVE' COMMENT 'ä»»åŠ¡çŠ¶æ€',
    priority INT DEFAULT 50 COMMENT 'ä¼˜å…ˆçº§',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    due_time TIMESTAMP NULL COMMENT 'åˆ°æœŸæ—¶é—´',
    completion_time TIMESTAMP NULL COMMENT 'å®Œæˆæ—¶é—´',
    duration BIGINT COMMENT 'å¤„ç†æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰',
    variables JSON COMMENT 'ä»»åŠ¡å˜é‡',
    form_key VARCHAR(255) COMMENT 'è¡¨å•é”®',
    category VARCHAR(100) COMMENT 'ä»»åŠ¡åˆ†ç±»',
    parent_task_id BIGINT COMMENT 'çˆ¶ä»»åŠ¡ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    
    INDEX idx_process_instance_id (process_instance_id),
    INDEX idx_assignee (assignee),
    INDEX idx_owner (owner),
    INDEX idx_status (status),
    INDEX idx_priority (priority),
    INDEX idx_create_time (create_time),
    INDEX idx_due_time (due_time),
    INDEX idx_completion_time (completion_time),
    INDEX idx_category (category),
    INDEX idx_parent_task_id (parent_task_id),
    FOREIGN KEY (process_instance_id) REFERENCES process_instances(id) ON DELETE CASCADE,
    FOREIGN KEY (assignee) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (owner) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (parent_task_id) REFERENCES task_instances(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ä»»åŠ¡å®ä¾‹è¡¨';
```

### 5. ç³»ç»Ÿæ¨¡å—è¡¨è®¾è®¡

#### ç³»ç»Ÿé…ç½®è¡¨ (system_configs)
```sql
CREATE TABLE system_configs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'é…ç½®ID',
    module VARCHAR(50) NOT NULL COMMENT 'æ¨¡å—',
    config_key VARCHAR(100) NOT NULL COMMENT 'é…ç½®é”®',
    config_value TEXT COMMENT 'é…ç½®å€¼',
    config_type ENUM('STRING', 'NUMBER', 'BOOLEAN', 'JSON') DEFAULT 'STRING' COMMENT 'é…ç½®ç±»å‹',
    description VARCHAR(255) COMMENT 'é…ç½®æè¿°',
    is_encrypted BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦åŠ å¯†',
    is_system BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ç³»ç»Ÿé…ç½®',
    sort_order INT DEFAULT 0 COMMENT 'æ’åº',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE' COMMENT 'é…ç½®çŠ¶æ€',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    created_by BIGINT COMMENT 'åˆ›å»ºäºº',
    updated_by BIGINT COMMENT 'æ›´æ–°äºº',
    
    UNIQUE KEY uk_module_key (module, config_key),
    INDEX idx_module (module),
    INDEX idx_config_key (config_key),
    INDEX idx_status (status),
    INDEX idx_sort_order (sort_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç³»ç»Ÿé…ç½®è¡¨';
```

#### æ“ä½œæ—¥å¿—è¡¨ (operation_logs)
```sql
CREATE TABLE operation_logs (
    id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰',
    user_id BIGINT COMMENT 'ç”¨æˆ·ID',
    username VARCHAR(50) COMMENT 'ç”¨æˆ·å',
    operation VARCHAR(100) NOT NULL COMMENT 'æ“ä½œç±»å‹',
    module VARCHAR(50) NOT NULL COMMENT 'æ¨¡å—',
    method VARCHAR(10) NOT NULL COMMENT 'è¯·æ±‚æ–¹æ³•',
    request_uri VARCHAR(500) NOT NULL COMMENT 'è¯·æ±‚URI',
    request_params TEXT COMMENT 'è¯·æ±‚å‚æ•°',
    response_result TEXT COMMENT 'å“åº”ç»“æœ',
    client_ip VARCHAR(45) COMMENT 'å®¢æˆ·ç«¯IP',
    user_agent VARCHAR(500) COMMENT 'ç”¨æˆ·ä»£ç†',
    status ENUM('SUCCESS', 'FAILURE') NOT NULL COMMENT 'æ“ä½œçŠ¶æ€',
    error_message TEXT COMMENT 'é”™è¯¯ä¿¡æ¯',
    execution_time BIGINT COMMENT 'æ‰§è¡Œæ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    
    INDEX idx_user_id (user_id),
    INDEX idx_username (username),
    INDEX idx_operation (operation),
    INDEX idx_module (module),
    INDEX idx_status (status),
    INDEX idx_client_ip (client_ip),
    INDEX idx_created_at (created_at),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æ“ä½œæ—¥å¿—è¡¨';
```

## ğŸ“„ MongoDBæ•°æ®åº“è®¾è®¡

### 1. æ•°æ®åº“é…ç½®

#### MongoDBé…ç½®
```yaml
spring:
  data:
    mongodb:
      host: mongodb-primary:27017
      database: spring4demo
      username: ${MONGO_USERNAME}
      password: ${MONGO_PASSWORD}
      authentication-database: admin
      auto-index-creation: true
```

### 2. é›†åˆè®¾è®¡

#### æ–‡æ¡£å†…å®¹é›†åˆ (document_contents)
```javascript
// æ–‡æ¡£å†…å®¹é›†åˆ
{
  _id: ObjectId,
  documentId: NumberLong(123),           // å…³è”MySQLæ–‡æ¡£ID
  title: "æ–‡æ¡£æ ‡é¢˜",
  content: "æ–‡æ¡£å†…å®¹...",
  htmlContent: "<p>HTMLæ ¼å¼å†…å®¹</p>",     // å¯Œæ–‡æœ¬å†…å®¹
  attachments: [                        // é™„ä»¶åˆ—è¡¨
    {
      id: ObjectId,
      name: "é™„ä»¶åç§°.pdf",
      path: "/files/attachments/xxx.pdf",
      size: NumberLong(1024000),
      type: "application/pdf",
      uploadedAt: ISODate("2025-12-24T10:30:00Z"),
      uploadedBy: NumberLong(456)
    }
  ],
  versions: [                           // ç‰ˆæœ¬å†å²
    {
      version: 1,
      content: "ç‰ˆæœ¬1å†…å®¹",
      modifiedAt: ISODate("2025-12-24T10:30:00Z"),
      modifiedBy: NumberLong(456),
      changeLog: "åˆå§‹ç‰ˆæœ¬"
    }
  ],
  metadata: {                           // å…ƒæ•°æ®
    wordCount: NumberInt(1000),
    readingTime: NumberInt(5),          // é¢„è®¡é˜…è¯»æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
    difficulty: "medium",               // éš¾åº¦çº§åˆ«
    tags: ["æŠ€æœ¯", "æ–‡æ¡£"],
    category: "æŠ€æœ¯æ–‡æ¡£"
  },
  seo: {                               // SEOä¿¡æ¯
    keywords: ["å…³é”®è¯1", "å…³é”®è¯2"],
    description: "é¡µé¢æè¿°",
    ogTitle: "ç¤¾äº¤åˆ†äº«æ ‡é¢˜",
    ogImage: "https://example.com/image.jpg"
  },
  createdAt: ISODate("2025-12-24T10:30:00Z"),
  updatedAt: ISODate("2025-12-24T10:30:00Z")
}

// ç´¢å¼•
db.document_contents.createIndex({ "documentId": 1 }, { unique: true })
db.document_contents.createIndex({ "title": "text", "content": "text" })
db.document_contents.createIndex({ "metadata.tags": 1 })
db.document_contents.createIndex({ "createdAt": -1 })
```

#### ç”¨æˆ·æ´»åŠ¨æ—¥å¿—é›†åˆ (user_activities)
```javascript
// ç”¨æˆ·æ´»åŠ¨æ—¥å¿—é›†åˆ
{
  _id: ObjectId,
  userId: NumberLong(123),              // ç”¨æˆ·ID
  username: "john_doe",                // ç”¨æˆ·å
  sessionId: "sess_123456789",         // ä¼šè¯ID
  activityType: "LOGIN",                // æ´»åŠ¨ç±»å‹
  activity: "ç”¨æˆ·ç™»å½•",                 // æ´»åŠ¨æè¿°
  module: "AUTH",                       // æ¨¡å—
  details: {                            // è¯¦ç»†ä¿¡æ¯
    ip: "192.168.1.100",
    userAgent: "Mozilla/5.0...",
    location: {
      country: "ä¸­å›½",
      city: "åŒ—äº¬",
      coordinates: [116.4074, 39.9042]
    },
    device: {
      type: "desktop",
      os: "Windows 10",
      browser: "Chrome 91.0"
    }
  },
  result: "SUCCESS",                    // æ‰§è¡Œç»“æœ
  duration: NumberLong(150),            // æ‰§è¡Œæ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
  timestamp: ISODate("2025-12-24T10:30:00Z")
}

// ç´¢å¼•
db.user_activities.createIndex({ "userId": 1, "timestamp": -1 })
db.user_activities.createIndex({ "activityType": 1, "timestamp": -1 })
db.user_activities.createIndex({ "sessionId": 1 })
db.user_activities.createIndex({ "timestamp": -1 })
```

#### æ¶ˆæ¯é€šçŸ¥é›†åˆ (notifications)
```javascript
// æ¶ˆæ¯é€šçŸ¥é›†åˆ
{
  _id: ObjectId,
  recipientId: NumberLong(123),         // æ¥æ”¶äººID
  senderId: NumberLong(456),            // å‘é€äººID
  type: "SYSTEM",                       // é€šçŸ¥ç±»å‹
  category: "REMINDER",                 // é€šçŸ¥åˆ†ç±»
  title: "ç³»ç»Ÿé€šçŸ¥",                     // é€šçŸ¥æ ‡é¢˜
  content: "æ‚¨æœ‰ä¸€ä¸ªæ–°çš„å¾…åŠä»»åŠ¡",       // é€šçŸ¥å†…å®¹
  actionUrl: "/tasks/789",              // æ“ä½œé“¾æ¥
  actionText: "æŸ¥çœ‹è¯¦æƒ…",                // æ“ä½œæŒ‰é’®æ–‡æœ¬
  priority: "NORMAL",                   // ä¼˜å…ˆçº§
  status: "UNREAD",                     // çŠ¶æ€
  readAt: null,                         // é˜…è¯»æ—¶é—´
  metadata: {                           // å…ƒæ•°æ®
    relatedId: NumberLong(789),         // å…³è”å¯¹è±¡ID
    relatedType: "TASK",                // å…³è”å¯¹è±¡ç±»å‹
    template: "task_assigned",          // æ¨¡æ¿åç§°
    variables: {                        // æ¨¡æ¿å˜é‡
      taskName: "å®¡æ ¸æ–‡æ¡£",
      assignee: "å¼ ä¸‰"
    }
  },
  channels: ["WEB", "EMAIL", "SMS"],     // é€šçŸ¥æ¸ é“
  sentAt: ISODate("2025-12-24T10:30:00Z"),
  createdAt: ISODate("2025-12-24T10:30:00Z"),
  expiresAt: ISODate("2025-12-31T23:59:59Z")
}

// ç´¢å¼•
db.notifications.createIndex({ "recipientId": 1, "status": 1, "createdAt": -1 })
db.notifications.createIndex({ "type": 1, "status": 1 })
db.notifications.createIndex({ "expiresAt": 1 }, { expireAfterSeconds: 0 })
```

## ğŸ—„ï¸ Redisç¼“å­˜è®¾è®¡

### 1. Redisé…ç½®

#### Redisé›†ç¾¤é…ç½®
```yaml
spring:
  redis:
    cluster:
      nodes:
        - redis-node1:6379
        - redis-node2:6379
        - redis-node3:6379
        - redis-node4:6379
        - redis-node5:6379
        - redis-node6:6379
    password: ${REDIS_PASSWORD}
    timeout: 3000ms
    lettuce:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0
        max-wait: -1ms
```

### 2. ç¼“å­˜ç­–ç•¥è®¾è®¡

#### ç¼“å­˜é”®å‘½åè§„èŒƒ
```yaml
# ç¼“å­˜é”®å‘½åè§„èŒƒ
spring4demo:{module}:{type}:{id}:{field?}

# ç¤ºä¾‹
spring4demo:user:info:123              # ç”¨æˆ·ä¿¡æ¯ç¼“å­˜
spring4demo:user:permissions:123       # ç”¨æˆ·æƒé™ç¼“å­˜
spring4demo:document:content:456       # æ–‡æ¡£å†…å®¹ç¼“å­˜
spring4demo:category:tree:root         # åˆ†ç±»æ ‘ç¼“å­˜
spring4demo:config:system:all          # ç³»ç»Ÿé…ç½®ç¼“å­˜
```

#### ç¼“å­˜ç­–ç•¥é…ç½®
```java
@Configuration
@EnableCaching
public class CacheConfig {
    
    @Bean
    public CacheManager cacheManager(RedisConnectionFactory connectionFactory) {
        Map<String, RedisCacheConfiguration> cacheConfigurations = new HashMap<>();
        
        // ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ - 30åˆ†é’Ÿ
        cacheConfigurations.put("userInfo", RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(30))
            .serializeKeysWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new GenericJackson2JsonRedisSerializer())));
        
        // ç”¨æˆ·æƒé™ç¼“å­˜ - 15åˆ†é’Ÿ
        cacheConfigurations.put("userPermissions", RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(15))
            .serializeKeysWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new GenericJackson2JsonRedisSerializer())));
        
        // æ–‡æ¡£å†…å®¹ç¼“å­˜ - 2å°æ—¶
        cacheConfigurations.put("documentContent", RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofHours(2))
            .serializeKeysWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new GenericJackson2JsonRedisSerializer())));
        
        // ç³»ç»Ÿé…ç½®ç¼“å­˜ - 1å°æ—¶
        cacheConfigurations.put("systemConfig", RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofHours(1))
            .serializeKeysWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new GenericJackson2JsonRedisSerializer())));
        
        return RedisCacheManager.builder(connectionFactory)
            .withInitialCacheConfigurations(cacheConfigurations)
            .build();
    }
}
```

#### ç¼“å­˜ä½¿ç”¨ç¤ºä¾‹
```java
@Service
public class UserServiceImpl implements UserService {
    
    @Cacheable(value = "userInfo", key = "#userId")
    public UserDTO getUserById(Long userId) {
        User user = userRepository.findById(userId)
            .orElseThrow(() -> new UserNotFoundException("User not found"));
        return UserMapper.toDTO(user);
    }
    
    @CacheEvict(value = "userInfo", key = "#userId")
    public void evictUserCache(Long userId) {
        // æ¸…é™¤ç”¨æˆ·ç¼“å­˜
    }
    
    @CachePut(value = "userInfo", key = "#user.id")
    public UserDTO updateUser(User user) {
        User savedUser = userRepository.save(user);
        return UserMapper.toDTO(savedUser);
    }
}
```

### 3. ä¼šè¯ç®¡ç†

#### JWT Tokenç¼“å­˜
```java
@Component
public class TokenCacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final String TOKEN_PREFIX = "spring4demo:token:";
    private static final Duration TOKEN_EXPIRE = Duration.ofHours(24);
    
    public void cacheToken(String token, UserDTO user) {
        String key = TOKEN_PREFIX + token;
        redisTemplate.opsForValue().set(key, user, TOKEN_EXPIRE);
    }
    
    public UserDTO getToken(String token) {
        String key = TOKEN_PREFIX + token;
        return (UserDTO) redisTemplate.opsForValue().get(key);
    }
    
    public void evictToken(String token) {
        String key = TOKEN_PREFIX + token;
        redisTemplate.delete(key);
    }
    
    public void evictUserTokens(Long userId) {
        String pattern = TOKEN_PREFIX + "*";
        Set<String> keys = redisTemplate.keys(pattern);
        if (!keys.isEmpty()) {
            redisTemplate.delete(keys);
        }
    }
}
```

## ğŸ” Elasticsearchæœç´¢å¼•æ“è®¾è®¡

### 1. Elasticsearché…ç½®

#### ESé›†ç¾¤é…ç½®
```yaml
spring:
  elasticsearch:
    uris:
      - http://es-node1:9200
      - http://es-node2:9200
      - http://es-node3:9200
    username: ${ES_USERNAME}
    password: ${ES_PASSWORD}
    connection-timeout: 5s
    socket-timeout: 30s
```

### 2. ç´¢å¼•è®¾è®¡

#### æ–‡æ¡£ç´¢å¼• (documents)
```json
{
  "mappings": {
    "properties": {
      "documentId": {
        "type": "long"
      },
      "title": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart",
        "fields": {
          "keyword": {
            "type": "keyword"
          }
        }
      },
      "content": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart"
      },
      "summary": {
        "type": "text",
        "analyzer": "ik_max_word"
      },
      "authorId": {
        "type": "long"
      },
      "authorName": {
        "type": "keyword"
      },
      "categoryId": {
        "type": "long"
      },
      "categoryName": {
        "type": "keyword"
      },
      "tags": {
        "type": "keyword"
      },
      "status": {
        "type": "keyword"
      },
      "viewCount": {
        "type": "long"
      },
      "likeCount": {
        "type": "long"
      },
      "isTop": {
        "type": "boolean"
      },
      "isFeatured": {
        "type": "boolean"
      },
      "publishedAt": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"
      },
      "createdAt": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"
      },
      "updatedAt": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"
      }
    }
  },
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1,
    "analysis": {
      "analyzer": {
        "ik_max_word": {
          "type": "ik_max_word"
        },
        "ik_smart": {
          "type": "ik_smart"
        }
      }
    }
  }
}
```

#### æœç´¢æœåŠ¡å®ç°
```java
@Service
public class DocumentSearchService {
    
    @Autowired
    private ElasticsearchOperations elasticsearchOperations;
    
    public void indexDocument(Document document) {
        DocumentSearchDocument searchDocument = DocumentSearchMapper.toSearchDocument(document);
        
        IndexQuery indexQuery = new IndexQueryBuilder()
            .withId(document.getId().toString())
            .withObject(searchDocument)
            .build();
        
        elasticsearchOperations.index(indexQuery);
    }
    
    public SearchResult<DocumentDTO> searchDocuments(DocumentSearchRequest request) {
        BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();
        
        // å…³é”®è¯æœç´¢
        if (StringUtils.hasText(request.getKeyword())) {
            MultiMatchQueryBuilder multiMatchQuery = QueryBuilders.multiMatchQuery(request.getKeyword())
                .field("title", 2.0f)
                .field("content", 1.0f)
                .field("summary", 1.5f)
                .type(MultiMatchQueryBuilder.Type.BEST_FIELDS)
                .fuzziness("AUTO");
            
            boolQuery.must(multiMatchQuery);
        }
        
        // åˆ†ç±»è¿‡æ»¤
        if (request.getCategoryIds() != null && !request.getCategoryIds().isEmpty()) {
            boolQuery.filter(QueryBuilders.termsQuery("categoryId", request.getCategoryIds()));
        }
        
        // çŠ¶æ€è¿‡æ»¤
        if (request.getStatus() != null) {
            boolQuery.filter(QueryBuilders.termQuery("status", request.getStatus()));
        }
        
        // æ ‡ç­¾è¿‡æ»¤
        if (request.getTags() != null && !request.getTags().isEmpty()) {
            boolQuery.filter(QueryBuilders.termsQuery("tags", request.getTags()));
        }
        
        // æ—¥æœŸèŒƒå›´è¿‡æ»¤
        if (request.getStartDate() != null || request.getEndDate() != null) {
            RangeQueryBuilder rangeQuery = QueryBuilders.rangeQuery("publishedAt");
            if (request.getStartDate() != null) {
                rangeQuery.gte(request.getStartDate());
            }
            if (request.getEndDate() != null) {
                rangeQuery.lte(request.getEndDate());
            }
            boolQuery.filter(rangeQuery);
        }
        
        // æ’åº
        List<SortBuilder<?>> sorts = new ArrayList<>();
        if ("relevance".equals(request.getSortBy())) {
            sorts.add(ScoreSortBuilder.DESC);
        } else if ("date".equals(request.getSortBy())) {
            sorts.add(FieldSortBuilder.DESC.field("publishedAt"));
        } else if ("views".equals(request.getSortBy())) {
            sorts.add(FieldSortBuilder.DESC.field("viewCount"));
        } else if ("likes".equals(request.getSortBy())) {
            sorts.add(FieldSortBuilder.DESC.field("likeCount"));
        }
        
        // æ„å»ºæŸ¥è¯¢
        NativeSearchQuery searchQuery = new NativeSearchQueryBuilder()
            .withQuery(boolQuery)
            .withSorts(sorts)
            .withPageable(PageRequest.of(request.getPage(), request.getSize()))
            .withHighlightFields(
                new HighlightBuilder.Field("title"),
                new HighlightBuilder.Field("content").fragmentSize(150).numOfFragments(3)
            )
            .build();
        
        SearchHits<DocumentSearchDocument> searchHits = elasticsearchOperations
            .search(searchQuery, DocumentSearchDocument.class);
        
        // è½¬æ¢ç»“æœ
        List<DocumentDTO> documents = searchHits.getSearchHits().stream()
            .map(hit -> {
                DocumentSearchDocument doc = hit.getContent();
                DocumentDTO dto = DocumentMapper.toDTO(doc);
                dto.setScore(hit.getScore());
                
                // è®¾ç½®é«˜äº®ç‰‡æ®µ
                if (hit.getHighlightFields() != null) {
                    Map<String, List<String>> highlightFields = hit.getHighlightFields();
                    if (highlightFields.containsKey("title")) {
                        dto.setHighlightTitle(String.join("...", highlightFields.get("title")));
                    }
                    if (highlightFields.containsKey("content")) {
                        dto.setHighlightContent(String.join("...", highlightFields.get("content")));
                    }
                }
                
                return dto;
            })
            .collect(Collectors.toList());
        
        return SearchResult.<DocumentDTO>builder()
            .content(documents)
            .totalElements(searchHits.getTotalHits())
            .currentPage(request.getPage())
            .pageSize(request.getSize())
            .totalPages((int) Math.ceil((double) searchHits.getTotalHits() / request.getSize()))
            .build();
    }
}
```

## ğŸ”„ æ•°æ®åŒæ­¥ç­–ç•¥

### 1. MySQLä¸»ä»åŒæ­¥

#### ä¸»ä»å¤åˆ¶é…ç½®
```sql
-- ä¸»åº“é…ç½® (my.cnf)
[mysqld]
server-id=1
log-bin=mysql-bin
binlog-format=ROW
binlog-do-db=spring4demo
expire_logs_days=7
max_binlog_size=100M

-- ä»åº“é…ç½® (my.cnf)
[mysqld]
server-id=2
relay-log=relay-bin
read-only=1
replicate-do-db=spring4demo
```

#### è¯»å†™åˆ†ç¦»å®ç°
```java
@Configuration
public class DataSourceConfig {
    
    @Bean
    @Primary
    public DataSource masterDataSource() {
        return DataSourceBuilder.create()
            .driverClassName("com.mysql.cj.jdbc.Driver")
            .url(masterUrl)
            .username(username)
            .password(password)
            .build();
    }
    
    @Bean
    public DataSource slaveDataSource() {
        return DataSourceBuilder.create()
            .driverClassName("com.mysql.cj.jdbc.Driver")
            .url(slaveUrl)
            .username(username)
            .password(password)
            .build();
    }
    
    @Bean
    public DataSource routingDataSource() {
        RoutingDataSource routingDataSource = new RoutingDataSource();
        Map<Object, Object> dataSourceMap = new HashMap<>();
        dataSourceMap.put("master", masterDataSource());
        dataSourceMap.put("slave", slaveDataSource());
        routingDataSource.setTargetDataSources(dataSourceMap);
        routingDataSource.setDefaultTargetDataSource(masterDataSource());
        return routingDataSource;
    }
}

// è¯»å†™åˆ†ç¦»æ³¨è§£
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface ReadOnly {
}

// AOPåˆ‡é¢å®ç°
@Aspect
@Component
public class DataSourceAspect {
    
    @Before("@annotation(readOnly)")
    public void setReadDataSource(ReadOnly readOnly) {
        DataSourceContextHolder.setDataSource("slave");
    }
    
    @After("@annotation(readOnly)")
    public void clearDataSource() {
        DataSourceContextHolder.clearDataSource();
    }
}
```

### 2. ç¼“å­˜åŒæ­¥ç­–ç•¥

#### ç¼“å­˜æ›´æ–°ç­–ç•¥
```java
@Component
public class CacheSyncService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    // å†™å…¥æ—¶åŒæ­¥æ›´æ–°ç¼“å­˜
    @CacheEvict(value = "userInfo", key = "#user.id")
    public UserDTO updateUser(User user) {
        User savedUser = userRepository.save(user);
        
        // å‘å¸ƒç¼“å­˜æ›´æ–°äº‹ä»¶
        eventPublisher.publishEvent(new UserUpdatedEvent(savedUser.getId()));
        
        return UserMapper.toDTO(savedUser);
    }
    
    // ç›‘å¬ç¼“å­˜æ›´æ–°äº‹ä»¶
    @EventListener
    @Async
    public void handleUserUpdatedEvent(UserUpdatedEvent event) {
        // æ¸…é™¤ç›¸å…³ç¼“å­˜
        String pattern = "spring4demo:user:*:" + event.getUserId();
        Set<String> keys = redisTemplate.keys(pattern);
        if (!keys.isEmpty()) {
            redisTemplate.delete(keys);
        }
        
        // é¢„çƒ­çƒ­ç‚¹æ•°æ®
        warmUpUserCache(event.getUserId());
    }
    
    private void warmUpUserCache(Long userId) {
        // é¢„çƒ­ç”¨æˆ·ä¿¡æ¯ç¼“å­˜
        UserDTO user = userService.getUserById(userId);
        redisTemplate.opsForValue().set(
            "spring4demo:user:info:" + userId, 
            user, 
            Duration.ofMinutes(30)
        );
    }
}
```

### 3. æœç´¢ç´¢å¼•åŒæ­¥

#### ç´¢å¼•åŒæ­¥å®ç°
```java
@Component
public class SearchIndexSyncService {
    
    @Autowired
    private DocumentSearchService documentSearchService;
    
    @EventListener
    @Async
    public void handleDocumentCreatedEvent(DocumentCreatedEvent event) {
        // æ–‡æ¡£åˆ›å»ºæ—¶åŒæ­¥åˆ°æœç´¢ç´¢å¼•
        Document document = documentRepository.findById(event.getDocumentId()).orElse(null);
        if (document != null) {
            documentSearchService.indexDocument(document);
        }
    }
    
    @EventListener
    @Async
    public void handleDocumentUpdatedEvent(DocumentUpdatedEvent event) {
        // æ–‡æ¡£æ›´æ–°æ—¶åŒæ­¥åˆ°æœç´¢ç´¢å¼•
        Document document = documentRepository.findById(event.getDocumentId()).orElse(null);
        if (document != null) {
            documentSearchService.indexDocument(document);
        }
    }
    
    @EventListener
    @Async
    public void handleDocumentDeletedEvent(DocumentDeletedEvent event) {
        // æ–‡æ¡£åˆ é™¤æ—¶ä»æœç´¢ç´¢å¼•ä¸­åˆ é™¤
        documentSearchService.deleteDocument(event.getDocumentId());
    }
    
    // å®šæœŸå…¨é‡åŒæ­¥
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    public void fullSync() {
        log.info("å¼€å§‹å…¨é‡åŒæ­¥æœç´¢ç´¢å¼•");
        
        try {
            // åˆ é™¤ç°æœ‰ç´¢å¼•
            documentSearchService.deleteIndex();
            
            // é‡æ–°åˆ›å»ºç´¢å¼•
            documentSearchService.createIndex();
            
            // æ‰¹é‡ç´¢å¼•æ‰€æœ‰æ–‡æ¡£
            int pageSize = 1000;
            int page = 0;
            boolean hasMore = true;
            
            while (hasMore) {
                Pageable pageable = PageRequest.of(page, pageSize);
                Page<Document> documents = documentRepository.findAll(pageable);
                
                if (documents.hasContent()) {
                    documentSearchService.batchIndexDocuments(documents.getContent());
                    page++;
                } else {
                    hasMore = false;
                }
            }
            
            log.info("å…¨é‡åŒæ­¥æœç´¢ç´¢å¼•å®Œæˆ");
            
        } catch (Exception e) {
            log.error("å…¨é‡åŒæ­¥æœç´¢ç´¢å¼•å¤±è´¥", e);
        }
    }
}
```

## ğŸ“ˆ æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

### 1. MySQLæ€§èƒ½ä¼˜åŒ–

#### ç´¢å¼•ä¼˜åŒ–ç­–ç•¥
```sql
-- å¤åˆç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_documents_category_status_published ON documents(category_id, status, published_at);
CREATE INDEX idx_users_status_created_at ON users(status, created_at);
CREATE INDEX idx_tasks_assignee_status ON task_instances(assignee, status);

-- è¦†ç›–ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_documents_list_covering ON documents(status, category_id, published_at) 
INCLUDE (id, title, author_id, view_count);

-- å‡½æ•°ç´¢å¼•ï¼ˆMySQL 8.0+ï¼‰
CREATE INDEX idx_documents_title_lower ON documents((LOWER(title)));
CREATE INDEX idx_users_email_lower ON users((LOWER(email)));
```

#### æŸ¥è¯¢ä¼˜åŒ–
```sql
-- ä¼˜åŒ–å‰ï¼šå…¨è¡¨æ‰«æ
SELECT * FROM documents WHERE title LIKE '%keyword%';

-- ä¼˜åŒ–åï¼šä½¿ç”¨å…¨æ–‡ç´¢å¼•
SELECT * FROM documents 
WHERE MATCH(title, content) AGAINST('keyword' IN NATURAL LANGUAGE MODE);

-- ä¼˜åŒ–å‰ï¼šå­æŸ¥è¯¢
SELECT * FROM users u 
WHERE u.id IN (SELECT ur.user_id FROM user_roles ur WHERE ur.role_id = 1);

-- ä¼˜åŒ–åï¼šJOINæŸ¥è¯¢
SELECT u.* FROM users u 
INNER JOIN user_roles ur ON u.id = ur.user_id 
WHERE ur.role_id = 1;

-- ä¼˜åŒ–å‰ï¼šORæ¡ä»¶
SELECT * FROM documents WHERE status = 'PUBLISHED' OR status = 'ARCHIVED';

-- ä¼˜åŒ–åï¼šINæ¡ä»¶
SELECT * FROM documents WHERE status IN ('PUBLISHED', 'ARCHIVED');
```

#### åˆ†åŒºè¡¨è®¾è®¡
```sql
-- æŒ‰æœˆåˆ†åŒºçš„æ“ä½œæ—¥å¿—è¡¨
CREATE TABLE operation_logs_partitioned (
    id BIGINT AUTO_INCREMENT,
    user_id BIGINT,
    operation VARCHAR(100) NOT NULL,
    module VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id, created_at),
    INDEX idx_user_id (user_id),
    INDEX idx_operation (operation),
    INDEX idx_module (module)
) PARTITION BY RANGE (YEAR(created_at) * 100 + MONTH(created_at)) (
    PARTITION p202512 VALUES LESS THAN (202601),
    PARTITION p202501 VALUES LESS THAN (202602),
    PARTITION p202502 VALUES LESS THAN (202603),
    PARTITION p202503 VALUES LESS THAN (202604),
    PARTITION p202504 VALUES LESS THAN (202605),
    PARTITION p202505 VALUES LESS THAN (202606),
    PARTITION p202506 VALUES LESS THAN (202607),
    PARTITION p202507 VALUES LESS THAN (202608),
    PARTITION p202508 VALUES LESS THAN (202609),
    PARTITION p202509 VALUES LESS THAN (202610),
    PARTITION p202510 VALUES LESS THAN (202611),
    PARTITION p202511 VALUES LESS THAN (202612),
    PARTITION p202512 VALUES LESS THAN (202701),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

### 2. MongoDBæ€§èƒ½ä¼˜åŒ–

#### ç´¢å¼•ä¼˜åŒ–
```javascript
// å¤åˆç´¢å¼•
db.document_contents.createIndex({ "documentId": 1, "updatedAt": -1 })

// æ–‡æœ¬ç´¢å¼•
db.document_contents.createIndex({ 
  "title": "text", 
  "content": "text",
  "metadata.tags": "text"
}, {
  weights: {
    "title": 10,
    "content": 5,
    "metadata.tags": 8
  }
})

// TTLç´¢å¼•ï¼ˆè‡ªåŠ¨è¿‡æœŸï¼‰
db.notifications.createIndex({ "expiresAt": 1 }, { expireAfterSeconds: 0 })

// ç¨€ç–ç´¢å¼•
db.user_activities.createIndex({ "details.location.coordinates": "2dsphere" }, { sparse: true })
```

#### èšåˆç®¡é“ä¼˜åŒ–
```javascript
// ä¼˜åŒ–å‰ï¼šå¤šæ¬¡æŸ¥è¯¢
db.user_activities.find({ "userId": 123 }).sort({ "timestamp": -1 }).limit(10)
db.user_activities.countDocuments({ "userId": 123 })

// ä¼˜åŒ–åï¼šèšåˆç®¡é“
db.user_activities.aggregate([
  { $match: { "userId": 123 } },
  { $facet: {
    "activities": [
      { $sort: { "timestamp": -1 } },
      { $limit: 10 }
    ],
    "totalCount": [
      { $count: "count" }
    ]
  }}
])
```

### 3. Redisæ€§èƒ½ä¼˜åŒ–

#### å†…å­˜ä¼˜åŒ–
```yaml
# Redisé…ç½®ä¼˜åŒ–
maxmemory 2gb
maxmemory-policy allkeys-lru
save 900 1
save 300 10
save 60 10000
```

#### è¿æ¥æ± ä¼˜åŒ–
```java
@Configuration
public class RedisConfig {
    
    @Bean
    public LettuceConnectionFactory redisConnectionFactory() {
        GenericObjectPoolConfig<StatefulRedisConnection<String, String>> poolConfig = 
            new GenericObjectPoolConfig<>();
        poolConfig.setMaxTotal(20);
        poolConfig.setMaxIdle(10);
        poolConfig.setMinIdle(5);
        poolConfig.setMaxWaitMillis(3000);
        
        LettuceClientConfiguration clientConfig = LettuceClientConfiguration.builder()
            .commandTimeout(Duration.ofSeconds(3))
            .shutdownTimeout(Duration.ZERO)
            .build();
        
        return new LettuceConnectionFactory(
            new RedisStandaloneConfiguration("localhost", 6379), 
            clientConfig);
    }
}
```

## ğŸ”’ æ•°æ®å®‰å…¨è®¾è®¡

### 1. æ•°æ®åŠ å¯†

#### æ•æ„Ÿæ•°æ®åŠ å¯†
```java
@Component
public class DataEncryptionService {
    
    @Value("${encryption.key}")
    private String encryptionKey;
    
    private final AESUtil aesUtil;
    
    public DataEncryptionService() {
        this.aesUtil = new AESUtil();
    }
    
    // åŠ å¯†ç”¨æˆ·æ•æ„Ÿä¿¡æ¯
    public void encryptUserSensitiveData(User user) {
        if (StringUtils.hasText(user.getPhone())) {
            user.setPhone(aesUtil.encrypt(user.getPhone(), encryptionKey));
        }
        if (StringUtils.hasText(user.getIdCard())) {
            user.setIdCard(aesUtil.encrypt(user.getIdCard(), encryptionKey));
        }
    }
    
    // è§£å¯†ç”¨æˆ·æ•æ„Ÿä¿¡æ¯
    public void decryptUserSensitiveData(UserDTO userDTO) {
        if (StringUtils.hasText(userDTO.getPhone())) {
            userDTO.setPhone(aesUtil.decrypt(userDTO.getPhone(), encryptionKey));
        }
        if (StringUtils.hasText(userDTO.getIdCard())) {
            userDTO.setIdCard(aesUtil.decrypt(userDTO.getIdCard(), encryptionKey));
        }
    }
}
```

#### æ•°æ®åº“è¿æ¥åŠ å¯†
```yaml
spring:
  datasource:
    url: jdbc:mysql://mysql-master:3306/spring4demo?useSSL=true&requireSSL=true&verifyServerCertificate=false
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      data-source-properties:
        useSSL: true
        requireSSL: true
        verifyServerCertificate: false
        clientCertificateKeyStoreUrl: file:/path/to/client-keystore.jks
        clientCertificateKeyStorePassword: ${KEYSTORE_PASSWORD}
        trustCertificateKeyStoreUrl: file:/path/to/truststore.jks
        trustCertificateKeyStorePassword: ${TRUSTSTORE_PASSWORD}
```

### 2. æ•°æ®å¤‡ä»½ç­–ç•¥

#### MySQLå¤‡ä»½ç­–ç•¥
```bash
#!/bin/bash
# å…¨é‡å¤‡ä»½è„šæœ¬
BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="spring4demo"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å…¨é‡å¤‡ä»½
mysqldump -h mysql-master -u backup_user -p$BACKUP_PASSWORD \
  --single-transaction \
  --routines \
  --triggers \
  --events \
  --master-data=2 \
  --flush-logs \
  --databases $DB_NAME | gzip > $BACKUP_DIR/full_backup_$DATE.sql.gz

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "full_backup_*.sql.gz" -mtime +7 -delete

# ä¸Šä¼ åˆ°äº‘å­˜å‚¨
aws s3 cp $BACKUP_DIR/full_backup_$DATE.sql.gz s3://spring4demo-backups/mysql/
```

#### MongoDBå¤‡ä»½ç­–ç•¥
```bash
#!/bin/bash
# MongoDBå¤‡ä»½è„šæœ¬
BACKUP_DIR="/backup/mongodb"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="spring4demo"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# ä½¿ç”¨mongodumpå¤‡ä»½
mongodump --host mongodb-primary:27017 \
  --username backup_user \
  --password $MONGO_BACKUP_PASSWORD \
  --db $DB_NAME \
  --out $BACKUP_DIR/mongodb_backup_$DATE

# å‹ç¼©å¤‡ä»½
tar -czf $BACKUP_DIR/mongodb_backup_$DATE.tar.gz -C $BACKUP_DIR mongodb_backup_$DATE
rm -rf $BACKUP_DIR/mongodb_backup_$DATE

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "mongodb_backup_*.tar.gz" -mtime +7 -delete

# ä¸Šä¼ åˆ°äº‘å­˜å‚¨
aws s3 cp $BACKUP_DIR/mongodb_backup_$DATE.tar.gz s3://spring4demo-backups/mongodb/
```

### 3. æ•°æ®åº“å®¡è®¡

#### å®¡è®¡æ—¥å¿—é…ç½®
```sql
-- MySQLå®¡è®¡æ’ä»¶é…ç½®
INSTALL PLUGIN audit_log SONAME 'audit_log.so';

-- é…ç½®å®¡è®¡å‚æ•°
SET GLOBAL audit_log_format = 'JSON';
SET GLOBAL audit_log_policy = 'ALL';
SET GLOBAL audit_log_strategy = 'ASYNCHRONOUS';
SET GLOBAL audit_log_file = '/var/log/mysql/audit.log';
SET GLOBAL audit_log_rotate_on_size = 1073741824; -- 1GB
SET GLOBAL audit_log_rotations = 10;
```

#### å®¡è®¡æ•°æ®æŸ¥è¯¢
```sql
-- æŸ¥è¯¢ç”¨æˆ·ç™»å½•å®¡è®¡è®°å½•
SELECT * FROM mysql.audit_log 
WHERE ACTION = 'CONNECT' 
  AND MYSQL_USER = 'admin'
  AND TIMESTAMP > DATE_SUB(NOW(), INTERVAL 1 DAY);

-- æŸ¥è¯¢æ•æ„Ÿæ“ä½œå®¡è®¡è®°å½•
SELECT * FROM mysql.audit_log 
WHERE ACTION IN ('INSERT', 'UPDATE', 'DELETE')
  AND OBJECT_SCHEMA = 'spring4demo'
  AND OBJECT_NAME IN ('users', 'user_roles')
  AND TIMESTAMP > DATE_SUB(NOW(), INTERVAL 1 HOUR);
```

## ğŸ“Š æ•°æ®åº“ç›‘æ§

### 1. æ€§èƒ½ç›‘æ§

#### MySQLç›‘æ§æŒ‡æ ‡
```java
@Component
public class DatabaseMetrics {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    private final MeterRegistry meterRegistry;
    
    public DatabaseMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
    }
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ”¶é›†ä¸€æ¬¡
    public void collectMySQLMetrics() {
        // è¿æ¥æ•°ç›‘æ§
        Integer connectionCount = jdbcTemplate.queryForObject(
            "SHOW STATUS LIKE 'Threads_connected'", 
            (rs, rowNum) -> rs.getInt("Value")
        );
        meterRegistry.gauge("mysql.connections.active", connectionCount);
        
        // æŸ¥è¯¢æ•°ç›‘æ§
        Integer queryCount = jdbcTemplate.queryForObject(
            "SHOW STATUS LIKE 'Queries'", 
            (rs, rowNum) -> rs.getInt("Value")
        );
        meterRegistry.gauge("mysql.queries.total", queryCount);
        
        // æ…¢æŸ¥è¯¢æ•°ç›‘æ§
        Integer slowQueryCount = jdbcTemplate.queryForObject(
            "SHOW STATUS LIKE 'Slow_queries'", 
            (rs, rowNum) -> rs.getInt("Value")
        );
        meterRegistry.gauge("mysql.slow_queries.total", slowQueryCount);
        
        // ç¼“å†²æ± å‘½ä¸­ç‡
        Double innodbBufferPoolReads = jdbcTemplate.queryForObject(
            "SHOW STATUS LIKE 'Innodb_buffer_pool_reads'", 
            (rs, rowNum) -> rs.getDouble("Value")
        );
        Double innodbBufferPoolReadRequests = jdbcTemplate.queryForObject(
            "SHOW STATUS LIKE 'Innodb_buffer_pool_read_requests'", 
            (rs, rowNum) -> rs.getDouble("Value")
        );
        
        if (innodbBufferPoolReadRequests > 0) {
            double hitRate = 1 - (innodbBufferPoolReads / innodbBufferPoolReadRequests);
            meterRegistry.gauge("mysql.buffer_pool.hit_rate", hitRate);
        }
    }
}
```

### 2. å¥åº·æ£€æŸ¥

#### æ•°æ®åº“å¥åº·æ£€æŸ¥
```java
@Component
public class DatabaseHealthIndicator implements HealthIndicator {
    
    @Autowired
    private DataSource dataSource;
    
    @Override
    public Health health() {
        try (Connection connection = dataSource.getConnection()) {
            if (connection.isValid(5)) {
                // æ£€æŸ¥æ•°æ®åº“è¿æ¥æ± çŠ¶æ€
                HikariDataSource hikariDataSource = (HikariDataSource) dataSource;
                HikariPoolMXBean poolProxy = hikariDataSource.getHikariPoolMXBean();
                
                return Health.up()
                    .withDetail("activeConnections", poolProxy.getActiveConnections())
                    .withDetail("idleConnections", poolProxy.getIdleConnections())
                    .withDetail("totalConnections", poolProxy.getTotalConnections())
                    .withDetail("threadsAwaitingConnection", poolProxy.getThreadsAwaitingConnection())
                    .build();
            } else {
                return Health.down().withDetail("reason", "Database connection validation failed").build();
            }
        } catch (Exception e) {
            return Health.down().withDetail("reason", e.getMessage()).build();
        }
    }
}
```

---

*æœ¬æ–‡æ¡£å°†éšç€æ•°æ®åº“æ¶æ„æ¼”è¿›æŒç»­æ›´æ–°ï¼Œç¡®ä¿æ•°æ®åº“è®¾è®¡æ»¡è¶³ä¸šåŠ¡å‘å±•çš„éœ€æ±‚ã€‚*