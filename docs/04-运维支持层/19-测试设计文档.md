# 测试设计文档

## 1. 概述

本文档详细说明 spring4demo 项目的测试框架、测试策略和最佳实践。

## 2. 测试框架

### 2.1 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| JUnit 5 | 5.x | 测试框架核心 |
| Mockito | 5.x | Mock 框架 |
| AssertJ | 3.x | 流式断言库 |
| Spring Boot Test | 3.2.10 | Spring Boot 测试支持 |
| Testcontainers | 1.19.6 | 容器化集成测试 |
| WireMock | 3.0.1 | HTTP 服务模拟 |
| H2 Database | 2.4.240 | 内存数据库测试 |
| JaCoCo | 0.8.11 | 代码覆盖率工具 |

### 2.2 Maven 插件

| 插件 | 版本 | 用途 |
|------|------|------|
| maven-surefire-plugin | 3.2.2 | 单元测试执行 |
| maven-failsafe-plugin | 3.2.5 | 集成测试执行 |
| jacoco-maven-plugin | 0.8.11 | 代码覆盖率报告 |

## 3. 测试类型

### 3.1 单元测试

**定义**：测试单个类或方法的逻辑，不依赖外部系统。

**特点**：
- 执行速度快
- 隔离性好
- 使用 Mock 模拟依赖

**命名规范**：`{ClassName}Test.java`

**示例**：`UserServiceImplTest.java`

```java
@ExtendWith(MockitoExtension.class)
@DisplayName("用户服务单元测试")
class UserServiceImplTest {

    @Mock
    private UserMapper userMapper;

    @InjectMocks
    private UserServiceImpl userService;

    @Test
    @DisplayName("根据用户名查询用户 - 成功")
    void findByUsername_Success() {
        // Given - 准备测试数据
        when(userMapper.findByUsername("testuser")).thenReturn(Optional.of(testUser));

        // When - 执行测试方法
        Optional<User> result = userService.findByUsername("testuser");

        // Then - 验证结果
        assertThat(result).isPresent();
        verify(userMapper, times(1)).findByUsername("testuser");
    }
}
```

### 3.2 集成测试

**定义**：测试多个组件或模块之间的交互。

**特点**：
- 测试组件协作
- 使用真实或模拟的外部依赖
- 执行速度较慢

**命名规范**：`{ClassName}IT.java`

**示例**：`UserControllerIT.java`

```java
@SpringBootTest
@AutoConfigureMockMvc
@ActiveProfiles("test")
@DisplayName("用户控制器集成测试")
class UserControllerIT {

    @Autowired
    private MockMvc mockMvc;

    @MockBean
    private UserService userService;

    @Test
    @DisplayName("创建用户 - 成功")
    void createUser_Success() throws Exception {
        mockMvc.perform(post("/api/users")
                .contentType(MediaType.APPLICATION_JSON)
                .content(requestBody))
            .andExpect(status().isCreated())
            .andExpect(jsonPath("$.code").value(200));
    }
}
```

### 3.3 端到端测试 (E2E)

**定义**：测试完整的业务流程，模拟真实用户操作。

**特点**：
- 测试完整流程
- 使用真实环境
- 执行速度最慢

**存放位置**：`spring4demo-integration` 模块

## 4. 测试配置

### 4.1 测试配置文件

**core 模块**：`spring4demo-core/src/test/resources/application-test.yml`

```yaml
spring:
  datasource:
    driver-class-name: org.h2.Driver
    url: jdbc:h2:mem:testdb;MODE=MySQL;DB_CLOSE_DELAY=-1
    username: sa
    password:

mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
```

**web 模块**：`spring4demo-web/src/test/resources/application-test.yml`

```yaml
spring:
  web:
    resources:
      add-mappings: false

springdoc:
  api-docs:
    enabled: false
```

### 4.2 数据库初始化脚本

**位置**：`spring4demo-core/src/test/resources/db/schema.sql`

```sql
-- 创建用户表
CREATE TABLE user (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100),
    status INT DEFAULT 1,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 插入测试数据
INSERT INTO user (username, email, status) VALUES
('admin', 'admin@example.com', 1),
('testuser', 'test@example.com', 1);
```

### 4.3 测试基类

**Core 模块基类**：`BaseTest.java`

```java
@SpringBootTest
@ActiveProfiles("test")
@Transactional
public abstract class BaseTest {
    @BeforeEach
    void setUp() {
        setupTest();
    }

    protected void setupTest() {
        // 子类覆盖
    }
}
```

**Web 模块基类**：`BaseWebTest.java`

```java
@SpringBootTest
@AutoConfigureMockMvc
@ActiveProfiles("test")
@Transactional
public abstract class BaseWebTest {
    @Autowired
    protected MockMvc mockMvc;

    protected void mockLogin(Long userId) {
        StpUtil.login(userId);
    }
}
```

## 5. 测试最佳实践

### 5.1 AAA 模式

使用 Given-When-Then 结构组织测试代码：

```java
@Test
void testMethod() {
    // Given - 准备测试数据
    when(userMapper.findByUsername("test")).thenReturn(Optional.of(user));

    // When - 执行测试方法
    Optional<User> result = userService.findByUsername("test");

    // Then - 验证结果
    assertThat(result).isPresent();
}
```

### 5.2 测试命名规范

- 使用 `@DisplayName` 注解提供清晰的测试名称
- 测试方法名应描述测试场景和预期结果
- 使用下划线分隔单词

```java
@Test
@DisplayName("根据用户名查询用户 - 成功")
void findByUsername_Success() { }

@Test
@DisplayName("根据用户名查询用户 - 用户不存在")
void findByUsername_NotFound() { }
```

### 5.3 断言使用

优先使用 AssertJ 的流式断言：

```java
// 推荐
assertThat(result).isNotNull();
assertThat(result.getUsername()).isEqualTo("testuser");
assertThat(result.getStatus()).isGreaterThan(0);

// 避免
assertEquals("testuser", result.getUsername());
assertTrue(result.getStatus() > 0);
```

### 5.4 Mock 使用

- 只 Mock 外部依赖
- 不要 Mock 被测试的类
- 验证 Mock 对象的调用

```java
@Mock
private UserMapper userMapper;

@InjectMocks
private UserServiceImpl userService;

@Test
void testMethod() {
    when(userMapper.findByUsername("test")).thenReturn(Optional.of(user));

    userService.findByUsername("test");

    verify(userMapper, times(1)).findByUsername("test");
}
```

### 5.5 测试隔离

- 每个测试方法应独立
- 使用 `@Transactional` 确保测试后回滚
- 在 `@BeforeEach` 中初始化测试数据

```java
@SpringBootTest
@Transactional
class UserServiceTest {
    @BeforeEach
    void setUp() {
        // 初始化测试数据
    }
}
```

### 5.6 参数化测试

使用 `@ParameterizedTest` 减少重复代码：

```java
@ParameterizedTest
@ValueSource(strings = {"admin", "user", "guest"})
void testWithDifferentUsernames(String username) {
    when(userMapper.findByUsername(username)).thenReturn(Optional.of(user));

    Optional<User> result = userService.findByUsername(username);

    assertThat(result).isPresent();
}
```

## 6. 测试覆盖率

### 6.1 覆盖率目标

| 指标 | 目标值 |
|------|--------|
| 代码行覆盖率 | 85% |
| 分支覆盖率 | 75% |

### 6.2 生成覆盖率报告

```bash
# 运行测试并生成覆盖率报告
mvn clean test jacoco:report

# 查看报告
open target/site/jacoco/index.html
```

### 6.3 JaCoCo 配置

已在 `pom.xml` 中配置：

```xml
<plugin>
    <groupId>org.jacoco</groupId>
    <artifactId>jacoco-maven-plugin</artifactId>
    <version>0.8.11</version>
    <configuration>
        <rules>
            <rule>
                <element>BUNDLE</element>
                <limits>
                    <limit>
                        <counter>INSTRUCTION</counter>
                        <value>COVEREDRATIO</value>
                        <minimum>0.85</minimum>
                    </limit>
                    <limit>
                        <counter>BRANCH</counter>
                        <value>COVEREDRATIO</value>
                        <minimum>0.75</minimum>
                    </limit>
                </limits>
            </rule>
        </rules>
    </configuration>
</plugin>
```

## 7. 常用测试命令

### 7.1 运行测试

```bash
# 运行所有单元测试
mvn test

# 运行所有集成测试
mvn verify

# 运行指定类的测试
mvn test -Dtest=UserServiceImplTest

# 运行指定方法的测试
mvn test -Dtest=UserServiceImplTest#findByUsername_Success

# 跳过测试
mvn clean package -DskipTests
```

### 7.2 并行测试

已在 `pom.xml` 中配置并行执行：

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-surefire-plugin</artifactId>
    <configuration>
        <parallel>methods</parallel>
        <threadCount>4</threadCount>
    </configuration>
</plugin>
```

## 8. 测试工具推荐

### 8.1 IDE 插件

| 插件 | 用途 |
|------|------|
| JUnit 5 | 测试框架支持 |
| JaCoCo | 代码覆盖率可视化 |
| AssertJ | 断言支持 |
| Mockito | Mock 支持 |

### 8.2 测试辅助工具

- **Testcontainers**：容器化集成测试
- **WireMock**：HTTP 服务模拟
- **H2 Database**：内存数据库
- **Embedded Redis**：嵌入式 Redis 测试

## 9. 常见问题

### 9.1 测试失败常见原因

1. **Mock 配置错误**：检查 Mock 对象的返回值设置
2. **数据库连接失败**：确认测试配置文件正确
3. **事务回滚失败**：检查 `@Transactional` 注解
4. **依赖注入失败**：确认 `@MockBean` 或 `@Autowired` 正确使用

### 9.2 性能优化

1. 使用 `@DirtiesContext` 控制应用上下文生命周期
2. 合理使用并行测试
3. 避免在 `@BeforeAll` 中执行耗时操作

## 10. 项目测试示例

项目已提供以下测试示例：

### 10.1 Service 层单元测试

`spring4demo-core/src/test/java/.../service/impl/UserServiceImplTest.java`

### 10.2 Controller 层集成测试

`spring4demo-web/src/test/java/.../controller/UserControllerIT.java`

### 10.3 文件存储服务测试

`spring4demo-core/src/test/java/.../service/impl/FileStorageServiceImplTest.java`

## 11. 参考资料

- [JUnit 5 官方文档](https://junit.org/junit5/docs/current/user-guide/)
- [Mockito 官方文档](https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html)
- [AssertJ 官方文档](https://assertj.github.io/doc/)
- [Spring Boot 测试文档](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.testing)
- [Testcontainers 文档](https://www.testcontainers.org/)
- [JaCoCo 文档](https://www.jacoco.org/jacoco/trunk/doc/)