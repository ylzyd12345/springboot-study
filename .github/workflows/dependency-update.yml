name: Dependency Update

on:
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨3ç‚¹æ£€æŸ¥ä¾èµ–æ›´æ–°
    - cron: '0 3 * * 1'
  workflow_dispatch:

jobs:
  # æ£€æŸ¥Mavenä¾èµ–æ›´æ–°
  check-dependencies:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Check for Maven dependency updates
      run: |
        mvn versions:display-dependency-updates -DoutputFile=dependency-updates.txt
        mvn versions:display-plugin-updates -DoutputFile=plugin-updates.txt
        mvn versions:display-property-updates -DoutputFile=property-updates.txt

    - name: Upload dependency reports
      uses: actions/upload-artifact@v3
      with:
        name: dependency-reports
        path: |
          dependency-updates.txt
          plugin-updates.txt
          property-updates.txt

    - name: Create Pull Request for updates
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'ðŸ”§ Update dependencies'
        title: 'ðŸ”§ Automated Dependency Update'
        body: |
          ## ä¾èµ–æ›´æ–°æŠ¥å‘Š
          
          æ­¤PRç”±è‡ªåŠ¨åŒ–å·¥ä½œæµåˆ›å»ºï¼ŒåŒ…å«ä»¥ä¸‹æ›´æ–°ï¼š
          
          ### Mavenä¾èµ–æ›´æ–°
          ```
          $(cat dependency-updates.txt)
          ```
          
          ### Mavenæ’ä»¶æ›´æ–°
          ```
          $(cat plugin-updates.txt)
          ```
          
          ### å±žæ€§æ›´æ–°
          ```
          $(cat property-updates.txt)
          ```
          
          è¯·ä»”ç»†æ£€æŸ¥æ›´æ–°å†…å®¹ï¼Œæµ‹è¯•é€šè¿‡åŽåˆå¹¶ã€‚
        branch: dependency-updates
        delete-branch: true

  # æ£€æŸ¥å®‰å…¨æ¼æ´ž
  security-vulnerabilities:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Run OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'spring4demo'
        path: '.'
        format: 'HTML'
        
    - name: Check for vulnerabilities
      run: |
        if [ -f "reports/dependency-check-report.html" ]; then
          echo "Vulnerability report generated"
        fi

    - name: Upload vulnerability reports
      uses: actions/upload-artifact@v3
      with:
        name: vulnerability-reports
        path: reports/

  # æ›´æ–°DockeråŸºç¡€é•œåƒ
  update-docker-base:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for Docker base image updates
      run: |
        echo "Checking for Docker base image updates..."
        # æ£€æŸ¥Dockerfileä¸­çš„åŸºç¡€é•œåƒç‰ˆæœ¬
        grep FROM ./spring4demo/Dockerfile

    - name: Create Pull Request for Docker updates
      if: contains(steps.check.outputs.base-images, 'update-available')
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'ðŸ³ Update Docker base images'
        title: 'ðŸ³ Automated Docker Base Image Update'
        body: |
          ## DockeråŸºç¡€é•œåƒæ›´æ–°
          
          æ­¤PRæ›´æ–°äº†DockeråŸºç¡€é•œåƒåˆ°æœ€æ–°ç‰ˆæœ¬ï¼ŒåŒ…å«å®‰å…¨ä¿®å¤å’Œæ€§èƒ½æ”¹è¿›ã€‚
          
          è¯·åœ¨æµ‹è¯•é€šè¿‡åŽåˆå¹¶æ­¤PRã€‚
        branch: docker-updates
        delete-branch: true

  # é€šçŸ¥ç»“æžœ
  notify-results:
    runs-on: ubuntu-latest
    needs: [check-dependencies, security-vulnerabilities, update-docker-base]
    if: always()
    steps:
    - name: Download reports
      uses: actions/download-artifact@v3
      with:
        path: reports/

    - name: Create summary report
      run: |
        echo "# ä¾èµ–æ›´æ–°æŠ¥å‘Š" > update-summary.md
        echo "ç”Ÿæˆæ—¶é—´: $(date)" >> update-summary.md
        echo "" >> update-summary.md
        echo "## æ£€æŸ¥ç»“æžœ" >> update-summary.md
        echo "- Mavenä¾èµ–æ£€æŸ¥: ${{ needs.check-dependencies.result }}" >> update-summary.md
        echo "- å®‰å…¨æ¼æ´žæ£€æŸ¥: ${{ needs.security-vulnerabilities.result }}" >> update-summary.md
        echo "- DockeråŸºç¡€é•œåƒæ£€æŸ¥: ${{ needs.update-docker-base.result }}" >> update-summary.md

    - name: Upload summary report
      uses: actions/upload-artifact@v3
      with:
        name: update-summary
        path: update-summary.md