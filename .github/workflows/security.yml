name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # 每天凌晨2点运行安全扫描
    - cron: '0 2 * * *'

jobs:
  # 依赖安全扫描
  dependency-scan:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'

    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Run OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'spring4demo'
        path: '.'
        format: 'HTML'
        format: 'JSON'

    - name: Upload OWASP results
      uses: actions/upload-artifact@v3
      with:
        name: owasp-reports
        path: reports/

    - name: Run Snyk to check for vulnerabilities
      uses: snyk/actions/maven@master
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high

    - name: Upload Snyk results
      uses: actions/upload-artifact@v3
      with:
        name: snyk-results
        path: snyk-results/

  # 容器安全扫描
  container-scan:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./spring4demo
        push: false
        tags: spring4demo:scan
        load: true

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'spring4demo:scan'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Run Grype vulnerability scanner
      uses: anchore/scan-action@v4
      with:
        image: 'spring4demo:scan'
        format: 'sarif'
        output: 'grype-results.sarif'

    - name: Upload Grype scan results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'grype-results.sarif'

  # 代码安全分析
  code-security:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        languages: java

    - name: Run Semgrep
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/owasp-top-ten
          p/java
        generate-sarif: true

    - name: Upload Semgrep results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: semgrep.sarif

  # 硬编码密码检测
  hardcoded-secrets:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'

    - name: Check for hardcoded passwords
      run: |
        echo "Checking for hardcoded passwords..."
        # 检查常见的硬编码密码模式
        if grep -r -i "password.*=.*['\"]admin['\"]" spring4demo/src/; then
          echo "ERROR: Found hardcoded admin password!"
          exit 1
        fi
        if grep -r -i "password.*=.*['\"]123456['\"]" spring4demo/src/; then
          echo "ERROR: Found hardcoded default password!"
          exit 1
        fi
        if grep -r -i "secret.*=.*['\"]admin123['\"]" spring4demo/src/; then
          echo "ERROR: Found hardcoded secret!"
          exit 1
        fi
        echo "No hardcoded passwords found."

    - name: Check for hardcoded API keys
      run: |
        echo "Checking for hardcoded API keys..."
        # 检查常见的 API 密钥模式
        if grep -r -i "api.*key.*=.*['\"][a-zA-Z0-9]{20,}['\"]" spring4demo/src/; then
          echo "WARNING: Found potential hardcoded API key!"
          exit 1
        fi
        echo "No hardcoded API keys found."

  # 密钥泄露检测
  secrets-scan:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Run TruffleHog
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD

    - name: Run Detect Secrets
      run: |
        pip install detect-secrets
        detect-secrets scan --all-files --baseline .secrets.baseline

  # 安全报告汇总
  security-report:
    runs-on: ubuntu-latest
    needs: [dependency-scan, container-scan, code-security, hardcoded-secrets, secrets-scan]
    if: always()
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3

    - name: Generate security report
      run: |
        echo "# Security Scan Report" > security-report.md
        echo "Generated on: $(date)" >> security-report.md
        echo "" >> security-report.md
        echo "## Dependency Scan Results" >> security-report.md
        echo "## Container Scan Results" >> security-report.md
        echo "## Code Security Analysis" >> security-report.md
        echo "## Hardcoded Secrets Check" >> security-report.md
        echo "## Secrets Scan Results" >> security-report.md

    - name: Upload security report
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: security-report.md

    - name: Comment PR with security results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('security-report.md', 'utf8');
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });