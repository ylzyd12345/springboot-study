name: Quality Gate

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

env:
  MIN_COVERAGE: 80
  MAX_COMPLEXITY: 5
  MAX_METHOD_LENGTH: 80
  MAX_CLASS_LENGTH: 300

jobs:
  # è´¨é‡é—¨ç¦æ£€æŸ¥
  quality-gate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'

    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Run all quality checks
      run: |
        echo "=========================================="
        echo "Quality Gate Check Started"
        echo "=========================================="
        echo ""

        # 1. ä»£ç æ ¼å¼æ£€æŸ¥
        echo "1. Code Format Check..."
        mvn com.coveo:fmt-maven-plugin:check || {
          echo "âŒ FAILED: Code format check failed"
          echo "Please run 'mvn fmt:format' locally"
          exit 1
        }
        echo "âœ… PASSED: Code format check"

        # 2. Checkstyle æ£€æŸ¥
        echo ""
        echo "2. Checkstyle Check..."
        mvn checkstyle:check -Dcheckstyle.skip=false || {
          echo "âŒ FAILED: Checkstyle check failed"
          exit 1
        }
        echo "âœ… PASSED: Checkstyle check"

        # 3. SpotBugs æ£€æŸ¥
        echo ""
        echo "3. SpotBugs Check..."
        mvn spotbugs:check -Dspotbugs.skip=false || {
          echo "âŒ FAILED: SpotBugs check failed"
          exit 1
        }
        echo "âœ… PASSED: SpotBugs check"

        # 4. PMD æ£€æŸ¥
        echo ""
        echo "4. PMD Check..."
        mvn pmd:check -Dpmd.skip=false || {
          echo "âŒ FAILED: PMD check failed"
          exit 1
        }
        echo "âœ… PASSED: PMD check"

        # 5. OWASP Dependency Check
        echo ""
        echo "5. OWASP Dependency Check..."
        mvn dependency-check:check -Ddependency-check.skip=false || {
          echo "âŒ FAILED: OWASP Dependency Check failed"
          echo "Please review the security vulnerabilities"
          exit 1
        }
        echo "âœ… PASSED: OWASP Dependency Check"

        # 6. è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–çŽ‡æŠ¥å‘Š
        echo ""
        echo "6. Running Tests with Coverage..."
        mvn clean test jacoco:report -Djacoco.skip=false || {
          echo "âŒ FAILED: Tests failed"
          exit 1
        }
        echo "âœ… PASSED: All tests passed"

        # 7. æ£€æŸ¥æµ‹è¯•è¦†ç›–çŽ‡
        echo ""
        echo "7. Coverage Check (Target: ${{ env.MIN_COVERAGE }}%)..."
        mvn jacoco:check -Djacoco.coverage.ratio=${{ env.MIN_COVERAGE }} -Djacoco.branch.ratio=0.75 || {
          echo "âŒ FAILED: Coverage is below ${{ env.MIN_COVERAGE }}%"
          echo "Please add more tests to increase coverage"
          exit 1
        }
        echo "âœ… PASSED: Coverage meets the requirement"

        echo ""
        echo "=========================================="
        echo "Quality Gate Check: ALL PASSED âœ…"
        echo "=========================================="

    - name: Generate coverage badge
      if: success()
      uses: cicirello/jacoco-badge-generator@v2
      with:
        jacoco-csv-file: spring4demo/target/site/jacoco/jacoco.csv
        badges-directory: badges
        generate-branches-badge: true
        generate-summary: true
        coverage-label: Coverage
        branches-label: Branches
        summary-label: Coverage Summary

    - name: Upload coverage badge
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: coverage-badges
        path: badges/

    - name: Commit coverage badge
      if: success() && github.ref == 'refs/heads/main'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add badges/
        git commit -m "Update coverage badges" || exit 0
        git push

    - name: Quality Gate Report
      if: always()
      run: |
        echo "## Quality Gate Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Code Format**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "- **Checkstyle**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "- **SpotBugs**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "- **PMD**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "- **OWASP Dependency Check**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "- **Tests**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "- **Coverage**: âœ… Passed (â‰¥${{ env.MIN_COVERAGE }}%)" >> $GITHUB_STEP_SUMMARY

  # ä»£ç å¤æ‚åº¦æ£€æŸ¥
  complexity-gate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'

    - name: Install Lizard
      run: |
        sudo apt-get update
        sudo apt-get install -y lizard

    - name: Check Cyclomatic Complexity
      run: |
        echo "=========================================="
        echo "Complexity Check (Max CCN: ${{ env.MAX_COMPLEXITY }})"
        echo "=========================================="
        echo ""

        lizard spring4demo/src/main/java/ \
          --CCN ${{ env.MAX_COMPLEXITY }} \
          --length ${{ env.MAX_METHOD_LENGTH }} \
          --exclude "*/target/*" \
          --warnings_only || {
            echo ""
            echo "âŒ FAILED: Found methods with cyclomatic complexity > ${{ env.MAX_COMPLEXITY }}"
            echo "Please refactor these methods to reduce complexity"
            exit 1
        }

        echo ""
        echo "âœ… PASSED: All methods have CCN â‰¤ ${{ env.MAX_COMPLEXITY }}"

    - name: Check Method Length
      run: |
        echo ""
        echo "=========================================="
        echo "Method Length Check (Max: ${{ env.MAX_METHOD_LENGTH }} lines)"
        echo "=========================================="
        echo ""

        lizard spring4demo/src/main/java/ \
          --length ${{ env.MAX_METHOD_LENGTH }} \
          --exclude "*/target/*" \
          --warnings_only || {
            echo ""
            echo "âŒ FAILED: Found methods longer than ${{ env.MAX_METHOD_LENGTH }} lines"
            echo "Please split these methods into smaller functions"
            exit 1
        }

        echo ""
        echo "âœ… PASSED: All methods are â‰¤ ${{ env.MAX_METHOD_LENGTH }} lines"

    - name: Complexity Report
      if: always()
      run: |
        echo "## Complexity Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        lizard spring4demo/src/main/java/ \
          --CCN ${{ env.MAX_COMPLEXITY }} \
          --length ${{ env.MAX_METHOD_LENGTH }} \
          --exclude "*/target/*" \
          --html lizard-report.html
        echo "Detailed complexity report generated" >> $GITHUB_STEP_SUMMARY

    - name: Upload complexity report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: complexity-report
        path: lizard-report.html

  # ä»£ç é‡å¤æ£€æŸ¥
  duplication-gate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'

    - name: Run CPD Check
      run: |
        echo "=========================================="
        echo "Duplication Check"
        echo "=========================================="
        echo ""

        mvn pmd:cpd-check -Dpmd.skip=false || {
          echo ""
          echo "âŒ FAILED: Found code duplication"
          echo "Please refactor duplicated code"
          exit 1
        }

        echo ""
        echo "âœ… PASSED: No significant code duplication found"

  # å®‰å…¨æ£€æŸ¥
  security-gate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for Hardcoded Passwords
      run: |
        echo "=========================================="
        echo "Hardcoded Passwords Check"
        echo "=========================================="
        echo ""

        if grep -r -i "password.*=.*['\"]admin['\"]" spring4demo/src/; then
          echo "âŒ FAILED: Found hardcoded admin password!"
          exit 1
        fi
        if grep -r -i "password.*=.*['\"]123456['\"]" spring4demo/src/; then
          echo "âŒ FAILED: Found hardcoded default password!"
          exit 1
        fi
        if grep -r -i "secret.*=.*['\"]admin123['\"]" spring4demo/src/; then
          echo "âŒ FAILED: Found hardcoded secret!"
          exit 1
        fi

        echo "âœ… PASSED: No hardcoded passwords found"

    - name: Check for Hardcoded API Keys
      run: |
        echo ""
        echo "=========================================="
        echo "Hardcoded API Keys Check"
        echo "=========================================="
        echo ""

        if grep -r -E "(api[_-]?key|apikey)[\s:=]+['\"][a-zA-Z0-9]{20,}['\"]" spring4demo/src/; then
          echo "âš ï¸  WARNING: Found potential hardcoded API key"
          echo "Please review and use environment variables"
          # ä¸å¤±è´¥ï¼Œåªæ˜¯è­¦å‘Š
        fi

        echo "âœ… PASSED: No obvious hardcoded API keys found"

  # ç»¼åˆè´¨é‡é—¨ç¦
  final-gate:
    runs-on: ubuntu-latest
    needs: [quality-gate, complexity-gate, duplication-gate, security-gate]
    if: always()
    steps:
    - name: Check all gates
      run: |
        echo "=========================================="
        echo "Final Quality Gate Summary"
        echo "=========================================="
        echo ""

        if [ "${{ needs.quality-gate.result }}" != "success" ]; then
          echo "âŒ Quality Gate: FAILED"
          exit 1
        fi

        if [ "${{ needs.complexity-gate.result }}" != "success" ]; then
          echo "âŒ Complexity Gate: FAILED"
          exit 1
        fi

        if [ "${{ needs.duplication-gate.result }}" != "success" ]; then
          echo "âŒ Duplication Gate: FAILED"
          exit 1
        fi

        if [ "${{ needs.security-gate.result }}" != "success" ]; then
          echo "âŒ Security Gate: FAILED"
          exit 1
        fi

        echo "âœ… ALL QUALITY GATES PASSED"
        echo ""
        echo "The code is ready for merge!"

    - name: Final Report
      if: always()
      run: |
        echo "## Final Quality Gate Result" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Quality Gates Status:" >> $GITHUB_STEP_SUMMARY
        echo "- **Quality Gate**: ${{ needs.quality-gate.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Complexity Gate**: ${{ needs.complexity-gate.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Duplication Gate**: ${{ needs.duplication-gate.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Security Gate**: ${{ needs.security-gate.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.quality-gate.result }}" == "success" ] && \
           [ "${{ needs.complexity-gate.result }}" == "success" ] && \
           [ "${{ needs.duplication-gate.result }}" == "success" ] && \
           [ "${{ needs.security-gate.result }}" == "success" ]; then
          echo "ðŸŽ‰ **All quality gates passed! Ready to merge.**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸  **Some quality gates failed. Please fix the issues before merging.**" >> $GITHUB_STEP_SUMMARY
        fi
