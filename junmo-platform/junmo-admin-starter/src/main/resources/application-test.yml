# 测试环境配置
spring:
  config:
    activate:
      on-profile: test

  # 数据源配置（测试环境 - Testcontainers + 动态数据源 + Druid）
  datasource:
    dynamic:
      primary: master
      strict: false
      datasource:
        master:
          url: ${DATASOURCE_MASTER_URL:jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE;MODE=MySQL}
          username: ${DATASOURCE_MASTER_USERNAME:sa}
          password: ${DATASOURCE_MASTER_PASSWORD:}
          driver-class-name: org.h2.Driver
          druid:
            initial-size: 2
            min-idle: 2
            max-active: 10
            max-wait: 60000
            time-between-eviction-runs-millis: 60000
            min-evictable-idle-time-millis: 300000
            validation-query: SELECT 1
            test-while-idle: true
            test-on-borrow: false
            test-on-return: false
            pool-prepared-statements: true
            max-pool-prepared-statement-per-connection-size: 20
            filters: stat,wall,slf4j
            connection-properties: druid.stat.mergeSql=false;druid.stat.slowSqlMillis=2000
        slave:
          url: ${DATASOURCE_SLAVE_URL:jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE;MODE=MySQL}
          username: ${DATASOURCE_SLAVE_USERNAME:sa}
          password: ${DATASOURCE_SLAVE_PASSWORD:}
          driver-class-name: org.h2.Driver
          druid:
            initial-size: 2
            min-idle: 2
            max-active: 10
            max-wait: 60000
            time-between-eviction-runs-millis: 60000
            min-evictable-idle-time-millis: 300000
            validation-query: SELECT 1
            test-while-idle: true
            test-on-borrow: false
            test-on-return: false
            pool-prepared-statements: true
            max-pool-prepared-statement-per-connection-size: 20
            filters: stat,wall,slf4j
            connection-properties: druid.stat.mergeSql=false;druid.stat.slowSqlMillis=2000

  # H2 控制台配置
  h2:
    console:
      enabled: true
      path: /h2-console
      settings:
        web-allow-others: true

  # Redis配置（测试环境 - Lettuce + Redisson，和 dev 一致）
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: ${REDIS_DATABASE:1}
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1ms
        timeout: 2000ms
    # Redisson 配置（测试环境，和 dev 一致）
    redisson:
      address: ${REDIS_ADDRESS:redis://localhost:6379}
      database: ${REDISSON_DATABASE:1}
      password: ${REDIS_PASSWORD:}
      timeout: 3000
      connection-pool:
        connection-pool-size: 64
        connection-minimum-idle-size: 10
        idle-connection-timeout: 10000
        subscription-connection-pool-size: 50
        subscription-connection-minimum-idle-size: 1
      threads:
        thread-pool-size: 16
        netty-threads: 32
      single-server-config:
        connection-idle-timeout: 10000
        subscription-connection-timeout: 5000
        monitor-lock-expiration: 30000
        subscription-connection-pool-size: 50
        subscription-connection-minimum-idle-size: 1
        connection-pool-size: 64
        connection-minimum-idle-size: 10
        keep-alive: true

  # Thymeleaf 配置（测试环境）
  thymeleaf:
    cache: false

# 日志配置（测试环境）
logging:
  level:
    root: info
    com.junmo.platform: debug
    org.springframework.web: info
    org.springframework.security: warn
    org.springframework.boot.autoconfigure: info
    org.springframework.data: debug
    org.testcontainers: debug
    org.testcontainers.containers: debug
    com.baomidou.mybatisplus: debug
  pattern:
    console: "%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){faint} %clr([%thread]){blue} %clr(%-5level){cyan} %clr([%X{traceId:-},%X{userId:-}]){magenta} %clr(%logger{50}){yellow} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId:-},%X{userId:-}] %logger{50} - %msg%n"
  file:
    name: ./logs/junmo-platform-admin-test.log

# MyBatis-Plus配置（测试环境）
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true
    cache-enabled: true
    call-setters-on-nulls: true
    jdbc-type-for-null: 'null'
  global-config:
    db-config:
      id-type: assign_id
      logic-delete-field: deleted
      logic-delete-value: 1
      logic-not-delete-value: 0
      table-underline: true
  mapper-locations: classpath*:mapper/*.xml
  type-aliases-package: com.junmo.platform.core.entity

# 管理端点配置（测试环境）
management:
  endpoints:
    web:
      exposure:
        include: "health,info,metrics,prometheus"
  endpoint:
    health:
      show-details: when-authorized
    prometheus:
      enabled: true
  prometheus:
    metrics:
      export:
        enabled: true
  metrics:
    tags:
      application: ${spring.application.name}
      environment: test

# 服务器配置（测试环境）
server:
  port: 8081
  servlet:
    context-path: /test
  tomcat:
    uri-encoding: UTF-8
    max-threads: 200
    min-spare-threads: 30
    connection-timeout: 20000

# 缓存配置（测试环境 - 和 prod 一致）
spring:
  cache:
    type: caffeine
    caffeine:
      spec: maximumSize=1000,expireAfterAccess=3600s

# 异步任务配置（测试环境）
spring:
  task:
    execution:
      pool:
        core-size: 5
        max-size: 20
        queue-capacity: 100
        keep-alive: 60s
        thread-name-prefix: async-task-
    scheduling:
      pool:
        size: 5
        thread-name-prefix: scheduled-task-

# Seata 分布式事务配置（测试环境）
seata:
  enabled: false

# MongoDB 配置（测试环境 - Testcontainers）
spring:
  data:
    mongodb:
      uri: ${MONGODB_URI:mongodb://localhost:27017/junmo_platform_test}
      database: ${MONGODB_DATABASE:junmo_platform_test}
      auto-index-creation: true
      auto-time-logs: true

# Elasticsearch 配置（测试环境 - Testcontainers）
elasticsearch:
  host: ${ELASTICSEARCH_HOST:localhost}
  port: ${ELASTICSEARCH_PORT:9200}
  username: ${ELASTICSEARCH_USERNAME:}
  password: ${ELASTICSEARCH_PASSWORD:}
  protocol: ${ELASTICSEARCH_PROTOCOL:http}
  ssl:
    enabled: ${ELASTICSEARCH_SSL_ENABLED:false}
  connection-timeout: ${ELASTICSEARCH_CONNECTION_TIMEOUT:5000}
  socket-timeout: ${ELASTICSEARCH_SOCKET_TIMEOUT:30000}

# Quartz 任务调度配置（测试环境）
quartz:
  enabled: false

# Sa-Token配置（测试环境）
sa-token:
  token-name: satoken
  timeout: 2592000
  active-timeout: -1
  is-concurrent: true
  is-share: true
  token-style: uuid
  is-log: false
  is-read-cookie: false
  is-read-header: true
  token-prefix: Bearer
  alone-redis:
    database: 1
    host: localhost
    port: 6379
    password: ${SA_TOKEN_ALONE_REDIS_PASSWORD:}
    timeout: 10s

# Testcontainers 配置
testcontainers:
  reuse:
    enabled: true
  ryuk:
    container:
      privileged: true
  docker:
    client-strategy: org.testcontainers.dockerclient.EnvironmentAndSystemPropertyClientProviderStrategy

# Neo4j 图数据库配置（测试环境 - Testcontainers）
spring:
  data:
    neo4j:
      uri: ${NEO4J_URI:bolt://localhost:7687}
      authentication:
        username: ${NEO4J_USERNAME:neo4j}
        password: ${NEO4J_PASSWORD:password}
      database: ${NEO4J_DATABASE:neo4j_test}

# InfluxDB3 时序数据库配置（测试环境 - Testcontainers）
influxdb:
  url: ${INFLUXDB_URL:http://localhost:8181}
  token: ${INFLUXDB_TOKEN:}
  database: ${INFLUXDB_DATABASE:junmo_platform_test}
  connectTimeout: 10000
  writeTimeout: 10000
  readTimeout: 10000
  logLevel: INFO